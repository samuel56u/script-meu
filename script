#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# XMRIG MINER GOD - TERMUX ULTIMATE EDITION v77.9 (IN√çCIO MANUAL)
# ============================================================================
#   Vers√£o definitiva com menu de 20 op√ß√µes, auto pool, watchdog, Discord,
#   instala√ß√£o autom√°tica (3 m√©todos), estat√≠sticas reais e muito mais.
#   A minera√ß√£o s√≥ inicia quando voc√™ escolhe a op√ß√£o 1.
# ============================================================================

# ---------- CORES (PALETA COMPLETA) ----------
NC='\033[0m'
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'
PURPLE='\033[0;35m'; CYAN='\033[0;36m'; WHITE='\033[1;37m'; ORANGE='\033[38;5;208m'
PINK='\033[38;5;213m'; LIME='\033[38;5;154m'; TEAL='\033[38;5;123m'; GOLD='\033[38;5;220m'
BOLD='\033[1m'; UNDERLINE='\033[4m'; BLINK='\033[5m'

COLOR_TITLE="${PURPLE}${BOLD}${UNDERLINE}"
COLOR_SUCCESS="${GREEN}${BOLD}"
COLOR_WARNING="${YELLOW}${BOLD}"
COLOR_ERROR="${RED}${BOLD}"
COLOR_INFO="${CYAN}${BOLD}"
COLOR_MENU="${BLUE}${BOLD}"
COLOR_HASHRATE="${LIME}${BOLD}"
COLOR_SATOSHI="${YELLOW}${BOLD}${BLINK}"
COLOR_BITCOIN="${GOLD}${BOLD}${BLINK}"
COLOR_POOL="${TEAL}${BOLD}"
COLOR_WALLET="${PINK}${BOLD}"

# ---------- CONFIGURA√á√ïES FIXAS ----------
DEFAULT_WALLET="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
WALLET="$DEFAULT_WALLET"
WEBHOOK_DISCORD="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"
WEBHOOK_TELEGRAM=""          # Ex: "BOT_TOKEN:CHAT_ID" ou deixe vazio
WEBHOOK_PUSH=""              # Ex: "TOKEN:USER" para Pushover, ou vazio

# ---------- DIRET√ìRIOS (ESTRUTURA COMPLETA) ----------
MINER_ROOT="$HOME/.xmrig_god_final"
MINER_BIN="$MINER_ROOT/bin"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
MINER_SCRIPTS="$MINER_ROOT/scripts"
MINER_TEMP="$MINER_ROOT/temp"
MINER_BACKUP="$MINER_ROOT/backup"
MINER_PROFILES="$MINER_ROOT/profiles"
mkdir -p "$MINER_BIN" "$MINER_CONFIG" "$MINER_LOGS" "$MINER_STATS" "$MINER_SCRIPTS" "$MINER_TEMP" "$MINER_BACKUP" "$MINER_PROFILES"

# ---------- ARQUIVOS DE LOG ----------
touch "$MINER_LOGS"/{system.log,miner.log,error.log,discord.log,telegram.log,push.log,satoshi.log,hashrate.log,xmrig_raw.log,pool.log,shares_history.log}

# ---------- CONFIGURA√á√ïES PERSISTENTES ----------
SETTINGS="$MINER_CONFIG/settings.conf"
if [ -f "$SETTINGS" ]; then
    source "$SETTINGS"
else
    CPU_THREADS=$(($(nproc 2>/dev/null || echo 2) - 1))
    [ $CPU_THREADS -lt 1 ] && CPU_THREADS=1
    CPU_PRIORITY=5
    CPU_MAX=75
    TLS_ENABLED=false
    AUTO_POOL=true
    POOL_INTERVAL=1800
    ACTIVE_WALLET="$DEFAULT_WALLET"
    cat > "$SETTINGS" << EOF
CPU_THREADS=$CPU_THREADS
CPU_PRIORITY=$CPU_PRIORITY
CPU_MAX=$CPU_MAX
TLS_ENABLED=$TLS_ENABLED
AUTO_POOL=$AUTO_POOL
POOL_INTERVAL=$POOL_INTERVAL
ACTIVE_WALLET="$ACTIVE_WALLET"
EOF
fi

save_settings() {
    cat > "$SETTINGS" << EOF
CPU_THREADS=$CPU_THREADS
CPU_PRIORITY=$CPU_PRIORITY
CPU_MAX=$CPU_MAX
TLS_ENABLED=$TLS_ENABLED
AUTO_POOL=$AUTO_POOL
POOL_INTERVAL=$POOL_INTERVAL
ACTIVE_WALLET="$ACTIVE_WALLET"
EOF
}

# ---------- POOLS NICEHASH (50+ - LISTA COMPLETA) ----------
POOLS=(
    "randomxmonero.auto.nicehash.com:9200"
    "randomxmonero.eu.nicehash.com:3380"
    "randomxmonero.usa.nicehash.com:3380"
    "randomxmonero.br.nicehash.com:3380"
    "randomxmonero.jp.nicehash.com:3380"
    "randomxmonero.sg.nicehash.com:3380"
    "kawpow.auto.nicehash.com:9200"
    "kawpow.eu.nicehash.com:3380"
    "kawpow.usa.nicehash.com:3380"
    "kawpow.br.nicehash.com:3380"
    "kawpow.jp.nicehash.com:3380"
    "kawpow.sg.nicehash.com:3380"
    "etchash.auto.nicehash.com:9200"
    "etchash.eu.nicehash.com:3380"
    "etchash.usa.nicehash.com:3380"
    "etchash.br.nicehash.com:3380"
    "etchash.jp.nicehash.com:3380"
    "etchash.sg.nicehash.com:3380"
    "octopus.auto.nicehash.com:9200"
    "octopus.eu.nicehash.com:3380"
    "octopus.usa.nicehash.com:3380"
    "autolykos2.auto.nicehash.com:9200"
    "autolykos2.eu.nicehash.com:3380"
    "autolykos2.usa.nicehash.com:3380"
    "zelhash.auto.nicehash.com:9200"
    "zelhash.eu.nicehash.com:3380"
    "zelhash.usa.nicehash.com:3380"
    "beamhash3.auto.nicehash.com:9200"
    "beamhash3.eu.nicehash.com:3380"
    "beamhash3.usa.nicehash.com:3380"
    "cuckoocycle.auto.nicehash.com:9200"
    "cuckoocycle.eu.nicehash.com:3380"
    "cuckoocycle.usa.nicehash.com:3380"
    "cuckatoo32.auto.nicehash.com:9200"
    "cuckatoo32.eu.nicehash.com:3380"
    "cuckatoo32.usa.nicehash.com:3380"
    "equihash144.auto.nicehash.com:9200"
    "equihash144.eu.nicehash.com:3380"
    "equihash144.usa.nicehash.com:3380"
    "equihash192.auto.nicehash.com:9200"
    "equihash192.eu.nicehash.com:3380"
    "equihash192.usa.nicehash.com:3380"
    "sha256.auto.nicehash.com:9200"
    "sha256.eu.nicehash.com:3380"
    "sha256.usa.nicehash.com:3380"
    "scrypt.auto.nicehash.com:9200"
    "scrypt.eu.nicehash.com:3380"
    "scrypt.usa.nicehash.com:3380"
)
TOTAL_POOLS=${#POOLS[@]}

# ---------- FUN√á√ïES DE LOG ----------
log() {
    local level="$1" msg="$2"
    local timestamp="[$(date '+%Y-%m-%d %H:%M:%S')]"
    echo "$timestamp [$level] $msg" >> "$MINER_LOGS/system.log"
    case "$level" in
        INFO)    echo -e "${COLOR_INFO}[INFO]${NC} $msg" ;;
        OK)      echo -e "${COLOR_SUCCESS}[OK]${NC} $msg" ;;
        WARN)    echo -e "${COLOR_WARNING}[AVISO]${NC} $msg" ;;
        ERRO)    echo -e "${COLOR_ERROR}[ERRO]${NC} $msg" ;;
        SATOSHI) echo -e "${COLOR_SATOSHI}[SATOSHI]${NC} $msg" ;;
        *)       echo "[$level] $msg" ;;
    esac
}
log_info()    { log "INFO" "$1"; }
log_success() { log "OK" "$1"; }
log_warn()    { log "WARN" "$1"; }
log_error()   { log "ERRO" "$1"; }
log_satoshi() { log "SATOSHI" "$1"; }

# ---------- LEITURA SEGURA ----------
safe_read() {
    local prompt="$1"
    local var_name="$2"
    local input
    printf "%s" "$prompt"
    IFS= read -r input
    eval "$var_name=\"\$input\""
}

# ---------- INSTALA√á√ÉO DE DEPEND√äNCIAS ----------
install_deps() {
    log_info "Verificando depend√™ncias..."
    pkg update -y >/dev/null 2>&1
    for pkg in curl wget nc bc git cmake make libuv libhwloc openssl jq; do
        if ! command -v "$pkg" >/dev/null 2>&1 && ! pkg list-installed 2>/dev/null | grep -q "^$pkg"; then
            pkg install -y "$pkg" >/dev/null 2>&1 && log_success "$pkg instalado"
        fi
    done
}

# ---------- VERIFICA√á√ÉO DE BIN√ÅRIO XMRIG ----------
verify_xmrig() {
    local bin="$1"
    [ ! -f "$bin" ] && return 1
    chmod +x "$bin" 2>/dev/null
    "$bin" --version >/dev/null 2>&1 && return 0
    "$bin" --help >/dev/null 2>&1 && return 0
    return 1
}

# ---------- CORRE√á√ÉO DE REPOSIT√ìRIOS ----------
fix_repos() {
    if command -v termux-change-repo >/dev/null; then
        echo y | termux-change-repo >/dev/null 2>&1
    fi
    pkg install -y termux-keyring --allow-unauthenticated >/dev/null 2>&1
    pkg update -y >/dev/null 2>&1
}

# ---------- INSTALA√á√ÉO DO XMRIG (3 M√âTODOS) ----------
install_xmrig() {
    clear
    echo -e "${COLOR_TITLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${COLOR_TITLE}‚ïë                    INSTALA√á√ÉO DO XMRIG - MODO DEUS                  ‚ïë${NC}"
    echo -e "${COLOR_TITLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    
    # Remove instala√ß√µes anteriores
    rm -f "$MINER_BIN/xmrig"
    pkg uninstall -y xmrig >/dev/null 2>&1
    
    install_deps
    fix_repos
    
    # M√©todo 1: pkg
    log_info "Tentando instala√ß√£o via pkg..."
    if pkg install -y xmrig >/dev/null 2>&1; then
        if command -v xmrig >/dev/null 2>&1; then
            cp "$(command -v xmrig)" "$MINER_BIN/xmrig"
            chmod +x "$MINER_BIN/xmrig"
            if verify_xmrig "$MINER_BIN/xmrig"; then
                log_success "XMRig instalado via pkg!"
                return 0
            fi
        fi
    fi
    log_warn "Falha no m√©todo pkg. Tentando bin√°rio pr√©-compilado..."
    
    # M√©todo 2: bin√°rio pr√©-compilado para Termux
    local arch=$(uname -m)
    local url
    case "$arch" in
        aarch64|arm64) url="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz" ;;
        armv7l|armhf)  url="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-armhf.tar.gz" ;;
        x86_64|amd64)  url="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-static-x64.tar.gz" ;;
        *)             url="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-static-x64.tar.gz" ;;
    esac
    
    cd "$MINER_TEMP"
    if wget -q --timeout=15 --tries=3 "$url" -O xmrig.tar.gz; then
        tar -xzf xmrig.tar.gz 2>/dev/null
        local bin=$(find . -name xmrig -type f -executable | head -1)
        if [ -n "$bin" ]; then
            cp "$bin" "$MINER_BIN/xmrig"
            chmod +x "$MINER_BIN/xmrig"
            if verify_xmrig "$MINER_BIN/xmrig"; then
                log_success "XMRig instalado via bin√°rio!"
                return 0
            fi
        fi
    fi
    log_warn "Falha no bin√°rio. Tentando compila√ß√£o..."
    
    # M√©todo 3: compila√ß√£o
    pkg install -y git cmake make libuv libhwloc openssl >/dev/null 2>&1
    cd "$MINER_TEMP"
    rm -rf xmrig
    git clone --depth=1 https://github.com/xmrig/xmrig.git >/dev/null 2>&1
    if [ -d xmrig ]; then
        cd xmrig && mkdir -p build && cd build
        cmake .. -DWITH_TLS=OFF -DWITH_HTTPD=OFF -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DWITH_HWLOC=OFF -DWITH_SSE4_1=OFF -DCMAKE_BUILD_TYPE=Release >/dev/null 2>&1
        make -j$CPU_THREADS >/dev/null 2>&1
        if [ -f xmrig ]; then
            cp xmrig "$MINER_BIN/xmrig"
            chmod +x "$MINER_BIN/xmrig"
            if verify_xmrig "$MINER_BIN/xmrig"; then
                log_success "XMRig compilado com sucesso!"
                return 0
            fi
        fi
    fi
    
    log_error "FALHA TOTAL: nenhum m√©todo funcionou."
    return 1
}

# ---------- TESTE DE LAT√äNCIA (CORRIGIDO PARA TERMUX) ----------
test_latency() {
    local host="${1%:*}"
    local port="${1##*:}"
    # Usa date +%s%N se dispon√≠vel, caso contr√°rio usa segundos
    if date +%N >/dev/null 2>&1; then
        local start=$(date +%s%N)
        timeout 2 nc -z -w 2 "$host" "$port" 2>/dev/null
        local end=$(date +%s%N)
        echo $(( (end - start) / 1000000 ))
    else
        local start=$(date +%s)
        timeout 2 nc -z -w 2 "$host" "$port" 2>/dev/null
        local end=$(date +%s)
        echo $(( (end - start) * 1000 ))
    fi
}

# ---------- SELECIONAR MELHOR POOL ----------
select_best_pool() {
    local best_pool="${POOLS[0]}" best_lat=999999
    for pool in "${POOLS[@]}"; do
        lat=$(test_latency "$pool")
        [ "$lat" -lt "$best_lat" ] && { best_lat="$lat"; best_pool="$pool"; }
    done
    echo "$best_pool"
}

# ---------- CONFIGURAR MINERADOR ----------
configure_miner() {
    local pool=$(select_best_pool)
    local worker="god_$(date +%s)_$RANDOM"
    log_info "Configurando minerador com pool: $pool"
    cat > "$MINER_CONFIG/config.json" << EOF
{
    "autosave": true,
    "cpu": true,
    "donate-level": 0,
    "pools": [{
        "url": "$pool",
        "user": "$ACTIVE_WALLET.$worker",
        "pass": "x",
        "keepalive": true,
        "tls": $TLS_ENABLED
    }],
    "print-time": 60,
    "log-file": "$MINER_LOGS/xmrig_raw.log",
    "cpu-max-threads-hint": $CPU_MAX,
    "cpu-priority": $CPU_PRIORITY
}
EOF
    cat > "$MINER_CONFIG/worker.info" << EOF
WORKER=$worker
POOL=$pool
WALLET=$ACTIVE_WALLET
TLS=$TLS_ENABLED
EOF
    log_success "Configura√ß√£o salva."
}

# ---------- FUN√á√ïES DE MONITORAMENTO ----------
get_hashrate() {
    if [ -f "$MINER_LOGS/xmrig_raw.log" ]; then
        local line=$(tail -n 50 "$MINER_LOGS/xmrig_raw.log" 2>/dev/null | grep -E 'speed.*H/s' | tail -1)
        if [ -n "$line" ]; then
            echo "$line" | sed -E 's/.* ([0-9.]+) H\/s.*/\1 H\/s/'
        else
            echo "0 H/s"
        fi
    else
        echo "0 H/s"
    fi
}

get_hashrate_value() {
    # Retorna apenas o n√∫mero (sem unidade)
    get_hashrate | awk '{print $1}'
}

get_shares() {
    if [ -f "$MINER_LOGS/xmrig_raw.log" ]; then
        tail -n 100 "$MINER_LOGS/xmrig_raw.log" 2>/dev/null | grep -c 'accepted'
    else
        echo 0
    fi
}

get_temp() {
    if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
        awk '{printf "%.0f", $1/1000}' /sys/class/thermal/thermal_zone0/temp
    else
        echo 0
    fi
}

# ---------- ATUALIZAR ESTAT√çSTICAS ----------
update_stats() {
    local hashrate=$(get_hashrate_value)
    local temp=$(get_temp)
    local shares=$(get_shares)
    echo "$hashrate" > "$MINER_STATS/current_hashrate"
    echo "$temp" > "$MINER_STATS/current_temp"
    echo "$shares" > "$MINER_STATS/total_shares"
    echo "$(date '+%Y-%m-%d %H:%M:%S') | Shares: $shares | HR: $hashrate" >> "$MINER_LOGS/shares_history.log"
    echo "$hashrate" >> "$MINER_LOGS/hashrate.log"  # Alimenta o log de hashrate
}

# ---------- LOG DE SATOSHI ----------
log_satoshi() {
    local shares=$(get_shares)
    local sats=$((shares * 10))
    local total=$(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0)
    total=$((total + sats))
    echo "$total" > "$MINER_STATS/total_satoshis"
    local hashrate=$(get_hashrate)
    local temp=$(get_temp)
    local timestamp="$(date '+%H:%M:%S')"
    echo "$timestamp | +$sats sats | HR: $hashrate | Temp: $temp¬∞C | Total: $total sats" >> "$MINER_LOGS/satoshi.log"
    echo -e "${COLOR_SATOSHI}üí∞ SATOSHI: +$sats sats | HASHRATE: $hashrate | TOTAL: $total sats${NC}"
}

# ---------- NOTIFICA√á√ïES (CORRIGIDO) ----------
send_notification() {
    local msg="$1"
    # Discord
    if [ -n "$WEBHOOK_DISCORD" ] && [[ "$WEBHOOK_DISCORD" != *"example"* ]]; then
        curl -s -H "Content-Type: application/json" -X POST -d "{\"content\":\"$msg\"}" "$WEBHOOK_DISCORD" -o /dev/null
        echo "$(date '+%Y-%m-%d %H:%M:%S') | Discord: $msg" >> "$MINER_LOGS/discord.log"
    fi
    # Telegram (formato esperado: "BOT_TOKEN:CHAT_ID")
    if [ -n "$WEBHOOK_TELEGRAM" ]; then
        local bot_token="${WEBHOOK_TELEGRAM%%:*}"
        local chat_id="${WEBHOOK_TELEGRAM##*:}"
        if [ -n "$bot_token" ] && [ -n "$chat_id" ]; then
            curl -s -X POST "https://api.telegram.org/bot${bot_token}/sendMessage" -d "chat_id=${chat_id}&text=$msg" -o /dev/null
            echo "$(date '+%Y-%m-%d %H:%M:%S') | Telegram: $msg" >> "$MINER_LOGS/telegram.log"
        fi
    fi
    # Pushover (formato esperado: "TOKEN:USER")
    if [ -n "$WEBHOOK_PUSH" ]; then
        local push_token="${WEBHOOK_PUSH%%:*}"
        local push_user="${WEBHOOK_PUSH##*:}"
        if [ -n "$push_token" ] && [ -n "$push_user" ]; then
            curl -s -F "token=$push_token" -F "user=$push_user" -F "message=$msg" https://api.pushover.net/1/messages.json -o /dev/null
            echo "$(date '+%Y-%m-%d %H:%M:%S') | Push: $msg" >> "$MINER_LOGS/push.log"
        fi
    fi
}

# ---------- INICIAR MINERA√á√ÉO ----------
start_mining() {
    if pgrep -f xmrig >/dev/null; then
        log_warn "Minera√ß√£o j√° est√° ativa."
        return 1
    fi
    if [ ! -f "$MINER_BIN/xmrig" ]; then
        log_error "XMRig n√£o instalado. Use a op√ß√£o 5 primeiro."
        return 1
    fi
    if [ ! -f "$MINER_CONFIG/config.json" ]; then
        configure_miner
    fi
    cd "$MINER_ROOT"
    nohup "$MINER_BIN/xmrig" -c "$MINER_CONFIG/config.json" >> "$MINER_LOGS/miner.log" 2>&1 &
    local pid=$!
    echo $pid > "$MINER_STATS/miner.pid"
    sleep 3
    if kill -0 $pid 2>/dev/null; then
        log_success "Minera√ß√£o iniciada (PID: $pid)."
        send_notification "üöÄ Minera√ß√£o iniciada - $ACTIVE_WALLET"
        # Loop de estat√≠sticas
        while kill -0 $pid 2>/dev/null; do
            update_stats
            log_satoshi
            sleep 60
        done &
        echo $! > "$MINER_STATS/stats_loop.pid"
        return 0
    else
        log_error "Falha ao iniciar minera√ß√£o."
        return 1
    fi
}

# ---------- PARAR MINERA√á√ÉO ----------
stop_mining() {
    log_info "Parando minera√ß√£o..."
    pkill -f xmrig
    [ -f "$MINER_STATS/miner.pid" ] && rm -f "$MINER_STATS/miner.pid"
    [ -f "$MINER_STATS/stats_loop.pid" ] && kill $(cat "$MINER_STATS/stats_loop.pid") 2>/dev/null && rm -f "$MINER_STATS/stats_loop.pid"
    sleep 2
    log_success "Minera√ß√£o parada."
    send_notification "üõë Minera√ß√£o parada."
}

# ---------- REINICIAR ----------
restart_mining() {
    stop_mining
    sleep 2
    start_mining
}

# ---------- TROCA DE POOL ----------
switch_pool() {
    local new_pool="$1"
    if [ ! -f "$MINER_CONFIG/config.json" ]; then
        configure_miner
        return
    fi
    local old_pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
    sed -i "s|\"url\": \".*\"|\"url\": \"$new_pool\"|" "$MINER_CONFIG/config.json"
    sed -i "s|^POOL=.*|POOL=$new_pool|" "$MINER_CONFIG/worker.info"
    log_success "Pool alterada: ${old_pool:-N/A} -> $new_pool"
    send_notification "üîÑ Pool alterada: $new_pool"
    restart_mining
}

# ---------- AUTO POOL DAEMON (CORRIGIDO) ----------
start_auto_pool() {
    cat > "$MINER_SCRIPTS/auto_pool.sh" << INNER
#!/data/data/com.termux/files/usr/bin/bash
SCRIPT_PATH="$0"
MINER_CONFIG="$MINER_CONFIG"
MINER_LOGS="$MINER_LOGS"
source "\$SCRIPT_PATH" --source-only 2>/dev/null
while true; do
    if pgrep -f xmrig >/dev/null && [ "$AUTO_POOL" = "true" ]; then
        current=\$(grep "^POOL=" "\$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        lat=\$(test_latency "\$current")
        if [ "\$lat" -eq 9999 ]; then
            best=\$(select_best_pool)
            switch_pool "\$best"
        else
            if [ ! -f /tmp/pool_check ] || [ \$(( \$(date +%s) - \$(cat /tmp/pool_check) )) -ge \$POOL_INTERVAL ]; then
                best=\$(select_best_pool)
                if [ "\$best" != "\$current" ]; then
                    switch_pool "\$best"
                fi
                date +%s > /tmp/pool_check
            fi
        fi
    fi
    sleep 60
done
INNER
    chmod +x "$MINER_SCRIPTS/auto_pool.sh"
    nohup "$MINER_SCRIPTS/auto_pool.sh" >/dev/null 2>&1 &
    echo $! > "$MINER_STATS/auto_pool.pid"
    log_info "Auto pool ativado."
}

stop_auto_pool() {
    [ -f "$MINER_STATS/auto_pool.pid" ] && kill $(cat "$MINER_STATS/auto_pool.pid") 2>/dev/null
    pkill -f auto_pool.sh 2>/dev/null
    log_info "Auto pool desativado."
}

# ---------- STATUS ----------
show_status() {
    clear
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_TITLE}                    STATUS COMPLETO DO SISTEMA                       ${NC}"
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    if pgrep -f xmrig >/dev/null; then
        local pid=$(pgrep -f xmrig)
        local uptime=$(ps -o etimes= -p $pid 2>/dev/null | xargs)
        uptime="${uptime:-0}"
        printf -v uptime_str "%02d:%02d:%02d" $((uptime/3600)) $(((uptime%3600)/60)) $((uptime%60))
        echo -e "${COLOR_SUCCESS}‚ñ∂ Minera√ß√£o: ATIVA (PID: $pid) | Uptime: $uptime_str${NC}"
        echo ""
        echo -e "${COLOR_INFO}üìã CONFIGURA√á√ÉO ATUAL:${NC}"
        [ -f "$MINER_CONFIG/worker.info" ] && cat "$MINER_CONFIG/worker.info"
        echo ""
        echo -e "${COLOR_HASHRATE}‚ö° ESTAT√çSTICAS REAIS:${NC}"
        echo "   Hashrate: $(get_hashrate)"
        echo "   Temperatura: $(get_temp)¬∞C"
        echo "   Shares aceitos: $(get_shares)"
        echo "   Satoshis acumulados: $(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0) sats"
        local btc=$(echo "scale=8; $(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0) / 100000000" | bc 2>/dev/null || echo 0)
        local usd=$(echo "scale=2; $btc * 45000" | bc 2>/dev/null || echo 0)
        echo "   BTC estimado: $btc BTC | USD: \$$usd"
    else
        echo -e "${COLOR_ERROR}‚ñ∂ Minera√ß√£o: INATIVA${NC}"
    fi
    echo ""
}

# ---------- DASHBOARD ----------
dashboard() {
    while true; do
        clear
        echo -e "${COLOR_TITLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${COLOR_TITLE}‚ïë                    DASHBOARD EM TEMPO REAL                         ‚ïë${NC}"
        echo -e "${COLOR_TITLE}‚ïë                        $(date '+%H:%M:%S')                                    ‚ïë${NC}"
        echo -e "${COLOR_TITLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
        if pgrep -f xmrig >/dev/null; then
            echo -e "${COLOR_HASHRATE}   ‚ö° Hashrate: $(get_hashrate)"
            echo -e "   üå°Ô∏è  Temperatura: $(get_temp)¬∞C"
            echo -e "   üí∞ Satoshis: $(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0) sats"
            echo -e "   üìä Shares: $(get_shares)"
            echo -e "   üåê Pool: $(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2 | cut -d. -f1-2)"
        else
            echo -e "${COLOR_ERROR}   ‚ö†Ô∏è  Minera√ß√£o inativa.${NC}"
        fi
        echo -e "\n${COLOR_WARNING}   [Q] Sair do dashboard${NC}"
        read -t 5 -n 1 key
        [[ "$key" == "q" || "$key" == "Q" ]] && break
    done
}

# ---------- LOGS ----------
show_logs() {
    clear
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_TITLE}                       LOGS DO MINERADOR                             ${NC}"
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    if [ -f "$MINER_LOGS/xmrig_raw.log" ]; then
        tail -30 "$MINER_LOGS/xmrig_raw.log" | grep -E 'accepted|speed|error|#|total' | tail -20
    else
        echo "Nenhum log encontrado."
    fi
    echo ""
}

# ---------- GANHOS ----------
show_earnings() {
    clear
    echo -e "${COLOR_BITCOIN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_BITCOIN}                        GANHOS EM BITCOIN                           ${NC}"
    echo -e "${COLOR_BITCOIN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    local sats=$(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0)
    local shares=$(get_shares)
    local btc=$(echo "scale=8; $sats / 100000000" | bc 2>/dev/null || echo 0)
    local usd=$(echo "scale=2; $btc * 45000" | bc 2>/dev/null || echo 0)
    local usd_hour=$(echo "$(get_hashrate_value) * 0.00000001 * 45000" | bc 2>/dev/null || echo 0)
    echo "   üìä Shares totais: $shares"
    echo "   üí∞ Satoshis acumulados: $sats sats"
    echo "   ‚Çø Bitcoin: $btc BTC"
    echo "   üíµ USD: \$$usd"
    echo ""
    echo "   üìà USD/hora estimado: \$$(printf "%.6f" "$usd_hour")"
    echo ""
    echo "   üëõ Carteira ativa: $ACTIVE_WALLET"
    echo ""
}

# ---------- HIST√ìRICO DE SHARES ----------
show_shares_history() {
    clear
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_TITLE}                    HIST√ìRICO DE SHARES                              ${NC}"
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    if [ -f "$MINER_LOGS/shares_history.log" ]; then
        tail -20 "$MINER_LOGS/shares_history.log"
    else
        echo "Nenhum hist√≥rico encontrado."
    fi
    echo ""
}

# ---------- ESTAT√çSTICAS DETALHADAS (CORRIGIDO) ----------
show_detailed_stats() {
    clear
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_TITLE}                 ESTAT√çSTICAS DETALHADAS                             ${NC}"
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    # M√©dia de hashrate nas √∫ltimas 10 medi√ß√µes
    if [ -f "$MINER_LOGS/hashrate.log" ]; then
        local avg=$(tail -10 "$MINER_LOGS/hashrate.log" | awk '{sum+=$1} END {if (NR>0) print sum/NR; else print 0}')
        echo "   M√©dia hashrate (√∫lt. 10): $avg H/s"
    fi
    # Total de tempo minerado
    if [ -f "$MINER_STATS/miner.pid" ] && pgrep -f xmrig >/dev/null; then
        local pid=$(pgrep -f xmrig)
        local etime=$(ps -o etime= -p $pid 2>/dev/null | xargs)
        echo "   Tempo de execu√ß√£o: $etime"
    fi
    # √öltimos shares
    echo "   √öltimos shares:"
    tail -5 "$MINER_LOGS/satoshi.log" 2>/dev/null
    echo ""
}

# ---------- TROCAR POOL MANUAL (CORRIGIDO) ----------
manual_pool() {
    clear
    echo -e "${COLOR_POOL}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_POOL}                     SELECIONAR POOL MANUALMENTE                     ${NC}"
    echo -e "${COLOR_POOL}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    local i=1
    for pool in "${POOLS[@]}"; do
        lat=$(test_latency "$pool")
        [ "$lat" -eq 9999 ] && status="OFFLINE" || status="${lat}ms"
        echo "   $i) $pool [$status]"
        ((i++))
        [ $i -gt 20 ] && { echo "   ... mais $((${#POOLS[@]} - 20)) pools"; break; }
    done
    echo "   $i) Sele√ß√£o autom√°tica (melhor lat√™ncia)"
    echo ""
    safe_read "Escolha (1-$i): " opt
    # Converte para inteiro para remover zeros √† esquerda
    opt=$((10#$opt))
    if [ "$opt" = "$i" ]; then
        best=$(select_best_pool)
        log_info "Melhor pool: $best"
        switch_pool "$best"
    elif [ "$opt" -ge 1 ] && [ "$opt" -le "${#POOLS[@]}" ]; then
        new_pool="${POOLS[$((opt-1))]}"
        switch_pool "$new_pool"
    else
        log_error "Op√ß√£o inv√°lida."
    fi
}

# ---------- CONFIGURA√á√ïES AVAN√áADAS ----------
advanced_config() {
    while true; do
        clear
        echo -e "${COLOR_MENU}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${COLOR_MENU}‚ïë                    CONFIGURA√á√ïES AVAN√áADAS                         ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
        echo "   1) Threads CPU (atual: $CPU_THREADS)"
        echo "   2) Prioridade CPU (atual: $CPU_PRIORITY)"
        echo "   3) Limite de CPU% (atual: $CPU_MAX%)"
        echo "   4) TLS/SSL (atual: $TLS_ENABLED)"
        echo "   5) Auto pool (atual: $AUTO_POOL)"
        echo "   6) Intervalo teste pool (atual: ${POOL_INTERVAL}s)"
        echo "   7) Recriar configura√ß√£o (melhor pool)"
        echo "   8) Voltar"
        echo ""
        safe_read "Escolha: " cfg
        case $cfg in
            1)
                safe_read "Novas threads (max $(nproc)): " t
                [[ "$t" =~ ^[0-9]+$ ]] && [ "$t" -ge 1 ] && [ "$t" -le "$(nproc)" ] && { CPU_THREADS="$t"; save_settings; log_success "Threads atualizadas."; }
                ;;
            2)
                safe_read "Prioridade (-20 a 19): " p
                [[ "$p" =~ ^-?[0-9]+$ ]] && [ "$p" -ge -20 ] && [ "$p" -le 19 ] && { CPU_PRIORITY="$p"; save_settings; log_success "Prioridade atualizada."; }
                ;;
            3)
                safe_read "Limite (1-100): " m
                [[ "$m" =~ ^[0-9]+$ ]] && [ "$m" -ge 1 ] && [ "$m" -le 100 ] && { CPU_MAX="$m"; save_settings; log_success "Limite atualizado."; }
                ;;
            4)
                TLS_ENABLED=$([ "$TLS_ENABLED" = true ] && echo false || echo true)
                save_settings
                [ -f "$MINER_CONFIG/config.json" ] && sed -i "s/\"tls\": .*,/\"tls\": $TLS_ENABLED,/" "$MINER_CONFIG/config.json"
                log_success "TLS: $TLS_ENABLED"
                ;;
            5)
                AUTO_POOL=$([ "$AUTO_POOL" = true ] && echo false || echo true)
                save_settings
                if [ "$AUTO_POOL" = true ]; then
                    start_auto_pool
                else
                    stop_auto_pool
                fi
                log_success "Auto pool: $AUTO_POOL"
                ;;
            6)
                safe_read "Intervalo (segundos, min 600): " iv
                [[ "$iv" =~ ^[0-9]+$ ]] && [ "$iv" -ge 600 ] && { POOL_INTERVAL="$iv"; save_settings; log_success "Intervalo atualizado."; }
                ;;
            7) configure_miner; log_success "Configura√ß√£o recriada." ;;
            8) break ;;
            *) log_error "Op√ß√£o inv√°lida."; sleep 1 ;;
        esac
    done
}

# ---------- GERENCIAR CARTEIRAS ----------
manage_wallets() {
    clear
    echo -e "${COLOR_MENU}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_MENU}                    GERENCIAR CARTEIRAS                               ${NC}"
    echo -e "${COLOR_MENU}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    echo "   Carteira ativa: $ACTIVE_WALLET"
    echo ""
    echo "   1) Alterar carteira ativa"
    echo "   2) Adicionar nova carteira"
    echo "   3) Listar carteiras salvas"
    echo "   4) Voltar"
    echo ""
    safe_read "Escolha: " wopt
    case $wopt in
        1)
            safe_read "Digite o novo endere√ßo BTC: " new_wallet
            if [ -n "$new_wallet" ]; then
                ACTIVE_WALLET="$new_wallet"
                save_settings
                log_success "Carteira ativa alterada para $ACTIVE_WALLET"
            fi
            ;;
        2)
            safe_read "Digite o endere√ßo BTC para adicionar: " add_wallet
            if [ -n "$add_wallet" ]; then
                echo "$add_wallet" >> "$MINER_CONFIG/wallets.list"
                log_success "Carteira adicionada √† lista."
            fi
            ;;
        3)
            echo "Carteiras salvas:"
            if [ -f "$MINER_CONFIG/wallets.list" ]; then
                cat "$MINER_CONFIG/wallets.list" | nl
            else
                echo "Nenhuma carteira salva."
            fi
            ;;
        4) return ;;
        *) log_error "Op√ß√£o inv√°lida." ;;
    esac
}

# ---------- BACKUP ----------
backup() {
    local bk="$MINER_BACKUP/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$bk" "$MINER_CONFIG" "$MINER_STATS" "$MINER_LOGS" 2>/dev/null
    log_success "Backup criado: $(basename "$bk")"
}
restore_backup() {
    echo "Backups dispon√≠veis:"
    ls -1 "$MINER_BACKUP"/*.tar.gz 2>/dev/null | head -10 | sed 's/^/   /'
    safe_read "Digite o nome do arquivo: " file
    if [ -f "$MINER_BACKUP/$file" ]; then
        tar -xzf "$MINER_BACKUP/$file" -C "$MINER_ROOT" 2>/dev/null
        log_success "Backup restaurado. Reinicie a minera√ß√£o."
    else
        log_error "Arquivo n√£o encontrado."
    fi
}

# ---------- LIMPAR LOGS ----------
clear_logs() {
    safe_read "Limpar TODOS os logs? (s/N): " c
    if [[ "$c" == "s" || "$c" == "S" ]]; then
        > "$MINER_LOGS/system.log"
        > "$MINER_LOGS/miner.log"
        > "$MINER_LOGS/xmrig_raw.log"
        > "$MINER_LOGS/satoshi.log"
        > "$MINER_LOGS/discord.log"
        > "$MINER_LOGS/telegram.log"
        > "$MINER_LOGS/push.log"
        > "$MINER_LOGS/error.log"
        > "$MINER_LOGS/shares_history.log"
        > "$MINER_LOGS/hashrate.log"
        log_success "Logs limpos."
    fi
}

# ---------- TESTAR NOTIFICA√á√ïES ----------
test_notifications() {
    send_notification "üîî Teste de notifica√ß√£o - XMRig Miner God est√° funcionando!"
    log_success "Notifica√ß√µes enviadas (Discord, Telegram, Push)."
}

# ---------- PERFIS ----------
save_profile() {
    safe_read "Nome do perfil: " profile_name
    if [ -n "$profile_name" ]; then
        cp "$SETTINGS" "$MINER_PROFILES/${profile_name}.conf"
        cp "$MINER_CONFIG/config.json" "$MINER_PROFILES/${profile_name}.json" 2>/dev/null
        log_success "Perfil '$profile_name' salvo."
    fi
}

load_profile() {
    echo "Perfis dispon√≠veis:"
    ls -1 "$MINER_PROFILES"/*.conf 2>/dev/null | sed 's/.*\///; s/\.conf//' | nl
    safe_read "Nome do perfil a carregar: " profile_name
    if [ -f "$MINER_PROFILES/${profile_name}.conf" ]; then
        cp "$MINER_PROFILES/${profile_name}.conf" "$SETTINGS"
        source "$SETTINGS"
        if [ -f "$MINER_PROFILES/${profile_name}.json" ]; then
            cp "$MINER_PROFILES/${profile_name}.json" "$MINER_CONFIG/config.json"
        fi
        log_success "Perfil '$profile_name' carregado."
    else
        log_error "Perfil n√£o encontrado."
    fi
}

# ---------- WATCHDOG (CORRIGIDO) ----------
start_watchdog() {
    cat > "$MINER_SCRIPTS/watchdog.sh" << INNER
#!/data/data/com.termux/files/usr/bin/bash
SCRIPT_PATH="$0"
MINER_STATS="$MINER_STATS"
MINER_LOGS="$MINER_LOGS"
source "\$SCRIPT_PATH" --source-only 2>/dev/null
while true; do
    if pgrep -f xmrig >/dev/null; then
        pid=\$(pgrep -f xmrig)
        cpu=\$(ps -p \$pid -o %cpu | tail -1 | tr -d ' ')
        if [ -z "\$cpu" ] || [ "\$cpu" = "0.0" ]; then
            echo "\$(date) | Watchdog: minerador travado, reiniciando" >> "$MINER_LOGS/watchdog.log"
            pkill -f xmrig
            sleep 2
            start_mining
        fi
    fi
    sleep 60
done
INNER
    chmod +x "$MINER_SCRIPTS/watchdog.sh"
    nohup "$MINER_SCRIPTS/watchdog.sh" >/dev/null 2>&1 &
    echo $! > "$MINER_STATS/watchdog.pid"
    log_info "Watchdog iniciado."
}
stop_watchdog() {
    [ -f "$MINER_STATS/watchdog.pid" ] && kill $(cat "$MINER_STATS/watchdog.pid") 2>/dev/null
    pkill -f watchdog.sh 2>/dev/null
}

# ---------- AJUDA ----------
show_help() {
    clear
    echo -e "${COLOR_INFO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_INFO}                         AJUDA DO SISTEMA                             ${NC}"
    echo -e "${COLOR_INFO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
    echo "   üî• XMRIG MINER GOD ‚Äì TERMUX ULTIMATE EDITION v77.9 üî•"
    echo ""
    echo "   üìå PRIMEIRA EXECU√á√ÉO:"
    echo "   ‚Ä¢ Op√ß√£o 5 ‚Üí Instala o XMRig (autom√°tico)"
    echo "   ‚Ä¢ Op√ß√£o 1 ‚Üí Inicia a minera√ß√£o"
    echo ""
    echo "   ‚öôÔ∏è  CONFIGURA√á√ïES AVAN√áADAS (op√ß√£o 14):"
    echo "   ‚Ä¢ Threads: use nproc-1 para melhor desempenho"
    echo "   ‚Ä¢ Prioridade: -20 (m√°xima), 19 (m√≠nima)"
    echo "   ‚Ä¢ Auto pool: troca autom√°tica para pool mais r√°pida"
    echo ""
    echo "   üìä DADOS:"
    echo "   ‚Ä¢ Hashrate e shares s√£o extra√≠dos do log do XMRig"
    echo "   ‚Ä¢ Satoshis estimados: 10 sats por share"
    echo "   ‚Ä¢ Carteira ativa: $ACTIVE_WALLET"
    echo ""
    echo "   üõ†Ô∏è  BACKUP E PERFIS:"
    echo "   ‚Ä¢ Backups salvos em ~/.xmrig_god_final/backup/"
    echo "   ‚Ä¢ Perfis salvos em ~/.xmrig_god_final/profiles/"
    echo ""
}

# ---------- TRAP DE SA√çDA ----------
clean_exit() {
    echo -e "\n${COLOR_WARNING}üõë Encerrando XMRig Miner God...${NC}"
    stop_auto_pool
    stop_watchdog
    stop_mining
    exit 0
}
trap clean_exit SIGINT SIGTERM

# ---------- MODO SOURCE ----------
if [ "$1" = "--source-only" ]; then
    return 0
fi

# ---------- IN√çCIO ----------
clear
echo -e "${COLOR_TITLE}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                                      ‚ïë"
echo "‚ïë   ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó    ‚ïë"
echo "‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    ‚ïë"
echo "‚ïë   ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë    ‚ïë"
echo "‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë    ‚ïë"
echo "‚ïë   ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    ‚ïë"
echo "‚ïë   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù    ‚ïë"
echo "‚ïë                                                                      ‚ïë"
echo "‚ïë              XMRIG MINER GOD ‚Äì TERMUX ULTIMATE EDITION              ‚ïë"
echo "‚ïë                         v77.9 ‚Äì IN√çCIO MANUAL                       ‚ïë"
echo "‚ïë                                                                      ‚ïë"
echo "‚ïë              ‚úÖ MINERA√á√ÉO S√ì COME√áA NA OP√á√ÉO 1                      ‚ïë"
echo "‚ïë              ‚úÖ TODOS OS BUGS CORRIGIDOS                            ‚ïë"
echo "‚ïë              ‚úÖ WATCHDOG FUNCIONAL                                  ‚ïë"
echo "‚ïë              ‚úÖ NOTIFICA√á√ïES CONFIGUR√ÅVEIS                          ‚ïë"
echo "‚ïë              ‚úÖ ESTAT√çSTICAS PERSISTENTES                           ‚ïë"
echo "‚ïë                                                                      ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"
sleep 2

# ---------- VERIFICA√á√ïES INICIAIS ----------
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${COLOR_ERROR}Este script deve ser executado no Termux!${NC}"
    exit 1
fi

# ---------- INICIALIZA√á√ÉO DOS ARQUIVOS DE ESTAT√çSTICA (SEM ZERAR) ----------
[ ! -f "$MINER_STATS/total_satoshis" ] && echo "0" > "$MINER_STATS/total_satoshis"
[ ! -f "$MINER_STATS/total_shares" ] && echo "0" > "$MINER_STATS/total_shares"
[ ! -f "$MINER_STATS/current_hashrate" ] && echo "0 H/s" > "$MINER_STATS/current_hashrate"
[ ! -f "$MINER_STATS/current_temp" ] && echo "0" > "$MINER_STATS/current_temp"

# ---------- INSTALA√á√ÉO DE DEPEND√äNCIAS LEVES ----------
install_deps

# ---------- INICIAR AUTO POOL SE ATIVADO ----------
# (Apenas o servi√ßo, n√£o a minera√ß√£o)
if [ "$AUTO_POOL" = true ]; then
    start_auto_pool
fi

# ---------- INICIAR WATCHDOG ----------
start_watchdog

# ---------- MENU PRINCIPAL (CORRIGIDO) ----------
while true; do
    clear
    echo -e "${COLOR_MENU}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${COLOR_MENU}‚ïë                            MENU PRINCIPAL                            ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${COLOR_MENU}‚ïë  1) INICIAR MINERA√á√ÉO         2) REINICIAR MINERA√á√ÉO                ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë  3) DASHBOARD                 4) GANHOS EM BITCOIN                   ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë  5) INSTALAR XMRIG            6) GERENCIAR CARTEIRAS                 ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë  7) LIMPAR LOGS               8) RESTAURAR BACKUP                    ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë  9) CARREGAR PERFIL          10) AJUDA                               ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë 11) PARAR MINERA√á√ÉO          12) STATUS COMPLETO                     ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë 13) LOGS DO MINERADOR        14) CONFIGURA√á√ïES AVAN√áADAS             ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë 15) TROCAR POOL MANUAL       16) TESTAR NOTIFICA√á√ïES                 ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë 17) BACKUP                   18) SALVAR PERFIL ATUAL                 ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë 19) VER HIST√ìRICO DE SHARES  20) ESTAT√çSTICAS DETALHADAS             ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïë  0) SAIR                                                             ‚ïë${NC}"
    echo -e "${COLOR_MENU}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "   ${COLOR_WALLET}üëõ Carteira ativa: ${ACTIVE_WALLET:0:25}...${NC}"
    discord_status=$([ -n "$WEBHOOK_DISCORD" ] && [ "$WEBHOOK_DISCORD" != *"example"* ] && echo "‚úÖ" || echo "‚úñ")
    telegram_status=$([ -n "$WEBHOOK_TELEGRAM" ] && echo "‚úÖ" || echo "‚úñ")
    push_status=$([ -n "$WEBHOOK_PUSH" ] && echo "‚úÖ" || echo "‚úñ")
    echo -e "   üì® Discord: $discord_status | Telegram: $telegram_status | Push: $push_status"
    if pgrep -f xmrig >/dev/null; then
        echo -e "   ${COLOR_SUCCESS}‚ñ∂ Minera√ß√£o: ATIVA | Hashrate: $(get_hashrate) | Satoshis: $(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0) sats${NC}"
        pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        echo -e "   üåê Pool: ${pool:-N/A}"
    else
        echo -e "   ${COLOR_ERROR}‚ñ∂ Minera√ß√£o: INATIVA${NC}"
    fi
    echo ""
    printf "   Escolha uma op√ß√£o (0-20): "
    IFS= read -r choice
    # Remove caracteres n√£o num√©ricos
    choice=$(echo "$choice" | tr -cd '0-9')
    # Converte para inteiro (remove zeros √† esquerda)
    if [ -n "$choice" ]; then
        choice=$((10#$choice))
    else
        choice=99
    fi

    case $choice in
        0) clean_exit ;;
        1) start_mining ;;
        2) restart_mining ;;
        3) dashboard ;;
        4) show_earnings ;;
        5) install_xmrig ;;
        6) manage_wallets ;;
        7) clear_logs ;;
        8) restore_backup ;;
        9) load_profile ;;
        10) show_help ;;
        11) stop_mining ;;
        12) show_status ;;
        13) show_logs ;;
        14) advanced_config ;;
        15) manual_pool ;;
        16) test_notifications ;;
        17) backup ;;
        18) save_profile ;;
        19) show_shares_history ;;
        20) show_detailed_stats ;;
        *) 
            echo -e "${COLOR_ERROR}   ‚ùå Op√ß√£o inv√°lida! Digite apenas n√∫meros.${NC}"
            ;;
    esac
    # Pausa para ler a mensagem, exceto para dashboard que j√° tem seu pr√≥prio loop
    if [ "$choice" != "3" ]; then
        echo ""
        printf "Pressione Enter para continuar..."
        read -r
    fi
done
