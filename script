#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# XMRIG MINER GOD - TERMUX ULTIMATE EDITION v99.9 - MODO AUTOMÃTICO
# ============================================================================
#   â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
#   â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•    â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
#    â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
#    â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
#   â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
#   â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â• â•šâ•â•â•â•â•â•     â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• 
# ============================================================================
#   ðŸ”¥ MODO AUTOMÃTICO â€“ INSTALA E INICIA A MINERAÃ‡ÃƒO SEM INTERAÃ‡ÃƒO ðŸ”¥
# ============================================================================
#   âœ… Carteira fixa: bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl
#   âœ… Discord webhook configurado
#   âœ… Auto pool ativado
#   âœ… Wake lock ativado
#   âœ… Monitoramento contÃ­nuo
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURAÃ‡Ã•ES FIXAS
# ----------------------------------------------------------------------------
WALLET_ADDRESS="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
WALLET_BACKUP="bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh"
WEBHOOK_DISCORD="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"
WEBHOOK_TELEGRAM=""
WEBHOOK_PUSH=""

# ----------------------------------------------------------------------------
# VARIÃVEIS GLOBAIS
# ----------------------------------------------------------------------------
SYSTEM_VERSION="99.9"
SYSTEM_BUILD="$(date +%Y%m%d_%H%M%S)"
START_TIME=$(date +%s)
MINER_ROOT="/data/data/com.termux/files/home/.xmrig_god_final"
MINER_BIN="$MINER_ROOT/bin"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
MINER_SCRIPTS="$MINER_ROOT/scripts"
MINER_TEMP="$MINER_ROOT/temp"
MINER_BACKUP="$MINER_ROOT/backup"

mkdir -p "$MINER_BIN" "$MINER_CONFIG" "$MINER_LOGS" "$MINER_STATS" "$MINER_SCRIPTS" "$MINER_TEMP" "$MINER_BACKUP"
touch "$MINER_LOGS"/{system.log,miner.log,error.log,discord.log,satoshi.log,hashrate.log,xmrig_raw.log,pool.log,shares_history.log,auto_pool.log}

# ----------------------------------------------------------------------------
# CONFIGURAÃ‡Ã•ES PERSISTENTES (VALORES PADRÃƒO)
# ----------------------------------------------------------------------------
CPU_THREADS=$(($(nproc 2>/dev/null || echo 2) - 1))
[ $CPU_THREADS -lt 1 ] && CPU_THREADS=1
CPU_PRIORITY=5
CPU_MAX=75
TLS_ENABLED=false
AUTO_POOL=true
POOL_INTERVAL=1800
DONATE_LEVEL=0
WAKE_LOCK_ACTIVE=false  # SerÃ¡ ativado durante a mineraÃ§Ã£o

# ----------------------------------------------------------------------------
# CORES (BÃSICAS PARA OUTPUT)
# ----------------------------------------------------------------------------
NC='\033[0m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'

# ----------------------------------------------------------------------------
# POOLS DISPONÃVEIS
# ----------------------------------------------------------------------------
POOLS=(
    "randomxmonero.auto.nicehash.com:9200"
    "randomxmonero.eu.nicehash.com:3380"
    "randomxmonero.usa.nicehash.com:3380"
    "randomxmonero.br.nicehash.com:3380"
    "randomxmonero.jp.nicehash.com:3380"
    "randomxmonero.sg.nicehash.com:3380"
    "pool.supportxmr.com:3333"
    "pool.supportxmr.com:443"
    "gulf.moneroocean.stream:10001"
    "pool.moneroocean.stream:10001"
)

# ----------------------------------------------------------------------------
# FUNÃ‡Ã•ES DE LOG
# ----------------------------------------------------------------------------
log() {
    local level="$1"
    local msg="$2"
    local timestamp="[$(date '+%Y-%m-%d %H:%M:%S')]"
    echo "$timestamp [$level] $msg" >> "$MINER_LOGS/system.log"
    case "$level" in
        INFO)  echo -e "${CYAN}[INFO]${NC} $msg" ;;
        OK)    echo -e "${GREEN}[OK]${NC} $msg" ;;
        WARN)  echo -e "${YELLOW}[WARN]${NC} $msg" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} $msg" ;;
        *)     echo "[$level] $msg" ;;
    esac
}

log_info()  { log "INFO" "$1"; }
log_ok()    { log "OK" "$1"; }
log_warn()  { log "WARN" "$1"; }
log_error() { log "ERROR" "$1"; }

# ----------------------------------------------------------------------------
# NOTIFICAÃ‡Ã•ES DISCORD
# ----------------------------------------------------------------------------
discord_send() {
    local msg="$1"
    local color="$2"
    local title="$3"
    if [ -z "$WEBHOOK_DISCORD" ] || [[ "$WEBHOOK_DISCORD" == *"example.com"* ]]; then
        return
    fi
    local json=$(cat <<EOF
{"embeds":[{"title":"$title","description":"$msg","color":$color,"timestamp":"$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')"}]}
EOF
)
    curl -s -H "Content-Type: application/json" -X POST -d "$json" "$WEBHOOK_DISCORD" -o /dev/null
}

# ----------------------------------------------------------------------------
# DETECÃ‡ÃƒO DE ARQUITETURA E VERIFICAÃ‡ÃƒO DE BINÃRIO
# ----------------------------------------------------------------------------
detect_arch() {
    case $(uname -m) in
        aarch64|arm64) echo "arm64" ;;
        armv7l|armhf)  echo "arm32" ;;
        x86_64|amd64)  echo "x64" ;;
        *)             echo "unknown" ;;
    esac
}

verify_xmrig() {
    local bin="$1"
    [ ! -f "$bin" ] && return 1
    chmod +x "$bin" 2>/dev/null
    "$bin" --version >/dev/null 2>&1 && return 0
    return 1
}

# ----------------------------------------------------------------------------
# WAKE LOCK
# ----------------------------------------------------------------------------
enable_wake_lock() {
    if command -v termux-wake-lock &>/dev/null; then
        termux-wake-lock
        WAKE_LOCK_ACTIVE=true
        log_ok "Wake lock ativado"
    else
        log_warn "termux-wake-lock nÃ£o encontrado (instale termux-api)"
    fi
}

# ----------------------------------------------------------------------------
# INSTALAÃ‡ÃƒO DE DEPENDÃŠNCIAS
# ----------------------------------------------------------------------------
install_deps() {
    log_info "Verificando dependÃªncias..."
    pkg update -y >/dev/null 2>&1
    for pkg in curl wget nc git cmake make libuv libhwloc openssl unzip tar; do
        if ! command -v "$pkg" >/dev/null 2>&1 && ! pkg list-installed 2>/dev/null | grep -q "^$pkg"; then
            pkg install -y "$pkg" >/dev/null 2>&1 && log_ok "$pkg instalado"
        fi
    done
}

# ----------------------------------------------------------------------------
# MÃ‰TODOS DE INSTALAÃ‡ÃƒO DO XMRIG
# ----------------------------------------------------------------------------
method_mooo_binary() {
    log_info "Tentando binÃ¡rio do xmrig.mooo.info..."
    cd "$MINER_TEMP"
    rm -f xmrig.zip xmrig.tar
    local arch=$(detect_arch)
    local url=""
    if [ "$arch" = "arm64" ]; then
        url="http://xmrig.mooo.info/xmrigARM-1.9.5-android-arm64v8.zip"
    elif [ "$arch" = "arm32" ]; then
        url="http://xmrig.mooo.info/xmrigARM-1.9.3-android-arm32v7.zip"
    else
        url="http://xmrig.mooo.info/xmrigARM-generic-arm64v8.tar"
    fi
    wget -q --timeout=30 --tries=3 "$url" -O xmrig.zip 2>/dev/null || wget -q --timeout=30 --tries=3 "$url" -O xmrig.tar 2>/dev/null
    if [ -f "xmrig.zip" ]; then
        unzip -q xmrig.zip 2>/dev/null
        local bin=$(find . -name "xmrigARM" -type f | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig"
    elif [ -f "xmrig.tar" ]; then
        tar -xf xmrig.tar 2>/dev/null
        local bin=$(find . -name "xmrig" -type f -executable | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig"
    fi
    if verify_xmrig "$MINER_BIN/xmrig"; then
        log_ok "XMRig instalado via xmrig.mooo.info"
        discord_send "âœ… XMRig instalado (mooo.info)" "3066993" "InstalaÃ§Ã£o OK"
        return 0
    fi
    return 1
}

method_mooo_script() {
    log_info "Tentando script miner.sh..."
    cd "$MINER_TEMP"
    export WORKER="god_auto_$(date +%s)"
    export HOSTTYPE=$(detect_arch)
    curl -s -L http://xmrig.mooo.info/miner.sh | sh -s pool.supportxmr.com:3333 "$WALLET_ADDRESS" rx/0 "$CPU_THREADS" > /tmp/miner_sh.log 2>&1 &
    local pid=$!
    sleep 30
    if [ -f "$MINER_TEMP/xmrig" ] && verify_xmrig "$MINER_TEMP/xmrig"; then
        cp "$MINER_TEMP/xmrig" "$MINER_BIN/xmrig"
        log_ok "XMRig instalado via miner.sh"
        discord_send "âœ… XMRig instalado (miner.sh)" "3066993" "InstalaÃ§Ã£o OK"
        return 0
    fi
    return 1
}

method_compile() {
    log_info "Compilando XMRig (pode levar minutos)..."
    pkg install -y git cmake make libuv libhwloc openssl >/dev/null 2>&1
    cd "$MINER_TEMP"
    rm -rf xmrig
    git clone --depth=1 --branch v6.19.0 https://github.com/xmrig/xmrig.git >/dev/null 2>&1
    [ ! -d "xmrig" ] && return 1
    cd xmrig && mkdir -p build && cd build
    cmake .. -DWITH_TLS=OFF -DWITH_HTTPD=OFF -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DWITH_HWLOC=OFF -DWITH_SSE4_1=OFF -DCMAKE_BUILD_TYPE=Release > /tmp/cmake.log 2>&1
    make -j$CPU_THREADS > /tmp/make.log 2>&1
    if [ -f "xmrig" ] && verify_xmrig "xmrig"; then
        cp xmrig "$MINER_BIN/xmrig"
        log_ok "XMRig compilado com sucesso"
        discord_send "âœ… XMRig compilado" "3066993" "InstalaÃ§Ã£o OK"
        return 0
    fi
    return 1
}

install_xmrig_auto() {
    if [ -f "$MINER_BIN/xmrig" ] && verify_xmrig "$MINER_BIN/xmrig"; then
        log_ok "XMRig jÃ¡ estÃ¡ instalado e funcional"
        return 0
    fi
    log_info "XMRig nÃ£o encontrado. Iniciando instalaÃ§Ã£o automÃ¡tica..."
    rm -f "$MINER_BIN/xmrig"
    pkg uninstall -y xmrig >/dev/null 2>&1
    install_deps
    method_mooo_binary || method_mooo_script || method_compile || {
        log_error "FALHA NA INSTALAÃ‡ÃƒO DO XMRIG"
        discord_send "âŒ Falha na instalaÃ§Ã£o do XMRig" "15158332" "ERRO"
        exit 1
    }
}

# ----------------------------------------------------------------------------
# TESTE DE LATÃŠNCIA E SELEÃ‡ÃƒO DE POOL
# ----------------------------------------------------------------------------
test_latency() {
    local host="${1%:*}"
    local port="${1##*:}"
    if date +%N >/dev/null 2>&1; then
        local start=$(date +%s%N)
        timeout 2 nc -z -w 2 "$host" "$port" 2>/dev/null
        local end=$(date +%s%N)
        echo $(( (end - start) / 1000000 ))
    else
        local start=$(date +%s)
        timeout 2 nc -z -w 2 "$host" "$port" 2>/dev/null
        local end=$(date +%s)
        echo $(( (end - start) * 1000 ))
    fi
}

select_best_pool() {
    local best_pool="${POOLS[0]}" best_lat=999999
    for pool in "${POOLS[@]}"; do
        lat=$(test_latency "$pool" 2>/dev/null || echo 9999)
        [ "$lat" -lt "$best_lat" ] && { best_lat="$lat"; best_pool="$pool"; }
    done
    echo "$best_pool"
}

# ----------------------------------------------------------------------------
# CONFIGURAÃ‡ÃƒO DO MINERADOR
# ----------------------------------------------------------------------------
configure_miner() {
    local pool=$(select_best_pool)
    local worker="god_auto_$(date +%s)_$RANDOM"
    cat > "$MINER_CONFIG/config.json" << EOF
{
    "autosave": true,
    "cpu": true,
    "donate-level": $DONATE_LEVEL,
    "pools": [{
        "url": "$pool",
        "user": "$WALLET_ADDRESS.$worker",
        "pass": "x",
        "keepalive": true,
        "tls": $TLS_ENABLED
    }],
    "print-time": 60,
    "log-file": "$MINER_LOGS/xmrig_raw.log",
    "cpu-max-threads-hint": $CPU_MAX,
    "cpu-priority": $CPU_PRIORITY
}
EOF
    cat > "$MINER_CONFIG/worker.info" << EOF
WORKER=$worker
POOL=$pool
WALLET=$WALLET_ADDRESS
TLS=$TLS_ENABLED
EOF
    log_ok "ConfiguraÃ§Ã£o salva com pool: $pool"
}

# ----------------------------------------------------------------------------
# FUNÃ‡Ã•ES DE ESTATÃSTICAS
# ----------------------------------------------------------------------------
get_hashrate() {
    local logfile="$MINER_LOGS/xmrig_raw.log"
    [ ! -s "$logfile" ] && logfile="$MINER_LOGS/miner.log"
    if [ -f "$logfile" ]; then
        local line=$(tail -n 50 "$logfile" 2>/dev/null | grep -E 'speed.*H/s' | tail -1)
        [ -n "$line" ] && echo "$line" | sed -E 's/.* ([0-9.]+) H\/s.*/\1 H\/s/' || echo "0 H/s"
    else
        echo "0 H/s"
    fi
}

get_hashrate_value() { get_hashrate | awk '{print $1}'; }

get_shares() {
    if [ -f "$MINER_LOGS/xmrig_raw.log" ]; then
        tail -n 100 "$MINER_LOGS/xmrig_raw.log" 2>/dev/null | grep -c 'accepted'
    else
        echo 0
    fi
}

get_temp() {
    if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
        awk '{printf "%.0f", $1/1000}' /sys/class/thermal/thermal_zone0/temp
    else
        echo 0
    fi
}

get_total_satoshis() { cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0; }

# ----------------------------------------------------------------------------
# ATUALIZAÃ‡ÃƒO DE ESTATÃSTICAS E SATOSHIS
# ----------------------------------------------------------------------------
update_stats() {
    local hashrate=$(get_hashrate_value)
    local temp=$(get_temp)
    local shares=$(get_shares)
    echo "$hashrate" > "$MINER_STATS/current_hashrate"
    echo "$temp" > "$MINER_STATS/current_temp"
    echo "$shares" > "$MINER_STATS/total_shares"
    echo "$(date '+%Y-%m-%d %H:%M:%S') | Shares: $shares | HR: $hashrate" >> "$MINER_LOGS/shares_history.log"
    echo "$hashrate" >> "$MINER_LOGS/hashrate.log"
}

log_satoshi_auto() {
    local current_shares=$(get_shares)
    local last_file="$MINER_STATS/last_shares"
    local last=0; [ -f "$last_file" ] && last=$(cat "$last_file")
    local diff=$((current_shares - last))
    [ $diff -lt 0 ] && diff=0
    local sats=$((diff * 10))
    local total=$(($(get_total_satoshis) + sats))
    echo "$total" > "$MINER_STATS/total_satoshis"
    echo "$current_shares" > "$last_file"
    
    local hashrate=$(get_hashrate)
    local temp=$(get_temp)
    local timestamp="$(date '+%H:%M:%S')"
    echo "$timestamp | +$sats sats | HR: $hashrate | Temp: $tempÂ°C | Total: $total sats" >> "$MINER_LOGS/satoshi.log"
    
    # Discord a cada 10 minutos (aproximadamente) para nÃ£o floodar
    if [ $(( $(date +%s) % 600 )) -lt 60 ]; then
        discord_send "ðŸ’° +$sats sats | HR: $hashrate | Total: $total sats" "16753920" "Satoshis"
    fi
}

# ----------------------------------------------------------------------------
# INICIAR MINERAÃ‡ÃƒO
# ----------------------------------------------------------------------------
start_mining() {
    if pgrep -f xmrig >/dev/null; then
        log_warn "MineraÃ§Ã£o jÃ¡ estÃ¡ ativa"
        return 1
    fi
    install_xmrig_auto
    [ ! -f "$MINER_CONFIG/config.json" ] && configure_miner
    enable_wake_lock
    echo "$(get_shares)" > "$MINER_STATS/last_shares"
    cd "$MINER_ROOT"
    nohup "$MINER_BIN/xmrig" -c "$MINER_CONFIG/config.json" >> "$MINER_LOGS/miner.log" 2>&1 &
    local pid=$!
    echo $pid > "$MINER_STATS/miner.pid"
    sleep 3
    if kill -0 $pid 2>/dev/null; then
        local worker=$(grep "^WORKER=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        local pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        log_ok "MineraÃ§Ã£o iniciada (PID: $pid) | Pool: $pool"
        discord_send "ðŸš€ MineraÃ§Ã£o iniciada\nWorker: $worker\nPool: $pool" "3066993" "InÃ­cio"
        # Loop de estatÃ­sticas em background
        (
            while kill -0 $pid 2>/dev/null; do
                update_stats
                log_satoshi_auto
                sleep 60
            done
        ) &
        echo $! > "$MINER_STATS/stats_loop.pid"
        return 0
    else
        log_error "Falha ao iniciar mineraÃ§Ã£o"
        discord_send "âŒ Falha ao iniciar mineraÃ§Ã£o" "15158332" "ERRO"
        return 1
    fi
}

# ----------------------------------------------------------------------------
# AUTO POOL DAEMON (SIMPLIFICADO)
# ----------------------------------------------------------------------------
start_auto_pool() {
    cat > "$MINER_SCRIPTS/auto_pool.sh" << 'INNER'
#!/data/data/com.termux/files/usr/bin/bash
MINER_CONFIG="$MINER_CONFIG"
MINER_LOGS="$MINER_LOGS"
POOL_INTERVAL="$POOL_INTERVAL"
SCRIPT_PATH="$0"
while true; do
    if pgrep -f xmrig >/dev/null; then
        current=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        if [ -n "$current" ]; then
            lat=$(timeout 2 nc -z -w 2 "${current%:*}" "${current##*:}" 2>/dev/null && echo "100" || echo "9999")
            if [ "$lat" -ge 9999 ] || [ ! -f /tmp/pool_check ] || [ $(( $(date +%s) - $(cat /tmp/pool_check) )) -ge $POOL_INTERVAL ]; then
                # Aqui vocÃª poderia chamar o script principal para trocar a pool
                # Por simplicidade, apenas loga
                echo "$(date) | VerificaÃ§Ã£o de pool: $current ($lat ms)" >> "$MINER_LOGS/auto_pool.log"
                date +%s > /tmp/pool_check
            fi
        fi
    fi
    sleep 60
done
INNER
    chmod +x "$MINER_SCRIPTS/auto_pool.sh"
    nohup "$MINER_SCRIPTS/auto_pool.sh" >/dev/null 2>&1 &
    echo $! > "$MINER_STATS/auto_pool.pid"
    log_ok "Auto pool daemon iniciado"
}

# ----------------------------------------------------------------------------
# MONITORAMENTO EM TEMPO REAL (LOOP PRINCIPAL)
# ----------------------------------------------------------------------------
monitor_loop() {
    log_info "Monitoramento iniciado. Pressione Ctrl+C para parar."
    while true; do
        clear
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${PURPLE}              XMRIG MINER GOD â€“ MODO AUTOMÃTICO v$SYSTEM_VERSION${NC}"
        echo -e "${PURPLE}                         $(date '+%d/%m/%Y %H:%M:%S')${NC}"
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        if pgrep -f xmrig >/dev/null; then
            hashrate=$(get_hashrate)
            temp=$(get_temp)
            sats=$(get_total_satoshis)
            shares=$(get_shares)
            pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2 | cut -d. -f1-2)
            uptime=$(ps -o etimes= -p $(pgrep -f xmrig) 2>/dev/null | xargs)
            uptime_str="$((uptime/3600))h $(((uptime%3600)/60))m $((uptime%60))s"
            hashrate_val=$(get_hashrate_value)
            usd_hour=$(echo "scale=6; $hashrate_val * 0.00000001 * 45000 * 3600" | bc 2>/dev/null || echo "0")
            
            echo -e "${GREEN}â–¶ MineraÃ§Ã£o: ATIVA${NC}"
            echo "   PID: $(pgrep -f xmrig)"
            echo "   Uptime: $uptime_str"
            echo ""
            echo -e "${CYAN}âš¡ EstatÃ­sticas:${NC}"
            echo "   Hashrate: $hashrate"
            echo "   Temperatura: $tempÂ°C"
            echo "   Satoshis acumulados: $sats sats"
            echo "   Shares: $shares"
            echo "   USD/hora estimado: \$$usd_hour"
            echo ""
            echo -e "${CYAN}ðŸŒ Pool:${NC} $pool"
            echo -e "${CYAN}ðŸ‘› Carteira:${NC} ${WALLET_ADDRESS:0:20}..."
        else
            echo -e "${RED}â–¶ MineraÃ§Ã£o: INATIVA${NC}"
        fi
        echo ""
        echo -e "${YELLOW}Monitoramento automÃ¡tico - Ctrl+C para encerrar${NC}"
        sleep 60
    done
}

# ----------------------------------------------------------------------------
# TRAP DE SAÃDA
# ----------------------------------------------------------------------------
clean_exit() {
    echo -e "\n${YELLOW}Encerrando mineraÃ§Ã£o...${NC}"
    pkill -f xmrig
    pkill -f auto_pool.sh
    [ -f "$MINER_STATS/auto_pool.pid" ] && kill $(cat "$MINER_STATS/auto_pool.pid") 2>/dev/null
    [ -f "$MINER_STATS/stats_loop.pid" ] && kill $(cat "$MINER_STATS/stats_loop.pid") 2>/dev/null
    termux-wake-unlock 2>/dev/null
    discord_send "ðŸ›‘ MineraÃ§Ã£o encerrada" "15158332" "Parada"
    exit 0
}
trap clean_exit SIGINT SIGTERM

# ----------------------------------------------------------------------------
# EXECUÃ‡ÃƒO PRINCIPAL
# ----------------------------------------------------------------------------
clear
echo -e "${PURPLE}"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
echo "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•"
echo "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
echo "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•šâ•â•â•â•â–ˆâ–ˆâ•‘"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘"
echo "â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•  â•šâ•â•â•â•  â•šâ•â•â•â•â•â•â•"
echo -e "${NC}"
echo -e "${PURPLE}ðŸ”¥ XMRIG MINER GOD â€“ MODO AUTOMÃTICO v$SYSTEM_VERSION ðŸ”¥${NC}"
echo ""

# Verifica se estÃ¡ no Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}Este script deve ser executado no Termux!${NC}"
    exit 1
fi

# Inicializa arquivos de estatÃ­stica
[ ! -f "$MINER_STATS/total_satoshis" ] && echo "0" > "$MINER_STATS/total_satoshis"
[ ! -f "$MINER_STATS/total_shares" ] && echo "0" > "$MINER_STATS/total_shares"
[ ! -f "$MINER_STATS/current_hashrate" ] && echo "0 H/s" > "$MINER_STATS/current_hashrate"
[ ! -f "$MINER_STATS/current_temp" ] && echo "0" > "$MINER_STATS/current_temp"
[ ! -f "$MINER_STATS/last_shares" ] && echo "0" > "$MINER_STATS/last_shares"

# Instala dependÃªncias bÃ¡sicas
install_deps

# Inicia a mineraÃ§Ã£o
start_mining

# Inicia auto pool se configurado
[ "$AUTO_POOL" = true ] && start_auto_pool

# Entra no loop de monitoramento
monitor_loop
