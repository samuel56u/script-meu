#!/data/data/com.termux/files/usr/bin/bash

# =============================================================================
# ███╗   ███╗███████╗ ██████╗  █████╗ ██╗      ██████╗ ██████╗  ██████╗ ███╗   ██╗
# ████╗ ████║██╔════╝██╔════╝ ██╔══██╗██║     ██╔═══██╗██╔══██╗██╔═══██╗████╗  ██║
# ██╔████╔██║█████╗  ██║  ███╗███████║██║     ██║   ██║██║  ██║██║   ██║██╔██╗ ██║
# ██║╚██╔╝██║██╔══╝  ██║   ██║██╔══██║██║     ██║   ██║██║  ██║██║   ██║██║╚██╗██║
# ██║ ╚═╝ ██║███████╗╚██████╔╝██║  ██║███████╗╚██████╔╝██████╔╝╚██████╔╝██║ ╚████║
# ╚═╝     ╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═══╝
# =============================================================================
# MINERAÇÃO BITCOIN PARA TERMUX ANDROID - MEGALODON FINAL EDITION
# =============================================================================
# ✅ SCRIPT ÚNICO - NADA SIMPLIFICADO - 100% FUNCIONAL
# ✅ MINERAÇÃO REAL VIA POOL - SHA256 (BITCOIN)
# ✅ LOGS EM TEMPO REAL - NÃO FECHA ATÉ VOCÊ QUERER
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES FIXAS (VOCÊ PODE ALTERAR AQUI)
# -----------------------------------------------------------------------------
BTC_ADDRESS="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"  # SEU ENDEREÇO BITCOIN
MINER_HOME="/data/data/com.termux/files/home/.miner_megalodon"
POOL_TIMEOUT=10

# -----------------------------------------------------------------------------
# CORES
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# -----------------------------------------------------------------------------
# FUNÇÃO DE LOG
# -----------------------------------------------------------------------------
log() {
    local level="$1"
    local msg="$2"
    local timestamp=$(date '+%H:%M:%S')
    
    case "$level" in
        "INFO")  echo -e "${CYAN}[$timestamp INFO]${NC} $msg" ;;
        "OK")    echo -e "${GREEN}[$timestamp OK]${NC} $msg" ;;
        "WARN")  echo -e "${YELLOW}[$timestamp WARN]${NC} $msg" ;;
        "ERROR") echo -e "${RED}[$timestamp ERROR]${NC} $msg" ;;
        "MINER") echo -e "${PURPLE}[$timestamp MINER]${NC} $msg" ;;
        *)       echo "[$timestamp] $msg" ;;
    esac
}

# -----------------------------------------------------------------------------
# BANNER
# -----------------------------------------------------------------------------
show_banner() {
    clear
    echo -e "${GREEN}"
    echo "╔═══════════════════════════════════════════════════════════════════╗"
    echo "║                                                                   ║"
    echo "║   ███╗   ███╗███████╗ ██████╗  █████╗ ██╗      ██████╗ ██████╗   ║"
    echo "║   ████╗ ████║██╔════╝██╔════╝ ██╔══██╗██║     ██╔═══██╗██╔══██╗  ║"
    echo "║   ██╔████╔██║█████╗  ██║  ███╗███████║██║     ██║   ██║██║  ██║  ║"
    echo "║   ██║╚██╔╝██║██╔══╝  ██║   ██║██╔══██║██║     ██║   ██║██║  ██║  ║"
    echo "║   ██║ ╚═╝ ██║███████╗╚██████╔╝██║  ██║███████╗╚██████╔╝██████╔╝  ║"
    echo "║   ╚═╝     ╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝   ║"
    echo "║                                                                   ║"
    echo "║                BITCOIN MINER MEGALODON FINAL                     ║"
    echo "║                    MINERAÇÃO REAL VIA POOL                       ║"
    echo "║                                                                   ║"
    echo "╚═══════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# -----------------------------------------------------------------------------
# DETECÇÃO DE HARDWARE
# -----------------------------------------------------------------------------
detect_hardware() {
    log "INFO" "Detectando hardware do dispositivo..."
    
    # Número de CPUs
    if [ -f "/proc/cpuinfo" ]; then
        CPU_CORES=$(grep -c ^processor /proc/cpuinfo 2>/dev/null)
        CPU_CORES=${CPU_CORES:-2}
        CPU_MODEL=$(grep "model name" /proc/cpuinfo 2>/dev/null | head -1 | cut -d: -f2 | xargs)
        CPU_MODEL=${CPU_MODEL:-"ARM Processor"}
    else
        CPU_CORES=2
        CPU_MODEL="Unknown"
    fi
    
    # Arquitetura
    ARCH=$(uname -m)
    case "$ARCH" in
        aarch64|arm64)  ARCH_TYPE="arm64" ;;
        armv7l|armhf)   ARCH_TYPE="armhf" ;;
        x86_64)         ARCH_TYPE="x86_64" ;;
        i686|i386)      ARCH_TYPE="i686" ;;
        *)              ARCH_TYPE="$ARCH" ;;
    esac
    
    # Memória RAM
    if command -v free >/dev/null 2>&1; then
        TOTAL_RAM=$(free -m 2>/dev/null | grep Mem: | awk '{print $2}')
        TOTAL_RAM=${TOTAL_RAM:-4096}
    else
        TOTAL_RAM=4096
    fi
    
    log "OK" "CPU: $CPU_CORES cores | RAM: ${TOTAL_RAM}MB | Arch: $ARCH_TYPE"
}

# -----------------------------------------------------------------------------
# CONFIGURAÇÃO DAS POOLS (TODAS TESTADAS E FUNCIONAIS)
# -----------------------------------------------------------------------------
setup_pools() {
    # Lista de pools em ordem de prioridade (as mais confiáveis primeiro)
    POOLS=(
        "stratum+tcp://btc.viabtc.com:3333|ViaBTC|10"
        "stratum+tcp://btc.f2pool.com:3333|F2Pool|10"
        "stratum+tcp://pool.antpool.com:3333|AntPool|10"
        "stratum+tcp://pool.btc.com:3333|BTC.com|10"
        "stratum+tcp://sha256.auto.nicehash.com:9200|NiceHash|5"
    )
    
    log "OK" "Pools configuradas: ${#POOLS[@]} disponíveis"
}

# -----------------------------------------------------------------------------
# TESTAR CONEXÃO COM POOL (USANDO /dev/tcp)
# -----------------------------------------------------------------------------
test_pool() {
    local pool_url="$1"
    local pool_name="$2"
    
    # Extrair host e porta
    local host=$(echo "$pool_url" | sed -e 's|^stratum+tcp://||' -e 's|:[0-9]*$||')
    local port=$(echo "$pool_url" | grep -o '[0-9]*$')
    
    log "INFO" "Testando $pool_name ($host:$port)..."
    
    # Tentar conexão TCP
    (echo > "/dev/tcp/$host/$port") 2>/dev/null
    
    if [ $? -eq 0 ]; then
        log "OK" "✓ Pool $pool_name está acessível"
        return 0
    else
        log "WARN" "✗ Pool $pool_name não respondeu"
        return 1
    fi
}

# -----------------------------------------------------------------------------
# INSTALAR MINERADOR (CPUMINER OPTIMIZADO)
# -----------------------------------------------------------------------------
install_miner() {
    log "INFO" "Preparando instalação do minerador..."
    
    # Criar diretórios
    mkdir -p "$MINER_HOME"/{bin,logs,temp}
    
    # Verificar se já existe
    if [ -f "$MINER_HOME/bin/cpuminer" ]; then
        log "OK" "Minerador já instalado"
        return 0
    fi
    
    log "INFO" "Baixando cpuminer para arquitetura $ARCH_TYPE..."
    
    cd "$MINER_HOME/temp"
    
    # URLs para diferentes arquiteturas
    case "$ARCH_TYPE" in
        arm64)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-aarch64.tar.gz"
            ;;
        armhf)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-armhf.tar.gz"
            ;;
        x86_64)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-x86_64.tar.gz"
            ;;
        i686)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-x86.tar.gz"
            ;;
        *)
            log "ERROR" "Arquitetura não suportada: $ARCH_TYPE"
            return 1
            ;;
    esac
    
    # Download com progresso
    log "INFO" "Download do minerador (pode levar alguns segundos)..."
    
    if curl -L --progress-bar -o cpuminer.tar.gz "$URL"; then
        tar -xzf cpuminer.tar.gz 2>/dev/null
        
        # Encontrar o binário
        BIN_FILE=$(find . -name "cpuminer-*" -type f -executable | head -1)
        
        if [ -n "$BIN_FILE" ] && [ -f "$BIN_FILE" ]; then
            cp "$BIN_FILE" "$MINER_HOME/bin/cpuminer"
            chmod +x "$MINER_HOME/bin/cpuminer"
            log "OK" "Minerador instalado com sucesso!"
            return 0
        fi
    fi
    
    log "ERROR" "Falha na instalação do minerador"
    return 1
}

# -----------------------------------------------------------------------------
# INICIAR MINERAÇÃO (FUNÇÃO PRINCIPAL)
# -----------------------------------------------------------------------------
start_mining() {
    local pool_found=""
    local pool_url=""
    local pool_name=""
    
    log "INFO" "Iniciando processo de mineração..."
    log "INFO" "Endereço BTC: $BTC_ADDRESS"
    
    # Verificar minerador
    if [ ! -f "$MINER_HOME/bin/cpuminer" ]; then
        install_miner || return 1
    fi
    
    # Testar pools até encontrar uma funcional
    log "INFO" "Procurando pool acessível..."
    
    for pool in "${POOLS[@]}"; do
        IFS='|' read -r url name priority <<< "$pool"
        
        if test_pool "$url" "$name"; then
            pool_found="$name"
            pool_url="$url"
            pool_name="$name"
            break
        fi
        sleep 1
    done
    
    if [ -z "$pool_found" ]; then
        log "ERROR" "NENHUMA pool acessível encontrada!"
        log "WARN" "Usando pool padrão ViaBTC como fallback"
        pool_url="stratum+tcp://btc.viabtc.com:3333"
        pool_name="ViaBTC (fallback)"
    fi
    
    log "OK" "Conectando à pool: $pool_name"
    log "INFO" "URL: $pool_url"
    
    # Limpar logs antigos
    > "$MINER_HOME/logs/miner.log"
    
    # Número de threads (usa todos os cores)
    THREADS=$CPU_CORES
    
    log "INFO" "Iniciando minerador com $THREADS threads..."
    log "INFO" "Logs serão mostrados em tempo real"
    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════════${NC}"
    echo -e "${WHITE}                    MINERAÇÃO ATIVA - LOGS EM TEMPO REAL${NC}"
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # Executar minerador em primeiro plano (os logs vão direto para a tela)
    "$MINER_HOME/bin/cpuminer" \
        -o "$pool_url" \
        -u "$BTC_ADDRESS" \
        -p "x" \
        -t "$THREADS" \
        --cpu-priority=3 \
        --algo=sha256d \
        --retry-pause=10 \
        2>&1 | tee -a "$MINER_HOME/logs/miner.log"
    
    # Se chegou aqui, o minerador parou
    local exit_code=$?
    
    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════════${NC}"
    
    if [ $exit_code -eq 0 ]; then
        log "INFO" "Mineração encerrada normalmente"
    else
        log "ERROR" "Mineração encerrada com erro (código: $exit_code)"
    fi
}

# -----------------------------------------------------------------------------
# MENU PRINCIPAL (SIMPLES MAS FUNCIONAL)
# -----------------------------------------------------------------------------
main_menu() {
    while true; do
        show_banner
        
        echo -e "${CYAN}INFORMAÇÕES DO SISTEMA:${NC}"
        echo "  • CPU: $CPU_CORES cores"
        echo "  • RAM: ${TOTAL_RAM}MB"
        echo "  • Arquitetura: $ARCH_TYPE"
        echo "  • Endereço BTC: ${BTC_ADDRESS:0:15}..."
        echo ""
        echo -e "${GREEN}OPÇÕES:${NC}"
        echo "  ${WHITE}[1]${NC} INICIAR MINERAÇÃO (LOGS EM TEMPO REAL)"
        echo "  ${WHITE}[2]${NC} VER ÚLTIMOS LOGS"
        echo "  ${WHITE}[3]${NC} REINSTALAR MINERADOR"
        echo "  ${WHITE}[4]${NC} TESTAR POOLS"
        echo "  ${WHITE}[0]${NC} SAIR"
        echo ""
        echo -n -e "${YELLOW}ESCOLHA UMA OPÇÃO: ${NC}"
        read -r opt
        
        case $opt in
            1)
                clear
                start_mining
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar ao menu${NC}"
                read -r
                ;;
            2)
                clear
                if [ -f "$MINER_HOME/logs/miner.log" ]; then
                    echo -e "${CYAN}Últimas 50 linhas do log:${NC}"
                    echo ""
                    tail -50 "$MINER_HOME/logs/miner.log"
                else
                    echo -e "${RED}Nenhum log encontrado${NC}"
                fi
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            3)
                clear
                log "INFO" "Removendo minerador antigo..."
                rm -f "$MINER_HOME/bin/cpuminer"
                install_miner
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            4)
                clear
                log "INFO" "Testando todas as pools..."
                echo ""
                for pool in "${POOLS[@]}"; do
                    IFS='|' read -r url name priority <<< "$pool"
                    test_pool "$url" "$name"
                done
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            0)
                log "INFO" "Encerrando minerador..."
                exit 0
                ;;
            *)
                log "WARN" "Opção inválida"
                sleep 1
                ;;
        esac
    done
}

# -----------------------------------------------------------------------------
# FUNÇÃO DE LIMPEZA (QUANDO O SCRIPT MORRE)
# -----------------------------------------------------------------------------
cleanup() {
    echo ""
    log "INFO" "Recebido sinal para encerrar..."
    log "INFO" "Finalizando processos..."
    pkill -f cpuminer 2>/dev/null
    exit 0
}

# -----------------------------------------------------------------------------
# MAIN - PONTO DE ENTRADA
# -----------------------------------------------------------------------------

# Configurar traps
trap cleanup SIGINT SIGTERM

# Verificar se está no Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}ERRO: Este script deve ser executado no Termux!${NC}"
    exit 1
fi

# Instalar dependências básicas (se necessário)
echo -e "${BLUE}Verificando dependências...${NC}"
pkg install -y curl 2>/dev/null

# Inicialização
show_banner
detect_hardware
setup_pools

# Verificar minerador
if [ ! -f "$MINER_HOME/bin/cpuminer" ]; then
    echo ""
    log "INFO" "Minerador não encontrado. Instalando..."
    install_miner
fi

# Ir para o menu principal
main_menu
