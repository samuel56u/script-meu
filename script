#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# MINERADOR BITCOIN TERMUX v8.0 - TUDO FUNCIONAL
# Script completo e corrigido - 100% automÃ¡tico
# ============================================================================

# ============================================================================
# CONFIGURAÃ‡ÃƒO
# ============================================================================

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# DiretÃ³rios (CORRIGIDO - sem variÃ¡veis nulas)
MINER_DIR="$HOME/bitcoin_miner_termux"
BIN_DIR="$MINER_DIR/bin"
CONFIG_DIR="$MINER_DIR/config"
LOGS_DIR="$MINER_DIR/logs"
STATS_DIR="$MINER_DIR/stats"
SCRIPTS_DIR="$MINER_DIR/scripts"

# Carteira (ALTERE PARA SUA CARTEIRA)
WALLET="3Jg8E9nQrN4L2q7V1tXwY5zP6bR8cD0mF2aH4jK5l"

# Webhook Discord (opcional)
DISCORD_WEBHOOK=""

# ConfiguraÃ§Ãµes de mineraÃ§Ã£o
CPU_THREADS=4
CPU_PRIORITY=3
DONATE_LEVEL=1

# ============================================================================
# FUNÃ‡Ã•ES UTILITÃRIAS
# ============================================================================

print_banner() {
    clear
    echo ""
    echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${PURPLE}â•‘          ðŸš€ MINERADOR BITCOIN TERMUX - v8.0 COMPLETO               â•‘${NC}"
    echo -e "${PURPLE}â•‘               (TUDO FUNCIONAL - 100% AUTOMÃTICO)                   â•‘${NC}"
    echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[i]${NC} $1"
}

print_step() {
    echo -e "${BLUE}[â†’]${NC} $1"
}

log_event() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOGS_DIR/system.log"
}

# ============================================================================
# VERIFICAÃ‡Ã•ES INICIAIS
# ============================================================================

check_termux() {
    if [ ! -d "/data/data/com.termux" ]; then
        print_error "Este script sÃ³ funciona no Termux (Android)"
        exit 1
    fi
}

check_internet() {
    print_step "Verificando conexÃ£o com a internet..."
    
    if ping -c 1 8.8.8.8 >/dev/null 2>&1 || ping -c 1 1.1.1.1 >/dev/null 2>&1; then
        print_success "ConexÃ£o com internet OK"
        return 0
    else
        print_error "Sem internet! Conecte-se e tente novamente"
        return 1
    fi
}

check_root() {
    print_step "Verificando permissÃµes..."
    if [ "$(whoami)" = "root" ]; then
        print_warning "Executando como root - pode causar problemas"
    fi
}

# ============================================================================
# INSTALAÃ‡ÃƒO DO SISTEMA
# ============================================================================

install_dependencies() {
    print_step "Instalando/atualizando dependÃªncias..."
    
    # Atualizar Termux
    pkg update -y && pkg upgrade -y >/dev/null 2>&1
    
    # Instalar dependÃªncias essenciais
    pkg install -y wget curl tar git cmake make build-essential \
        python python-pip libuv libuv-dev openssl openssl-dev \
        libmicrohttpd libhwloc hwloc-dev nano htop neofetch jq bc \
        net-tools proot termux-api 2>/dev/null
    
    print_success "DependÃªncias instaladas"
}

create_directories() {
    print_step "Criando estrutura de diretÃ³rios..."
    
    # Remover instalaÃ§Ãµes anteriores problemÃ¡ticas
    rm -rf "$MINER_DIR" 2>/dev/null
    
    # Criar diretÃ³rios
    mkdir -p "$MINER_DIR"
    mkdir -p "$BIN_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$LOGS_DIR"
    mkdir -p "$STATS_DIR"
    mkdir -p "$SCRIPTS_DIR"
    
    print_success "DiretÃ³rios criados em: $MINER_DIR"
}

install_xmrig() {
    print_step "Instalando XMRig (mÃºltiplos mÃ©todos)..."
    
    # MÃ©todo 1: GitHub releases (binÃ¡rio ARM64)
    print_info "MÃ©todo 1: GitHub releases..."
    if wget -q --timeout=30 "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64.tar.gz" -O /tmp/xmrig.tar.gz; then
        tar -xzf /tmp/xmrig.tar.gz -C /tmp/
        find /tmp -name "xmrig" -type f -exec mv {} "$BIN_DIR/xmrig" \; 2>/dev/null
        rm -f /tmp/xmrig.tar.gz
    fi
    
    # MÃ©todo 2: Download direto do binÃ¡rio
    if [ ! -f "$BIN_DIR/xmrig" ]; then
        print_info "MÃ©todo 2: Download direto..."
        if wget -q "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64" -O "$BIN_DIR/xmrig"; then
            true
        fi
    fi
    
    # MÃ©todo 3: Mirror alternativo
    if [ ! -f "$BIN_DIR/xmrig" ]; then
        print_info "MÃ©todo 3: Mirror alternativo..."
        if wget -q "https://dl.miner.io/xmrig/v6.20.0/xmrig-6.20.0-linux-arm64" -O "$BIN_DIR/xmrig"; then
            true
        fi
    fi
    
    # Verificar se conseguiu baixar
    if [ -f "$BIN_DIR/xmrig" ]; then
        chmod +x "$BIN_DIR/xmrig"
        
        # Testar o binÃ¡rio
        if timeout 3 "$BIN_DIR/xmrig" --help >/dev/null 2>&1; then
            print_success "XMRig instalado com sucesso!"
            VERSION=$("$BIN_DIR/xmrig" --version 2>/dev/null | head -1)
            print_info "VersÃ£o: $VERSION"
            return 0
        else
            print_error "BinÃ¡rio do XMRig corrompido"
            return 1
        fi
    else
        print_error "Falha ao baixar XMRig"
        return 1
    fi
}

create_configuration() {
    print_step "Criando configuraÃ§Ã£o..."
    
    # Gerar nome Ãºnico para worker
    WORKER_NAME="termux_$(date +%s)_$(cat /proc/sys/kernel/random/uuid | cut -c1-4)"
    
    # Criar config.json
    cat > "$CONFIG_DIR/config.json" << EOF
{
    "autosave": true,
    "cpu": true,
    "opencl": false,
    "cuda": false,
    "donate-level": $DONATE_LEVEL,
    "log-file": "$LOGS_DIR/miner.log",
    "pools": [
        {
            "url": "randomxmonero.auto.nicehash.com:9200",
            "user": "$WALLET.$WORKER_NAME",
            "pass": "x",
            "rig-id": "$WORKER_NAME",
            "nicehash": true,
            "keepalive": true,
            "tls": false
        }
    ],
    "print-time": 60,
    "health-print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "cpu-max-threads-hint": 75,
    "cpu-priority": $CPU_PRIORITY,
    "randomx-mode": "fast",
    "background": false,
    "syslog": false
}
EOF
    
    # Salvar worker name
    echo "$WORKER_NAME" > "$CONFIG_DIR/worker_name.txt"
    
    print_success "ConfiguraÃ§Ã£o criada"
    print_info "Worker: $WORKER_NAME"
    print_info "Pool: randomxmonero.auto.nicehash.com:9200"
}

create_control_scripts() {
    print_step "Criando scripts de controle..."
    
    cd "$MINER_DIR"
    
    # ==================== START.SH ====================
    cat > start.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

# Ir para diretÃ³rio do minerador
cd "$HOME/bitcoin_miner_termux"

echo "========================================" >> logs/system.log
echo "ðŸš€ MINERAÃ‡ÃƒO INICIADA - $(date '+%Y-%m-%d %H:%M:%S')" >> logs/system.log
echo "========================================" >> logs/system.log

# Parar minerador anterior
pkill -f xmrig 2>/dev/null
sleep 2

echo "Iniciando XMRig..." >> logs/system.log
echo "Worker: $(cat config/worker_name.txt)" >> logs/system.log
echo "CPU Threads: 4 | Priority: 3" >> logs/system.log

# Iniciar XMRig
./bin/xmrig -c config/config.json --no-color >> logs/miner.log 2>&1 &

# Salvar PID
MINER_PID=$!
echo $MINER_PID > stats/miner.pid

echo "Minerador iniciado com PID: $MINER_PID" >> logs/system.log
echo "[$(date '+%H:%M:%S')] âœ… Minerador iniciado (PID: $MINER_PID)" >> logs/miner.log

# Verificar se estÃ¡ rodando
sleep 5
if ps -p $MINER_PID >/dev/null 2>&1; then
    echo -e "${GREEN}[âœ“] MineraÃ§Ã£o ATIVA e FUNCIONANDO!${NC}"
    echo -e "${CYAN}   PID: $MINER_PID${NC}"
    echo -e "${CYAN}   Worker: $(cat config/worker_name.txt)${NC}"
    echo -e "${CYAN}   Ver logs: tail -f logs/miner.log${NC}"
    
    # Enviar para Discord se configurado
    if [ -f "config/discord_webhook.txt" ]; then
        WEBHOOK=$(cat config/discord_webhook.txt)
        if [ ! -z "$WEBHOOK" ]; then
            curl -s -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\":\"ðŸš€ **MINERAÃ‡ÃƒO INICIADA**\\nðŸ‘· Worker: $(cat config/worker_name.txt)\\nðŸ’° Carteira: '$(cat config/wallet.txt)'\\nâš¡ CPU: 75%\\nðŸ• $(date '+%H:%M:%S')\"}" \
                 "$WEBHOOK" >/dev/null 2>&1 &
        fi
    fi
else
    echo -e "${RED}[âœ—] Falha ao iniciar minerador${NC}"
    echo "Verifique os logs: tail -f logs/miner.log"
fi
EOF

    # ==================== STOP.SH ====================
    cat > stop.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

echo "ðŸ›‘ Parando mineraÃ§Ã£o..." >> logs/system.log

# Parar minerador
pkill -f xmrig 2>/dev/null
sleep 2

# ForÃ§ar parada se necessÃ¡rio
if pgrep -f xmrig >/dev/null; then
    pkill -9 -f xmrig 2>/dev/null
    echo "ForÃ§ando parada..." >> logs/system.log
fi

echo "[$(date '+%H:%M:%S')] âœ… Minerador parado" >> logs/system.log
echo "[$(date '+%H:%M:%S')] âŒ MineraÃ§Ã£o parada" >> logs/miner.log

# Limpar PID
rm -f stats/miner.pid 2>/dev/null

echo -e "${GREEN}[âœ“] MineraÃ§Ã£o parada com sucesso${NC}"

# Enviar para Discord se configurado
if [ -f "config/discord_webhook.txt" ]; then
    WEBHOOK=$(cat config/discord_webhook.txt)
    if [ ! -z "$WEBHOOK" ]; then
        curl -s -H "Content-Type: application/json" \
             -X POST \
             -d "{\"content\":\"ðŸ›‘ **MINERAÃ‡ÃƒO PARADA**\\nðŸ‘· Worker: $(cat config/worker_name.txt)\\nðŸ• $(date '+%H:%M:%S')\"}" \
             "$WEBHOOK" >/dev/null 2>&1 &
    fi
fi
EOF

    # ==================== STATUS.SH ====================
    cat > status.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

clear
echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${PURPLE}â•‘                   STATUS DO MINERADOR BITCOIN                       â•‘${NC}"
echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Verificar se minerador estÃ¡ ativo
if pgrep -f xmrig >/dev/null; then
    MINER_PID=$(pgrep -f xmrig)
    MINER_TIME=$(ps -o etimes= -p $MINER_PID 2>/dev/null | xargs)
    
    if [ ! -z "$MINER_TIME" ]; then
        HOURS=$((MINER_TIME / 3600))
        MINUTES=$(( (MINER_TIME % 3600) / 60 ))
        SECONDS=$((MINER_TIME % 60))
        UPTIME="${HOURS}h ${MINUTES}m ${SECONDS}s"
    else
        UPTIME="Ativo"
    fi
    
    echo -e "${GREEN}[âœ“] MINERAÃ‡ÃƒO: ATIVA${NC}"
    echo "  PID: $MINER_PID"
    echo "  Tempo ativo: $UPTIME"
    echo "  Worker: $(cat config/worker_name.txt 2>/dev/null || echo 'Desconhecido')"
else
    echo -e "${RED}[âœ—] MINERAÃ‡ÃƒO: INATIVA${NC}"
fi
echo ""

# EstatÃ­sticas
echo -e "${CYAN}ðŸ“Š ESTATÃSTICAS:${NC}"
if [ -f "logs/miner.log" ]; then
    ACCEPTED=$(grep -c "accepted" logs/miner.log 2>/dev/null)
    REJECTED=$(grep -c "rejected" logs/miner.log 2>/dev/null)
    echo "  âœ… Shares aceitos: $ACCEPTED"
    echo "  âŒ Shares rejeitados: $REJECTED"
fi

if [ -f "stats/hashrate.txt" ]; then
    HASHRATE=$(cat stats/hashrate.txt 2>/dev/null)
    echo "  âš¡ Hashrate: $HASHRATE"
fi
echo ""

# Logs recentes
echo -e "${CYAN}ðŸ“‹ LOGS RECENTES:${NC}"
echo "  Sistema:"
tail -3 logs/system.log 2>/dev/null | while read line; do
    echo "    â€¢ ${line:20}"
done

echo ""
echo "  Minerador:"
tail -3 logs/miner.log 2>/dev/null | grep -E "accepted|rejected|speed" | while read line; do
    if [[ "$line" == *"accepted"* ]]; then
        echo -e "    ${GREEN}âœ… ${line:0:50}...${NC}"
    elif [[ "$line" == *"rejected"* ]]; then
        echo -e "    ${RED}âŒ ${line:0:50}...${NC}"
    else
        echo "    âš¡ ${line:0:50}..."
    fi
done

echo ""
echo -e "${CYAN}ðŸŽ¯ COMANDOS:${NC}"
echo "  ./start.sh     - Iniciar mineraÃ§Ã£o"
echo "  ./stop.sh      - Parar mineraÃ§Ã£o"
echo "  ./status.sh    - Ver status"
echo "  ./logs.sh      - Ver logs completos"
echo "  ./restart.sh   - Reiniciar"
echo "  ./monitor.sh   - Monitor em tempo real"

echo ""
echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo "ðŸ’° Carteira: $WALLET"
echo "ðŸŒ Pool: randomxmonero.auto.nicehash.com:9200"
echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Aguardar 10 segundos
read -t 10 -p "Voltando ao menu em 10 segundos... (Enter para continuar)"
EOF

    # ==================== LOGS.SH ====================
    cat > logs.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

clear
echo "Selecione o log para visualizar:"
echo ""
echo "1) Logs do minerador (miner.log)"
echo "2) Logs do sistema (system.log)"
echo "3) Todos os logs (resumo)"
echo "4) Seguir logs em tempo real"
echo "5) Voltar"
echo ""
echo -n "Escolha: "
read choice

case $choice in
    1)
        echo ""
        echo "=== ULTIMOS 50 LOGS DO MINERADOR ==="
        echo ""
        tail -50 logs/miner.log
        ;;
    2)
        echo ""
        echo "=== LOGS DO SISTEMA ==="
        echo ""
        tail -50 logs/system.log
        ;;
    3)
        echo ""
        echo "=== RESUMO COMPLETO ==="
        echo ""
        echo "ðŸ“Š ESTATÃSTICAS:"
        echo "  Minerador ativo: $(pgrep -f xmrig >/dev/null && echo 'Sim' || echo 'NÃ£o')"
        echo "  Shares aceitos: $(grep -c "accepted" logs/miner.log 2>/dev/null || echo '0')"
        echo "  Shares rejeitados: $(grep -c "rejected" logs/miner.log 2>/dev/null || echo '0')"
        echo ""
        echo "ðŸ“‹ ÃšLTIMOS LOGS:"
        tail -10 logs/system.log 2>/dev/null
        echo ""
        echo "â›ï¸  ÃšLTIMOS SHARES:"
        tail -5 logs/miner.log 2>/dev/null | grep -E "accepted|rejected" || echo "  Nenhum share recente"
        ;;
    4)
        echo ""
        echo "=== SEGUINDO LOGS EM TEMPO REAL ==="
        echo "Pressione CTRL+C para sair"
        echo ""
        tail -f logs/miner.log
        ;;
    5)
        exit 0
        ;;
    *)
        echo "OpÃ§Ã£o invÃ¡lida!"
        ;;
esac

echo ""
read -p "Pressione Enter para continuar..."
EOF

    # ==================== RESTART.SH ====================
    cat > restart.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

echo "ðŸ”„ Reiniciando sistema de mineraÃ§Ã£o..."
echo ""

./stop.sh >/dev/null 2>&1
sleep 3
./start.sh
EOF

    # ==================== MONITOR.SH ====================
    cat > monitor.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

clear
echo -e "${CYAN}=== MONITOR DE MINERAÃ‡ÃƒO EM TEMPO REAL ===${NC}"
echo "Pressione CTRL+C para sair"
echo ""

while true; do
    clear
    echo -e "${CYAN}=== $(date '+%H:%M:%S') ===${NC}"
    echo ""
    
    # Status
    if pgrep -f xmrig >/dev/null; then
        echo -e "${GREEN}âœ… MINERAÃ‡ÃƒO ATIVA${NC}"
        
        # Hashrate recente
        if [ -f "logs/miner.log" ]; then
            HASHRATE=$(tail -5 logs/miner.log | grep -E "speed.*[0-9]+\.[0-9]+" | tail -1 | grep -oE "[0-9]+\.[0-9]+ H/s" || echo "0.0 H/s")
            echo "âš¡ Hashrate: $HASHRATE"
        fi
        
        # Shares recentes
        ACCEPTED=$(tail -20 logs/miner.log | grep -c "accepted")
        REJECTED=$(tail -20 logs/miner.log | grep -c "rejected")
        echo "âœ… Shares (Ãºltimos 20 logs): $ACCEPTED aceitos, $REJECTED rejeitados"
    else
        echo -e "${RED}âŒ MINERAÃ‡ÃƒO INATIVA${NC}"
    fi
    
    echo ""
    echo "ðŸ“Š Logs recentes:"
    tail -3 logs/miner.log | grep -E "accepted|rejected|speed" | while read line; do
        if [[ "$line" == *"accepted"* ]]; then
            echo -e "  ${GREEN}$(date '+%H:%M:%S')${NC}: ${line:0:60}..."
        elif [[ "$line" == *"rejected"* ]]; then
            echo -e "  ${RED}$(date '+%H:%M:%S')${NC}: ${line:0:60}..."
        else
            echo "  $(date '+%H:%M:%S'): ${line:0:60}..."
        fi
    done
    
    echo ""
    echo "â³ Atualizando a cada 5 segundos..."
    sleep 5
done
EOF

    # ==================== INSTALL_MONITOR.SH ====================
    cat > scripts/install_monitor.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

echo "Instalando monitor automÃ¡tico..."

# Criar script de monitoramento
cat > scripts/monitor_daemon.sh << 'MONEOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

echo "ðŸ”„ Monitor automÃ¡tico iniciado: $(date '+%H:%M:%S')" >> logs/system.log

CHECK_INTERVAL=30
NO_SHARE_TIMEOUT=300

LAST_SHARE=$(date +%s)

while true; do
    # Verificar se minerador estÃ¡ rodando
    if ! pgrep -f xmrig >/dev/null; then
        echo "âš ï¸ Minerador parado. Reiniciando..." >> logs/system.log
        ./start.sh >/dev/null 2>&1
        sleep 30
        continue
    fi
    
    CURRENT_TIME=$(date +%s)
    
    # Verificar por shares recentes
    if [ -f "logs/miner.log" ]; then
        if tail -10 logs/miner.log | grep -q "accepted"; then
            LAST_SHARE=$CURRENT_TIME
            SHARE_INFO=$(tail -10 logs/miner.log | grep "accepted" | tail -1)
            echo "âœ… Share aceito: $SHARE_INFO" >> logs/shares.log
        fi
    fi
    
    # Verificar se estÃ¡ hÃ¡ muito tempo sem shares
    if [ $((CURRENT_TIME - LAST_SHARE)) -gt $NO_SHARE_TIMEOUT ]; then
        echo "âš ï¸ Muito tempo sem shares. Reiniciando..." >> logs/system.log
        ./stop.sh >/dev/null 2>&1
        sleep 5
        ./start.sh >/dev/null 2>&1
        LAST_SHARE=$CURRENT_TIME
    fi
    
    # Atualizar hashrate
    if [ -f "logs/miner.log" ]; then
        HASHRATE=$(tail -5 logs/miner.log | grep -E "speed.*[0-9]+\.[0-9]+" | tail -1 | grep -oE "[0-9]+\.[0-9]+ H/s" || echo "0.0 H/s")
        echo "$HASHRATE" > stats/hashrate.txt
    fi
    
    sleep $CHECK_INTERVAL
done
MONEOF

    chmod +x scripts/monitor_daemon.sh
    
    # Iniciar monitor
    nohup ./scripts/monitor_daemon.sh >/dev/null 2>&1 &
    
    echo "âœ… Monitor automÃ¡tico instalado e iniciado"
    echo "O monitor verificarÃ¡ automaticamente a cada 30 segundos"
    echo "ReiniciarÃ¡ o minerador se parar ou nÃ£o encontrar shares por 5 minutos"
EOF

    chmod +x scripts/install_monitor.sh

    # ==================== UPDATE.SH ====================
    cat > update.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

echo "ðŸ”„ Atualizando XMRig..."
echo ""

# Parar mineraÃ§Ã£o
./stop.sh >/dev/null 2>&1
sleep 2

# Fazer backup da configuraÃ§Ã£o
cp config/config.json config/config_backup.json 2>/dev/null

# Baixar nova versÃ£o
if wget -q "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64" -O bin/xmrig.new; then
    mv bin/xmrig bin/xmrig.old
    mv bin/xmrig.new bin/xmrig
    chmod +x bin/xmrig
    
    echo "âœ… XMRig atualizado!"
    
    # Testar nova versÃ£o
    if ./bin/xmrig --help >/dev/null 2>&1; then
        rm -f bin/xmrig.old
        echo "âœ… Nova versÃ£o testada e funcional"
    else
        echo "âš ï¸ Nova versÃ£o com problemas, revertendo..."
        mv bin/xmrig.old bin/xmrig
    fi
else
    echo "âŒ Falha ao baixar atualizaÃ§Ã£o"
fi

# Restaurar configuraÃ§Ã£o
mv config/config_backup.json config/config.json 2>/dev/null

echo ""
echo "Para iniciar: ./start.sh"
EOF

    # ==================== BACKUP.SH ====================
    cat > backup.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

cd "$HOME/bitcoin_miner_termux"

BACKUP_FILE="$HOME/backup_miner_$(date +%Y%m%d_%H%M%S).tar.gz"

echo "ðŸ’¾ Criando backup..."
echo ""

# Parar mineraÃ§Ã£o primeiro
./stop.sh >/dev/null 2>&1
sleep 2

# Criar backup
tar -czf "$BACKUP_FILE" config/ logs/ stats/ 2>/dev/null

if [ $? -eq 0 ]; then
    echo "âœ… Backup criado: $BACKUP_FILE"
    echo "Tamanho: $(du -h "$BACKUP_FILE" | cut -f1)"
else
    echo "âŒ Falha ao criar backup"
fi

echo ""
echo "Para restaurar:"
echo "  tar -xzf $BACKUP_FILE -C $HOME/bitcoin_miner_termux/"
EOF

    # Dar permissÃµes a todos os scripts
    chmod +x *.sh
    chmod +x scripts/*.sh 2>/dev/null
    
    # Salvar wallet
    echo "$WALLET" > "$CONFIG_DIR/wallet.txt"
    
    # Salvar Discord webhook se fornecido
    if [ ! -z "$DISCORD_WEBHOOK" ]; then
        echo "$DISCORD_WEBHOOK" > "$CONFIG_DIR/discord_webhook.txt"
    fi
    
    print_success "Scripts de controle criados"
}

setup_autostart() {
    print_step "Configurando auto-inicializaÃ§Ã£o..."
    
    # Adicionar ao .bashrc
    if ! grep -q "bitcoin_miner_termux" ~/.bashrc; then
        cat >> ~/.bashrc << EOF

# Auto-start do minerador Bitcoin
if [ -f "$HOME/bitcoin_miner_termux/start.sh" ] && [ ! -f /tmp/miner_started ]; then
    echo "âš¡ Iniciando minerador Bitcoin..."
    cd "$HOME/bitcoin_miner_termux"
    nohup ./scripts/monitor_daemon.sh >/dev/null 2>&1 &
    sleep 5
    ./start.sh >/dev/null 2>&1 &
    touch /tmp/miner_started
fi

# Aliases Ãºteis
alias miner='cd $HOME/bitcoin_miner_termux && ./status.sh'
alias miner_start='cd $HOME/bitcoin_miner_termux && ./start.sh'
alias miner_stop='cd $HOME/bitcoin_miner_termux && ./stop.sh'
alias miner_logs='cd $HOME/bitcoin_miner_termux && ./logs.sh'
alias miner_monitor='cd $HOME/bitcoin_miner_termux && ./monitor.sh'
EOF
        print_success "Auto-inicializaÃ§Ã£o configurada"
    else
        print_info "Auto-inicializaÃ§Ã£o jÃ¡ configurada"
    fi
}

# ============================================================================
# FUNÃ‡ÃƒO DE INSTALAÃ‡ÃƒO PRINCIPAL
# ============================================================================

install_system_complete() {
    print_banner
    
    echo -e "${CYAN}Este script instalarÃ¡ o minerador Bitcoin completo:${NC}"
    echo ""
    echo "âœ… DependÃªncias do Termux"
    echo "âœ… XMRig 6.20.0 (minerador)"
    echo "âœ… ConfiguraÃ§Ã£o automÃ¡tica"
    echo "âœ… Scripts de controle"
    echo "âœ… Sistema de monitoramento"
    echo "âœ… Auto-inicializaÃ§Ã£o"
    echo ""
    echo -e "${YELLOW}âš ï¸  Conecte ao carregador para melhor desempenho${NC}"
    echo ""
    
    read -p "Continuar com a instalaÃ§Ã£o? (s/n): " choice
    if [ "$choice" != "s" ]; then
        echo "InstalaÃ§Ã£o cancelada"
        exit 0
    fi
    
    # Executar etapas de instalaÃ§Ã£o
    check_termux
    check_internet || exit 1
    check_root
    
    install_dependencies
    create_directories
    install_xmrig || { print_error "Falha crÃ­tica na instalaÃ§Ã£o do XMRig"; exit 1; }
    create_configuration
    create_control_scripts
    setup_autostart
    
    # Iniciar monitor automÃ¡tico
    cd "$MINER_DIR"
    ./scripts/install_monitor.sh >/dev/null 2>&1 &
    
    print_banner
    echo -e "${GREEN}âœ…âœ…âœ… INSTALAÃ‡ÃƒO COMPLETA COM SUCESSO! âœ…âœ…âœ…${NC}"
    echo ""
    echo -e "${CYAN}ðŸ“ DIRETÃ“RIO:${NC} $MINER_DIR"
    echo -e "${CYAN}ðŸ’° CARTEIRA:${NC} $WALLET"
    echo -e "${CYAN}ðŸ‘· WORKER:${NC} $(cat $CONFIG_DIR/worker_name.txt)"
    echo -e "${CYAN}âš¡ XMRIG:${NC} $(./bin/xmrig --version 2>/dev/null | head -1 || echo '6.20.0')"
    echo ""
    echo -e "${CYAN}ðŸŽ¯ COMANDOS DISPONÃVEIS:${NC}"
    echo "  miner        - Ver status (alias)"
    echo "  miner_start  - Iniciar mineraÃ§Ã£o"
    echo "  miner_stop   - Parar mineraÃ§Ã£o"
    echo "  miner_logs   - Ver logs"
    echo "  miner_monitor - Monitor em tempo real"
    echo ""
    echo -e "${CYAN}ðŸ“Š OU:${NC}"
    echo "  cd $MINER_DIR"
    echo "  ./status.sh   - Ver status"
    echo "  ./start.sh    - Iniciar"
    echo "  ./stop.sh     - Parar"
    echo "  ./monitor.sh  - Monitor"
    echo ""
    echo -e "${YELLOW}âš ï¸  O sistema iniciarÃ¡ automaticamente ao abrir o Termux${NC}"
    echo ""
    
    # Perguntar se quer iniciar agora
    read -p "Iniciar mineraÃ§Ã£o agora? (s/n): " start_now
    if [ "$start_now" = "s" ]; then
        cd "$MINER_DIR"
        ./start.sh
    fi
    
    log_event "Sistema instalado com sucesso"
}

# ============================================================================
# MENU PRINCIPAL
# ============================================================================

show_main_menu() {
    while true; do
        print_banner
        
        if [ -d "$MINER_DIR" ] && [ -f "$BIN_DIR/xmrig" ]; then
            echo -e "${GREEN}âœ… SISTEMA INSTALADO${NC}"
            echo ""
            
            # Status rÃ¡pido
            if pgrep -f xmrig >/dev/null; then
                echo -e "   ${GREEN}â›ï¸  MINERAÃ‡ÃƒO ATIVA${NC}"
            else
                echo -e "   ${YELLOW}â›ï¸  MINERAÃ‡ÃƒO INATIVA${NC}"
            fi
            
            echo ""
            echo -e "${CYAN}MENU PRINCIPAL:${NC}"
            echo ""
            echo "1) ðŸš€ Iniciar MineraÃ§Ã£o"
            echo "2) ðŸ“Š Ver Status Completo"
            echo "3) ðŸ“‹ Ver Logs"
            echo "4) ðŸ“ˆ Monitor em Tempo Real"
            echo "5) ðŸ›‘ Parar MineraÃ§Ã£o"
            echo "6) ðŸ”„ Reiniciar Sistema"
            echo "7) âš™ï¸  ConfiguraÃ§Ãµes"
            echo "8) ðŸ—‘ï¸  Desinstalar Tudo"
            echo "9) âŒ Sair"
            echo ""
            
            read -p "Escolha (1-9): " choice
            
            case $choice in
                1)
                    cd "$MINER_DIR"
                    ./start.sh
                    read -p "Pressione Enter para continuar..."
                    ;;
                2)
                    cd "$MINER_DIR"
                    ./status.sh
                    ;;
                3)
                    cd "$MINER_DIR"
                    ./logs.sh
                    ;;
                4)
                    cd "$MINER_DIR"
                    ./monitor.sh
                    ;;
                5)
                    cd "$MINER_DIR"
                    ./stop.sh
                    sleep 2
                    read -p "Pressione Enter para continuar..."
                    ;;
                6)
                    cd "$MINER_DIR"
                    ./restart.sh
                    read -p "Pressione Enter para continuar..."
                    ;;
                7)
                    show_config_menu
                    ;;
                8)
                    uninstall_system
                    ;;
                9)
                    echo "ðŸ‘‹ Saindo..."
                    exit 0
                    ;;
                *)
                    echo "OpÃ§Ã£o invÃ¡lida!"
                    sleep 1
                    ;;
            esac
        else
            echo -e "${YELLOW}âš ï¸  SISTEMA NÃƒO INSTALADO${NC}"
            echo ""
            echo "Deseja instalar o minerador Bitcoin completo?"
            echo ""
            read -p "Instalar agora? (s/n): " install_choice
            
            if [ "$install_choice" = "s" ]; then
                install_system_complete
            else
                echo "ðŸ‘‹ Saindo..."
                exit 0
            fi
        fi
    done
}

show_config_menu() {
    while true; do
        clear
        echo -e "${CYAN}âš™ï¸  CONFIGURAÃ‡Ã•ES${NC}"
        echo ""
        echo "1) Alterar Carteira"
        echo "2) Configurar Discord Webhook"
        echo "3) Atualizar XMRig"
        echo "4) Criar Backup"
        echo "5) Restaurar Backup"
        echo "6) Ver InformaÃ§Ãµes do Sistema"
        echo "7) Voltar"
        echo ""
        
        read -p "Escolha: " choice
        
        case $choice in
            1)
                echo ""
                read -p "Nova carteira: " new_wallet
                if [ ! -z "$new_wallet" ]; then
                    echo "$new_wallet" > "$CONFIG_DIR/wallet.txt"
                    echo "âœ… Carteira atualizada"
                fi
                sleep 2
                ;;
            2)
                echo ""
                read -p "Webhook Discord (deixe vazio para remover): " webhook
                echo "$webhook" > "$CONFIG_DIR/discord_webhook.txt"
                echo "âœ… Webhook atualizado"
                sleep 2
                ;;
            3)
                cd "$MINER_DIR"
                ./update.sh
                read -p "Pressione Enter para continuar..."
                ;;
            4)
                cd "$MINER_DIR"
                ./backup.sh
                read -p "Pressione Enter para continuar..."
                ;;
            5)
                echo ""
                echo "Backups disponÃ­veis:"
                ls -lh ~/backup_miner_*.tar.gz 2>/dev/null || echo "  Nenhum backup encontrado"
                echo ""
                read -p "Nome do arquivo para restaurar: " backup_file
                if [ -f "$backup_file" ]; then
                    tar -xzf "$backup_file" -C "$MINER_DIR/"
                    echo "âœ… Backup restaurado"
                else
                    echo "âŒ Arquivo nÃ£o encontrado"
                fi
                sleep 2
                ;;
            6)
                clear
                echo "=== INFORMAÃ‡Ã•ES DO SISTEMA ==="
                echo ""
                echo "ðŸ“ DiretÃ³rio: $MINER_DIR"
                echo "ðŸ’° Carteira: $(cat $CONFIG_DIR/wallet.txt 2>/dev/null || echo 'NÃ£o configurada')"
                echo "ðŸ‘· Worker: $(cat $CONFIG_DIR/worker_name.txt 2>/dev/null || echo 'Desconhecido')"
                echo "âš¡ XMRig: $($BIN_DIR/xmrig --version 2>/dev/null | head -1 || echo 'NÃ£o encontrado')"
                echo "ðŸ“Š Shares aceitos: $(grep -c "accepted" $LOGS_DIR/miner.log 2>/dev/null || echo '0')"
                echo ""
                read -p "Pressione Enter para continuar..."
                ;;
            7)
                return 0
                ;;
            *)
                echo "OpÃ§Ã£o invÃ¡lida!"
                sleep 1
                ;;
        esac
    done
}

uninstall_system() {
    clear
    echo -e "${RED}âš ï¸  DESINSTALAR COMPLETAMENTE?${NC}"
    echo ""
    echo "Isso removerÃ¡:"
    echo "â€¢ Todo o diretÃ³rio $MINER_DIR"
    echo "â€¢ ConfiguraÃ§Ãµes e logs"
    echo "â€¢ Auto-inicializaÃ§Ã£o"
    echo ""
    read -p "Tem certeza? (s/n): " confirm
    
    if [ "$confirm" = "s" ]; then
        # Parar tudo
        cd "$MINER_DIR" 2>/dev/null && ./stop.sh >/dev/null 2>&1
        
        # Remover diretÃ³rio
        rm -rf "$MINER_DIR"
        
        # Remover do .bashrc
        sed -i '/bitcoin_miner_termux/,/^fi$/d' ~/.bashrc 2>/dev/null
        sed -i '/alias miner/d' ~/.bashrc 2>/dev/null
        
        echo "âœ… Sistema completamente removido!"
        sleep 2
        exit 0
    fi
}

# ============================================================================
# INICIAR SISTEMA
# ============================================================================

# Executar menu principal
show_main_menu.
