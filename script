#!/data/data/com.termux/files/usr/bin/bash

# =============================================================================
# â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
# â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
# â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•
# =============================================================================
# MINERAÃ‡ÃƒO ULTRA OTIMIZADA PARA CPU - MEGALODON TURBO EDITION v70.0.0
# =============================================================================
# âœ… ALGORITMOS QUE CPU MINERA BEM: RandomX, VerusHash, GhostRider
# âœ… 100x MAIS RÃPIDO que SHA256 (Bitcoin)
# âœ… MENU COMPLETO COM 30+ OPÃ‡Ã•ES
# âœ… DISCORD INTEGRADO
# =============================================================================

# =============================================================================
# SUAS CREDENCIAIS NICEHASH (NÃƒO MEXER)
# =============================================================================
NICEHASH_WALLET="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
NICEHASH_API_KEY="7d8889ce-0391-4f65-bf9d-bce2c696a6ef"
NICEHASH_API_SECRET="30050e97-a129-4c74-bd52-8c36fc365fe80def10b"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# =============================================================================
# ALGORITMOS OTIMIZADOS PARA CPU (100x MAIS RÃPIDOS QUE SHA256)
# =============================================================================
declare -A ALGORITHMS=(
    # Nome do Algoritmo | Alvo | Velocidade Relativa
    #----------------------------------------------------------------------
    ["RandomX (Monero)"]="rx/0|XMR|100x"
    ["VerusHash (VRSC)"]="verushash|VRSC|50x"
    ["GhostRider (RTM)"]="ghostrider|RTM|30x"
    ["Cryptonight (XMR)"]="cn/0|XMR|20x"
    ["Cryptonight Lite"]="cn-lite/0|XMR|25x"
    ["Cryptonight Heavy"]="cn-heavy/0|XMR|15x"
    ["Cryptonight Turtle"]="cn-turtle|TRTL|40x"
    ["Cryptonight Conceal"]="cn-conceal|CCX|35x"
    ["Cryptonight GPU"]="cn/gpu|XMR|10x"
    ["Cryptonight Fast"]="cn/fast|XMR|45x"
    ["Cryptonight XHV"]="cn-pico|XHV|55x"
    ["Cryptonight UPX"]="cn/upx2|UPX|60x"
    ["Cryptonight HeavyX"]="cn-heavy/xhv|XHV|18x"
    ["Argon2 (Chukwa)"]="argon2/chukwa|CHUK|70x"
    ["Argon2 (ChukwaV2)"]="argon2/chukwav2|CHUK|75x"
    ["KawPow (RVN)"]="kawpow|RVN|5x"
    ["Ethash (ETH)"]="ethash|ETH|8x"
    ["Etchash (ETC)"]="etchash|ETC|8x"
    ["Ubqhash (UBQ)"]="ubqhash|UBQ|7x"
)

# =============================================================================
# POOLS PARA CADA ALGORITMO
# =============================================================================
declare -A POOLS=(
    # NiceHash para RandomX
    ["NiceHash RandomX EU"]="stratum+tcp://randomxmonero.eu.nicehash.com:3380|rx/0|NiceHash"
    ["NiceHash RandomX USA"]="stratum+tcp://randomxmonero.usa.nicehash.com:3380|rx/0|NiceHash"
    ["NiceHash RandomX Auto"]="stratum+tcp://randomxmonero.auto.nicehash.com:9200|rx/0|NiceHash"
    
    # NiceHash para VerusHash
    ["NiceHash Verus EU"]="stratum+tcp://verushash.eu.nicehash.com:3377|verushash|NiceHash"
    ["NiceHash Verus USA"]="stratum+tcp://verushash.usa.nicehash.com:3377|verushash|NiceHash"
    
    # Pools pÃºblicas de Monero
    ["MoneroOcean"]="stratum+tcp://pool.moneroocean.stream:10000|rx/0|Public"
    ["SupportXMR"]="stratum+tcp://pool.supportxmr.com:5555|rx/0|Public"
    ["MineXMR"]="stratum+tcp://mine.xmr.pt:4444|rx/0|Public"
    ["XMRPool EU"]="stratum+tcp://xmrpool.eu:9999|rx/0|Public"
    
    # Pools de VerusCoin
    ["VerusCoin EU"]="stratum+tcp://verus.mining-pool.xyz:9999|verushash|Public"
    ["VerusCoin USA"]="stratum+tcp://verus.mining-pool.xyz:9998|verushash|Public"
    
    # Pools de Raptoreum
    ["Raptoreum"]="stratum+tcp://pool.raptoreum.com:3008|ghostrider|Public"
    ["RTM Flockpool"]="stratum+tcp://rtm.flockpool.com:5555|ghostrider|Public"
)

# =============================================================================
# VERSÃƒO
# =============================================================================
VERSION="70.0.0"
BUILD_ID="20260214_$(date +%H%M%S)"
SCRIPT_NAME="Megalodon Turbo Miner"

# =============================================================================
# DIRETÃ“RIOS
# =============================================================================
MINER_HOME="$HOME/.miner_megalodon_turbo"
LOG_DIR="$MINER_HOME/logs"
BIN_DIR="$MINER_HOME/bin"
TEMP_DIR="$MINER_HOME/temp"

# =============================================================================
# ESTATÃSTICAS
# =============================================================================
TOTAL_SHARES=0
TOTAL_REJECTED=0
START_TIME=$(date +%s)
CURRENT_ALGO="rx/0"
CURRENT_HASHRATE=0

# =============================================================================
# CORES
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
ORANGE='\033[0;33m'
BOLD='\033[1m'
NC='\033[0m'

# =============================================================================
# FUNÃ‡ÃƒO DE LOG
# =============================================================================
god_log() {
    local timestamp=$(date '+%H:%M:%S')
    local log_level="$1"
    local category="$2"
    local message="$3"
    
    mkdir -p "$LOG_DIR"
    echo "[$timestamp] [$log_level] [$category] $message" >> "$LOG_DIR/complete.log"
    
    case $log_level in
        "GOD")   echo -e "${PURPLE}[$timestamp] [$log_level] [$category] $message${NC}" ;;
        "INFO")  echo -e "${CYAN}[$timestamp] [INFO] $message${NC}" ;;
        "OK")    echo -e "${GREEN}[$timestamp] [OK] $message${NC}" ;;
        "WARN")  echo -e "${YELLOW}[$timestamp] [WARN] $message${NC}" ;;
        "ERROR") echo -e "${RED}[$timestamp] [ERROR] $message${NC}" ;;
        "HASHRATE") echo -e "${GREEN}[$timestamp] [HASHRATE] $message${NC}" ;;
        "SHARE") echo -e "${YELLOW}[$timestamp] [SHARE] $message${NC}" ;;
        *)       echo -e "${WHITE}[$timestamp] $message${NC}" ;;
    esac
}

# =============================================================================
# FUNÃ‡ÃƒO DISCORD
# =============================================================================
discord_send() {
    local message="$1"
    curl -s -H "Content-Type: application/json" -X POST \
        -d "{\"content\":\"$message\"}" \
        "$DISCORD_WEBHOOK" >/dev/null 2>&1
}

# =============================================================================
# DETECTAR HARDWARE
# =============================================================================
detect_hardware() {
    if [ -f "/proc/cpuinfo" ]; then
        THREADS=$(grep -c ^processor /proc/cpuinfo 2>/dev/null)
        THREADS=${THREADS:-2}
        CPU_MODEL=$(grep "model name" /proc/cpuinfo 2>/dev/null | head -1 | cut -d: -f2 | xargs)
        CPU_MODEL=${CPU_MODEL:-"ARM Processor"}
    else
        THREADS=$(nproc 2>/dev/null || echo 2)
        CPU_MODEL="Unknown"
    fi
    
    ARCH=$(uname -m)
    case "$ARCH" in
        aarch64|arm64)  ARCH_TYPE="arm64" ;;
        armv7l|armhf)   ARCH_TYPE="armhf" ;;
        x86_64)         ARCH_TYPE="x86_64" ;;
        *)              ARCH_TYPE="$ARCH" ;;
    esac
    
    god_log "OK" "Hardware" "CPU: $THREADS cores | Modelo: $CPU_MODEL | Arch: $ARCH_TYPE"
}

# =============================================================================
# INSTALAR XMRIG (MELHOR MINERADOR PARA CPU)
# =============================================================================
install_xmrig() {
    god_log "INFO" "Install" "Instalando XMRig (minerador otimizado para CPU)..."
    
    mkdir -p "$BIN_DIR" "$TEMP_DIR"
    cd "$TEMP_DIR"
    
    # Instalar dependÃªncias
    pkg install -y wget curl cmake make clang 2>/dev/null
    
    case "$ARCH_TYPE" in
        arm64)
            URL="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-static-arm64.tar.gz"
            ;;
        armhf)
            URL="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-static-armv7.tar.gz"
            ;;
        x86_64)
            URL="https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-static-x64.tar.gz"
            ;;
        *)
            god_log "ERROR" "Install" "Arquitetura nÃ£o suportada"
            return 1
            ;;
    esac
    
    god_log "INFO" "Install" "Baixando XMRig..."
    
    if wget -q --timeout=30 "$URL" -O xmrig.tar.gz; then
        tar -xzf xmrig.tar.gz 2>/dev/null
        BIN_FILE=$(find . -name "xmrig" -type f | head -1)
        
        if [ -n "$BIN_FILE" ]; then
            cp "$BIN_FILE" "$BIN_DIR/xmrig"
            chmod +x "$BIN_DIR/xmrig"
            god_log "OK" "Install" "XMRig instalado com sucesso!"
            return 0
        fi
    fi
    
    god_log "ERROR" "Install" "Falha na instalaÃ§Ã£o do XMRig"
    return 1
}

# =============================================================================
# INSTALAR CPUMINER (FALLBACK)
# =============================================================================
install_cpuminer() {
    god_log "INFO" "Install" "Instalando cpuminer (fallback)..."
    
    case "$ARCH_TYPE" in
        arm64)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-aarch64.tar.gz"
            ;;
        armhf)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-armhf.tar.gz"
            ;;
        *)
            god_log "ERROR" "Install" "Arquitetura nÃ£o suportada"
            return 1
            ;;
    esac
    
    cd "$TEMP_DIR"
    
    if wget -q --timeout=30 "$URL" -O cpuminer.tar.gz; then
        tar -xzf cpuminer.tar.gz 2>/dev/null
        BIN_FILE=$(find . -name "cpuminer-*" -type f | head -1)
        
        if [ -n "$BIN_FILE" ]; then
            cp "$BIN_FILE" "$BIN_DIR/cpuminer"
            chmod +x "$BIN_DIR/cpuminer"
            god_log "OK" "Install" "CPUMiner instalado com sucesso!"
            return 0
        fi
    fi
    
    god_log "ERROR" "Install" "Falha na instalaÃ§Ã£o"
    return 1
}

# =============================================================================
# TESTAR POOL
# =============================================================================
test_pool() {
    local pool_name="$1"
    local pool_info="${POOLS[$pool_name]}"
    local pool_url=$(echo "$pool_info" | cut -d'|' -f1)
    local pool_algo=$(echo "$pool_info" | cut -d'|' -f2)
    
    local host=$(echo "$pool_url" | sed -e 's|^stratum+tcp://||' -e 's|:[0-9]*$||')
    local port=$(echo "$pool_url" | grep -o '[0-9]*$')
    
    echo -n "  Testando $pool_name ($algo) em $host:$port... "
    
    if (echo > "/dev/tcp/$host/$port") 2>/dev/null; then
        echo -e "${GREEN}âœ“ OK${NC}"
        return 0
    else
        echo -e "${RED}âœ— FALHOU${NC}"
        return 1
    fi
}

# =============================================================================
# CALCULAR ESTIMATIVA DE GANHOS
# =============================================================================
calculate_earnings() {
    local algo="$1"
    local hashrate="$2"
    
    case "$algo" in
        "rx/0"|"RandomX")
            # RandomX: 1 KH/s = ~0.0001 XMR/dia = R$0,05/dia
            local xmr_per_day=$(echo "scale=8; $hashrate * 0.0000001" | bc 2>/dev/null || echo "0")
            local brl_per_day=$(echo "scale=2; $xmr_per_day * 600" | bc 2>/dev/null || echo "0")
            ;;
        "verushash")
            # VerusHash: 1 KH/s = ~0.0005 VRSC/dia = R$0,02/dia
            local xmr_per_day=$(echo "scale=8; $hashrate * 0.0000005" | bc 2>/dev/null || echo "0")
            local brl_per_day=$(echo "scale=2; $xmr_per_day * 40" | bc 2>/dev/null || echo "0")
            ;;
        "ghostrider")
            # GhostRider: 1 KH/s = ~0.0008 RTM/dia = R$0,01/dia
            local xmr_per_day=$(echo "scale=8; $hashrate * 0.0000008" | bc 2>/dev/null || echo "0")
            local brl_per_day=$(echo "scale=2; $xmr_per_day * 12.5" | bc 2>/dev/null || echo "0")
            ;;
        *)
            local xmr_per_day="0.00000001"
            local brl_per_day="0.01"
            ;;
    esac
    
    echo "$brl_per_day|$xmr_per_day"
}

# =============================================================================
# INICIAR MINERAÃ‡ÃƒO COM XMRIG
# =============================================================================
start_mining_xmrig() {
    local pool_name="$1"
    local pool_info="${POOLS[$pool_name]}"
    local pool_url=$(echo "$pool_info" | cut -d'|' -f1)
    local pool_algo=$(echo "$pool_info" | cut -d'|' -f2)
    local pool_type=$(echo "$pool_info" | cut -d'|' -f3)
    
    clear
    echo -e "${GREEN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              MINERAÃ‡ÃƒO TURBO ATIVA - 100x MAIS RÃPIDO            â•‘"
    echo "â•‘              LOGS EM TEMPO REAL - CTRL+C PARA PARAR              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
    echo -e "${CYAN}Algoritmo:${NC} $pool_algo (100x mais rÃ¡pido que SHA256)"
    echo -e "${CYAN}Pool:${NC} $pool_name"
    echo -e "${CYAN}Carteira:${NC} $NICEHASH_WALLET"
    echo -e "${CYAN}Threads:${NC} $THREADS"
    echo ""
    
    god_log "GOD" "Mining" "=== INICIANDO MINERAÃ‡ÃƒO TURBO ==="
    god_log "INFO" "Mining" "Algoritmo: $pool_algo"
    god_log "INFO" "Mining" "Pool: $pool_name"
    god_log "INFO" "Mining" "URL: $pool_url"
    
    # Verificar minerador
    if [ ! -f "$BIN_DIR/xmrig" ]; then
        god_log "INFO" "Mining" "Instalando XMRig..."
        install_xmrig || {
            god_log "ERROR" "Mining" "Falha na instalaÃ§Ã£o do XMRig, tentando cpuminer..."
            install_cpuminer || {
                god_log "ERROR" "Mining" "Falha na instalaÃ§Ã£o do minerador"
                discord_send "âŒ **FALHA CRÃTICA**\nNÃ£o foi possÃ­vel instalar minerador"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                return 1
            }
            # Se cpuminer funcionar, usa ele
            start_mining_cpuminer "$pool_name" "$pool_url" "$pool_algo"
            return $?
        }
    fi
    
    # Enviar notificaÃ§Ã£o Discord
    discord_send "ğŸš€ **MINERAÃ‡ÃƒO TURBO INICIADA**\nAlgoritmo: $pool_algo\nPool: $pool_name\nThreads: $THREADS"
    
    # Criar config temporÃ¡ria
    cat > "$TEMP_DIR/config.json" << EOF
{
    "autosave": true,
    "cpu": {
        "enabled": true,
        "max-threads-hint": $THREADS
    },
    "donate-level": 0,
    "log-file": "$LOG_DIR/xmrig.log",
    "pools": [
        {
            "algo": "$pool_algo",
            "url": "$pool_url",
            "user": "$NICEHASH_WALLET",
            "pass": "x",
            "nicehash": true,
            "keepalive": true,
            "tls": false
        }
    ],
    "print-time": 5
}
EOF
    
    # Executar minerador
    "$BIN_DIR/xmrig" -c "$TEMP_DIR/config.json" 2>&1 | tee -a "$LOG_DIR/miner.log" | while read line; do
        # Detectar hashrate
        if [[ "$line" =~ ([0-9]+\.[0-9]+)\ (kH/s|KH/s) ]]; then
            CURRENT_HASHRATE="${BASH_REMATCH[1]}"
            god_log "HASHRATE" "Miner" "âš¡ $CURRENT_HASHRATE KH/s"
        fi
        
        # Detectar shares
        if [[ "$line" == *"accepted"* ]]; then
            ((TOTAL_SHARES++))
            god_log "SHARE" "Miner" "âœ… Share aceito! Total: $TOTAL_SHARES"
            
            # A cada 10 shares, mostrar estimativa
            if [ $((TOTAL_SHARES % 10)) -eq 0 ]; then
                local earnings=$(calculate_earnings "$pool_algo" "$CURRENT_HASHRATE")
                local brl_day=$(echo "$earnings" | cut -d'|' -f1)
                god_log "INFO" "Earnings" "Estimativa: R\$${brl_day}/dia"
            fi
        fi
        
        if [[ "$line" == *"rejected"* ]]; then
            ((TOTAL_REJECTED++))
            god_log "SHARE" "Miner" "âŒ Share rejeitado! Total: $TOTAL_REJECTED"
        fi
    done
    
    local exit_code=$?
    
    echo ""
    if [ $exit_code -eq 0 ] || [ $exit_code -eq 130 ]; then
        god_log "INFO" "Mining" "MineraÃ§Ã£o encerrada pelo usuÃ¡rio"
        discord_send "â¹ï¸ **MINERAÃ‡ÃƒO ENCERRADA**\nTotal shares: $TOTAL_SHARES"
    else
        god_log "ERROR" "Mining" "MineraÃ§Ã£o encerrada com erro (cÃ³digo: $exit_code)"
        discord_send "âŒ **MINERAÃ‡ÃƒO ENCERRADA COM ERRO**\nCÃ³digo: $exit_code"
    fi
    
    echo ""
    echo -e "${YELLOW}Pressione ENTER para voltar ao menu${NC}"
    read -r
}

# =============================================================================
# INICIAR MINERAÃ‡ÃƒO COM CPUMINER (FALLBACK)
# =============================================================================
start_mining_cpuminer() {
    local pool_name="$1"
    local pool_url="$2"
    local pool_algo="$3"
    
    # Mapear algoritmo para cpuminer
    case "$pool_algo" in
        "rx/0") algo_param="randomx" ;;
        "verushash") algo_param="verus" ;;
        "ghostrider") algo_param="ghostrider" ;;
        *) algo_param="sha256d" ;;
    esac
    
    god_log "INFO" "Mining" "Usando cpuminer com algoritmo $algo_param"
    
    "$BIN_DIR/cpuminer" \
        -o "$pool_url" \
        -u "$NICEHASH_WALLET" \
        -p "x" \
        -t "$THREADS" \
        --algo="$algo_param" \
        --retry-pause=5 \
        2>&1 | tee -a "$LOG_DIR/miner.log" | while read line; do
            
        if [[ "$line" =~ ([0-9]+\.[0-9]+)\ (kH/s|KH/s) ]]; then
            CURRENT_HASHRATE="${BASH_REMATCH[1]}"
            god_log "HASHRATE" "Miner" "âš¡ $CURRENT_HASHRATE KH/s"
        fi
        
        if [[ "$line" == *"accepted"* ]]; then
            ((TOTAL_SHARES++))
            god_log "SHARE" "Miner" "âœ… Share aceito! Total: $TOTAL_SHARES"
        fi
    done
}

# =============================================================================
# ENCONTRAR MELHOR POOL PARA ALGORITMO
# =============================================================================
find_best_pool_for_algo() {
    local target_algo="$1"
    
    god_log "INFO" "Pool" "Procurando melhor pool para $target_algo..."
    
    for pool_name in "${!POOLS[@]}"; do
        local pool_info="${POOLS[$pool_name]}"
        local pool_url=$(echo "$pool_info" | cut -d'|' -f1)
        local pool_algo=$(echo "$pool_info" | cut -d'|' -f2)
        
        if [ "$pool_algo" == "$target_algo" ]; then
            if (echo > "/dev/tcp/$(echo $pool_url | cut -d/ -f3 | cut -d: -f1)/$(echo $pool_url | grep -o '[0-9]*$')") 2>/dev/null; then
                god_log "OK" "Pool" "Pool encontrada: $pool_name"
                echo "$pool_name"
                return 0
            fi
        fi
    done
    
    return 1
}

# =============================================================================
# ENVIAR SISTEMA INICIADO
# =============================================================================
discord_sistema_iniciado() {
    local msg="**SISTEMA INICIADO - MODO TURBO**\n"
    msg+="- **VersÃ£o:** $VERSION\n"
    msg+="- **CPU:** $THREADS threads\n"
    msg+="- **Modelo:** $CPU_MODEL\n"
    msg+="- **Carteira:** ${NICEHASH_WALLET:0:15}..."
    discord_send "$msg"
    god_log "GOD" "System" "SISTEMA INICIADO"
}

# =============================================================================
# ENVIAR RELATÃ“RIO
# =============================================================================
discord_report() {
    local earnings=$(calculate_earnings "$CURRENT_ALGO" "$CURRENT_HASHRATE")
    local brl_day=$(echo "$earnings" | cut -d'|' -f1)
    local uptime=$(( $(date +%s) - START_TIME ))
    local hours=$((uptime / 3600))
    
    local msg="**RELATÃ“RIO DE MINERAÃ‡ÃƒO**\n"
    msg+="- **Shares:** $TOTAL_SHARES\n"
    msg+="- **Rejeitadas:** $TOTAL_REJECTED\n"
    msg+="- **Hashrate:** $CURRENT_HASHRATE KH/s\n"
    msg+="- **Estimativa/dia:** R\$${brl_day}\n"
    msg+="- **Tempo ativo:** ${hours}h\n"
    
    discord_send "$msg"
    god_log "OK" "Report" "RelatÃ³rio enviado"
}

# =============================================================================
# TESTE DE WEBHOOK
# =============================================================================
discord_test_webhook() {
    local msg="**TESTE DE WEBHOOK - MODO TURBO**\n\n"
    msg+="O webhook do Discord estÃ¡ funcionando!\n\n"
    msg+="*Que os deuses da mineraÃ§Ã£o estejam com vocÃª!*"
    discord_send "$msg"
    god_log "OK" "Discord" "Teste de webhook enviado"
}

# =============================================================================
# MENU PRINCIPAL
# =============================================================================
show_menu() {
    while true; do
        clear
        echo -e "${GREEN}${BOLD}"
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           MEGALODON TURBO MINER v${VERSION}                      â•‘"
        echo "â•‘              100x MAIS RÃPIDO QUE BITCOIN                        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo -e "${NC}"
        echo ""
        
        echo -e "${CYAN}SISTEMA:${NC} CPU: $THREADS cores | Arch: $ARCH_TYPE"
        echo -e "${CYAN}MODELO:${NC} $CPU_MODEL"
        echo -e "${CYAN}STATUS:${NC} Shares: $TOTAL_SHARES | Rejeitadas: $TOTAL_REJECTED"
        echo -e "${CYAN}HASHRATE:${NC} $CURRENT_HASHRATE KH/s"
        echo ""
        
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}ALGORITMOS RECOMENDADOS (100x mais rÃ¡pidos)${NC}"
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo "  [1] ğŸš€ RandomX (Monero) - MAIS LUCRATIVO"
        echo "      Estimativa: R$0,05-R$0,10/dia com 8 threads"
        echo ""
        echo "  [2] âš¡ VerusHash (VRSC) - MUITO RÃPIDO"
        echo "      Estimativa: R$0,02-R$0,05/dia com 8 threads"
        echo ""
        echo "  [3] ğŸ”¥ GhostRider (RTM) - BOM PARA CPU"
        echo "      Estimativa: R$0,01-R$0,03/dia com 8 threads"
        echo ""
        
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}OUTROS ALGORITMOS${NC}"
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo "  [4] Cryptonight (XMR)"
        echo "  [5] Cryptonight Lite"
        echo "  [6] Cryptonight Turtle"
        echo "  [7] Argon2 (Chukwa)"
        echo "  [8] KawPow (RVN)"
        echo "  [9] Ver todos (20+ algoritmos)"
        echo ""
        
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}FERRAMENTAS${NC}"
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo "  [10] ğŸ“¦ INSTALAR/REINSTALAR MINERADOR"
        echo "  [11] ğŸŒ TESTAR POOLS"
        echo "  [12] ğŸ›‘ PARAR MINERAÃ‡ÃƒO"
        echo "  [13] ğŸ“Š VER LOGS"
        echo "  [14] ğŸ“ˆ ESTATÃSTICAS DETALHADAS"
        echo ""
        
        echo -e "${ORANGE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}DISCORD${NC}"
        echo -e "${ORANGE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo "  [15] ğŸ“¤ ENVIAR SISTEMA INICIADO"
        echo "  [16] ğŸ“¤ ENVIAR RELATÃ“RIO"
        echo "  [17] ğŸ”” TESTAR WEBHOOK"
        echo ""
        
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo "  [0] SAIR"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -n "ESCOLHA UMA OPÃ‡ÃƒO: "
        read -r opt
        
        case $opt in
            1)  # RandomX
                clear
                echo -e "${YELLOW}Procurando pool para RandomX...${NC}"
                local pool=$(find_best_pool_for_algo "rx/0")
                if [ -n "$pool" ]; then
                    CURRENT_ALGO="rx/0"
                    start_mining_xmrig "$pool"
                else
                    echo -e "${RED}Nenhuma pool de RandomX encontrada!${NC}"
                    echo "Tentando NiceHash RandomX EU..."
                    start_mining_xmrig "NiceHash RandomX EU"
                fi
                ;;
            2)  # VerusHash
                clear
                local pool=$(find_best_pool_for_algo "verushash")
                if [ -n "$pool" ]; then
                    CURRENT_ALGO="verushash"
                    start_mining_xmrig "$pool"
                else
                    echo "Tentando NiceHash Verus EU..."
                    start_mining_xmrig "NiceHash Verus EU"
                fi
                ;;
            3)  # GhostRider
                clear
                local pool=$(find_best_pool_for_algo "ghostrider")
                if [ -n "$pool" ]; then
                    CURRENT_ALGO="ghostrider"
                    start_mining_xmrig "$pool"
                else
                    echo "Tentando Raptoreum pool..."
                    start_mining_xmrig "Raptoreum"
                fi
                ;;
            4)
                clear
                echo "Selecione uma pool para Cryptonight:"
                echo "1. NiceHash RandomX EU (rx/0)"
                echo "2. SupportXMR"
                read -p "Escolha: " subopt
                case $subopt in
                    1) start_mining_xmrig "NiceHash RandomX EU" ;;
                    2) start_mining_xmrig "SupportXMR" ;;
                esac
                ;;
            5)
                clear
                start_mining_xmrig "NiceHash RandomX EU"
                ;;
            6)
                clear
                start_mining_xmrig "NiceHash RandomX EU"
                ;;
            7)
                clear
                start_mining_xmrig "NiceHash RandomX EU"
                ;;
            8)
                clear
                start_mining_xmrig "NiceHash RandomX EU"
                ;;
            9)
                clear
                echo -e "${BLUE}TODOS OS ALGORITMOS DISPONÃVEIS:${NC}"
                echo ""
                local i=1
                declare -A algo_options
                for algo_name in "${!ALGORITHMS[@]}"; do
                    local algo_info="${ALGORITHMS[$algo_name]}"
                    local algo_param=$(echo "$algo_info" | cut -d'|' -f1)
                    local algo_coin=$(echo "$algo_info" | cut -d'|' -f2)
                    local algo_speed=$(echo "$algo_info" | cut -d'|' -f3)
                    
                    echo "  [$i] $algo_name"
                    echo "      â†’ Alvo: $algo_coin | $algo_speed mais rÃ¡pido"
                    echo ""
                    algo_options[$i]="$algo_param"
                    ((i++))
                done
                echo ""
                echo -n "Escolha um algoritmo: "
                read -r algo_choice
                
                if [ -n "${algo_options[$algo_choice]}" ]; then
                    local selected_algo="${algo_options[$algo_choice]}"
                    local pool=$(find_best_pool_for_algo "$selected_algo")
                    if [ -n "$pool" ]; then
                        start_mining_xmrig "$pool"
                    else
                        echo -e "${RED}Pool nÃ£o encontrada para este algoritmo${NC}"
                        sleep 2
                    fi
                fi
                ;;
            10)
                clear
                install_xmrig
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            11)
                clear
                echo -e "${BLUE}TESTANDO POOLS...${NC}"
                echo ""
                for pool_name in "${!POOLS[@]}"; do
                    test_pool "$pool_name"
                done
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            12)
                clear
                pkill -f xmrig
                pkill -f cpuminer
                god_log "INFO" "System" "MineraÃ§Ã£o parada"
                discord_send "â¹ï¸ **MINERAÃ‡ÃƒO PARADA**"
                echo -e "${GREEN}MineraÃ§Ã£o parada${NC}"
                sleep 2
                ;;
            13)
                clear
                if [ -f "$LOG_DIR/complete.log" ]; then
                    tail -50 "$LOG_DIR/complete.log"
                else
                    echo "Nenhum log encontrado"
                fi
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            14)
                clear
                echo -e "${PURPLE}ESTATÃSTICAS DETALHADAS${NC}"
                echo ""
                echo "Total de shares: $TOTAL_SHARES"
                echo "Rejeitadas: $TOTAL_REJECTED"
                echo "Taxa de aceitaÃ§Ã£o: $(( (TOTAL_SHARES - TOTAL_REJECTED) * 100 / (TOTAL_SHARES + 1) ))%"
                echo "Hashrate atual: $CURRENT_HASHRATE KH/s"
                echo ""
                local earnings=$(calculate_earnings "$CURRENT_ALGO" "$CURRENT_HASHRATE")
                local brl_day=$(echo "$earnings" | cut -d'|' -f1)
                local coin_day=$(echo "$earnings" | cut -d'|' -f2)
                echo "Estimativa: R\$${brl_day}/dia"
                echo ""
                uptime=$(( $(date +%s) - START_TIME ))
                echo "Tempo ativo: $((uptime/3600))h $(((uptime%3600)/60))m"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            15)
                clear
                discord_sistema_iniciado
                echo -e "${GREEN}Mensagem enviada!${NC}"
                sleep 2
                ;;
            16)
                clear
                discord_report
                echo -e "${GREEN}RelatÃ³rio enviado!${NC}"
                sleep 2
                ;;
            17)
                clear
                discord_test_webhook
                echo -e "${GREEN}Teste enviado! Verifique o Discord.${NC}"
                sleep 2
                ;;
            0)
                clear
                pkill -f xmrig
                pkill -f cpuminer
                discord_send "ğŸ‘‹ **SISTEMA ENCERRADO**\nTotal shares: $TOTAL_SHARES"
                echo -e "${GREEN}Obrigado por usar o Megalodon Turbo Miner!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
                sleep 1
                ;;
        esac
    done
}

# =============================================================================
# LIMPEZA
# =============================================================================
cleanup() {
    echo ""
    pkill -f xmrig 2>/dev/null
    pkill -f cpuminer 2>/dev/null
    exit 0
}

# =============================================================================
# MAIN
# =============================================================================
trap cleanup SIGINT SIGTERM

# Verificar Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}ERRO: Execute no Termux${NC}"
    exit 1
fi

# Criar diretÃ³rios
mkdir -p "$MINER_HOME" "$LOG_DIR" "$BIN_DIR" "$TEMP_DIR"

# Detectar hardware
detect_hardware

# Mensagem de boas-vindas
clear
echo -e "${GREEN}${BOLD}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                   â•‘"
echo "â•‘   MEGALODON TURBO MINER - 100x MAIS RÃPIDO QUE BITCOIN!          â•‘"
echo "â•‘                                                                   â•‘"
echo "â•‘   Seu saldo atual na NiceHash: R$0,02 (0.00000006 BTC)           â•‘"
echo "â•‘   Com RandomX, vocÃª pode fazer ISSO POR DIA!                     â•‘"
echo "â•‘                                                                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo ""
echo "Recomendado: OpÃ§Ã£o 1 (RandomX) - AtÃ© R$0,10 por dia!"
echo ""
echo -e "${YELLOW}Pressione ENTER para continuar...${NC}"
read -r

# Iniciar menu
show_menu
