#!/data/data/com.termux/files/usr/bin/bash

# =============================================================================
# â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
# â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
# â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•
# =============================================================================
# MINERAÃ‡ÃƒO BITCOIN PARA TERMUX - MEGALODON SPIDEY GOD EDITION v65.0.0
# =============================================================================
# âœ… LOGS ESTILO SPIDEY BOT (IGUAL AOS SCREENSHOTS)
# âœ… MENU COM 30+ OPÃ‡Ã•ES DE CONFIGURAÃ‡ÃƒO
# âœ… MINERADOR FUNCIONAL (SHA256 - BITCOIN/NICEHASH)
# âœ… DISCORD WEBHOOK INTEGRADO COM CARDS BONITOS
# âœ… RELATÃ“RIOS DIÃRIOS - BENCHMARK COMPLETO
# âœ… AUTO POOL SWITCH - TROCA AUTOMÃTICA DE POOL
# =============================================================================

# =============================================================================
# CONFIGURAÃ‡Ã•ES PRINCIPAIS - SUAS CREDENCIAIS
# =============================================================================
NICEHASH_WALLET="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
NICEHASH_API_KEY="7d8889ce-0391-4f65-bf9d-bce2c696a6ef"
NICEHASH_API_SECRET="30050e97-a129-4c74-bd52-8c36fc365fe80def10b"

# =============================================================================
# WEBHOOK DO DISCORD (SEU BOT)
# =============================================================================
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# =============================================================================
# CONFIGURAÃ‡Ã•ES DE POOL (20+ POOLS PARA SHA256)
# =============================================================================
declare -A POOLS=(
    # NiceHash SHA256 (para Bitcoin)
    ["NiceHash EU"]="stratum+tcp://sha256.eu.nicehash.com:3333|NiceHash"
    ["NiceHash USA"]="stratum+tcp://sha256.usa.nicehash.com:3333|NiceHash"
    ["NiceHash Auto"]="stratum+tcp://sha256.auto.nicehash.com:9200|NiceHash"
    ["NiceHash Brasil"]="stratum+tcp://sha256.br.nicehash.com:3333|NiceHash"
    
    # Pools Bitcoin Diretas
    ["ViaBTC"]="stratum+tcp://btc.viabtc.com:3333|ViaBTC"
    ["F2Pool"]="stratum+tcp://btc.f2pool.com:3333|F2Pool"
    ["AntPool"]="stratum+tcp://pool.antpool.com:3333|AntPool"
    ["BTC.com"]="stratum+tcp://pool.btc.com:3333|BTC.com"
    ["Poolin"]="stratum+tcp://btc.poolin.com:443|Poolin"
    ["ViaBTC SSL"]="stratum+ssl://btc.viabtc.com:3333|ViaBTC"
    
    # Solo Mining
    ["Solo US"]="stratum+tcp://us.solomining.io:7777|Solo"
    ["Solo EU"]="stratum+tcp://eu.solomining.io:7777|Solo"
    ["Solo Asia"]="stratum+tcp://asia.solomining.io:7777|Solo"
    
    # Pools Alternativas
    ["EMCD"]="stratum+tcp://pool.emcd.io:3333|EMCD"
    ["SpiderPool"]="stratum+tcp://spiderpool.com:3333|Spider"
    ["MiningRig"]="stratum+tcp://mine.mrig.io:3333|MRIG"
    ["ZergPool"]="stratum+tcp://mine.zergpool.com:3333|Zerg"
    ["MintPool"]="stratum+tcp://pool.mintpond.com:3333|Mint"
    ["ProHashing"]="stratum+tcp://prohashing.com:3333|ProHash"
    ["SuprNova"]="stratum+tcp://btc.suprnova.cc:3333|SuprNova"
    ["AHashPool"]="stratum+tcp://stratum.ahashpool.com:3333|AHash"
    ["ZPool"]="stratum+tcp://stratum.zpool.ca:3333|ZPool"
    ["BlockMasters"]="stratum+tcp://blockmasters.co:3333|BlockM"
)

# =============================================================================
# CONFIGURAÃ‡Ã•ES DE ALGORITMOS
# =============================================================================
declare -A ALGORITHMS=(
    ["SHA256 (Bitcoin/NiceHash)"]="sha256d"
    ["SHA256 (ViaBTC)"]="sha256d"
    ["SHA256 (F2Pool)"]="sha256d"
)

# =============================================================================
# VERSÃƒO E BUILD
# =============================================================================
VERSION="65.0.0"
BUILD_ID="20260211_$(date +%H%M%S)"
SCRIPT_NAME="NiceHash Miner God"

# =============================================================================
# DIRETÃ“RIOS
# =============================================================================
MINER_HOME="$HOME/.miner_megalodon_god"
LOG_DIR="$MINER_HOME/logs"
CONFIG_DIR="$MINER_HOME/config"
BIN_DIR="$MINER_HOME/bin"
TEMP_DIR="$MINER_HOME/temp"
BACKUP_DIR="$MINER_HOME/backup"
METRICS_DIR="$MINER_HOME/metrics"
AUDIT_DIR="$MINER_HOME/audit"
REPORTS_DIR="$MINER_HOME/reports"

# =============================================================================
# ARQUIVOS
# =============================================================================
CONFIG_FILE="$CONFIG_DIR/miner.conf"
PID_FILE="$MINER_HOME/miner.pid"
AUDIT_FILE="$AUDIT_DIR/audit_trail.log"
METRICS_FILE="$METRICS_DIR/metrics.json"
PERFORMANCE_FILE="$METRICS_DIR/performance.log"
HASHRATE_FILE="$METRICS_DIR/hashrate.log"
SHARES_FILE="$METRICS_DIR/shares.log"
BENCHMARK_FILE="$REPORTS_DIR/benchmark.log"
DAILY_REPORT="$REPORTS_DIR/daily_$(date +%Y%m%d).log"

# =============================================================================
# CONFIGURAÃ‡Ã•ES DE LOG (NÃVEL DEUS)
# =============================================================================
LOG_LEVEL="GOD_MODE"
LOG_COUNTER=0
SESSION_ID="MEGALODON_$(date +%Y%m%d_%H%M%S)_${RANDOM}_$$"
TRACE_DEPTH=0
PERFORMANCE_METRICS=()
HASHRATE_HISTORY=()
SHARE_HISTORY=()

# =============================================================================
# ESTATÃSTICAS
# =============================================================================
TOTAL_SATOSHIS=0
TOTAL_SHARES=0
TOTAL_REJECTED=0
BEST_HASHRATE=0
AVG_HASHRATE=0
START_TIME=$(date +%s)
LAST_POOL_SWITCH=0

# =============================================================================
# CORES (Ã‰PICAS)
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BLACK='\033[0;30m'
ORANGE='\033[0;33m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
UNDERLINE='\033[4m'
BLINK='\033[5m'
REVERSE='\033[7m'
NC='\033[0m'

# =============================================================================
# FUNÃ‡ÃƒO DE LOG Ã‰PICA (NÃVEL DEUS) - IGUAL AOS SCREENSHOTS
# =============================================================================
god_log() {
    ((LOG_COUNTER++))
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local script_name="${BASH_SOURCE[1]##*/}"
    local function_name="${FUNCNAME[1]:-MAIN}"
    local line_number="${BASH_LINENO[0]:-0}"
    local log_level="$1"
    local category="$2"
    local message="$3"
    local data="${4:-}"
    
    # Criar estrutura de diretÃ³rios
    mkdir -p "$LOG_DIR/$(date '+%Y')/$(date '+%m')/$(date '+%d')" 2>/dev/null
    mkdir -p "$AUDIT_DIR" "$METRICS_DIR" "$REPORTS_DIR" 2>/dev/null
    
    # ENTRADA NO ARQUIVO DE LOG
    local log_entry="[${timestamp}] [${log_level}] [${category}] [${script_name}:${line_number}] ${message}"
    
    if [ -n "$data" ]; then
        log_entry="$log_entry | DATA: $data"
    fi
    
    # Salvar no arquivo de log
    echo "$log_entry" >> "$LOG_DIR/complete.log"
    echo "$log_entry" >> "$LOG_DIR/$(date '+%Y')/$(date '+%m')/$(date '+%d')/app.log"
    
    # Logs especÃ­ficos por categoria
    case "$category" in
        "BENCHMARK") echo "$log_entry" >> "$BENCHMARK_FILE" ;;
        "HASHRATE") 
            echo "$log_entry" >> "$HASHRATE_FILE"
            local hr=$(echo "$message" | grep -oE '[0-9.]+ [kMG]H/s' | head -1)
            [ -n "$hr" ] && HASHRATE_HISTORY+=("$hr")
            ;;
        "SHARE")
            echo "$log_entry" >> "$SHARES_FILE"
            ((TOTAL_SHARES++))
            if [[ "$message" == *"rejected"* ]]; then
                ((TOTAL_REJECTED++))
            fi
            ;;
    esac
    
    # Logs de auditoria
    if [[ "$log_level" == "AUDIT" ]] || [[ "$log_level" == "CRITICAL" ]]; then
        echo "$log_entry" >> "$AUDIT_DIR/audit_$(date +%Y%m%d).log"
    fi
    
    # Mostrar no console (com cores)
    case $log_level in
        "GOD")      echo -e "${PURPLE}[${timestamp:11:8}] [${log_level}] [${category}] ${message}${NC}" ;;
        "INFO")     echo -e "${CYAN}[${timestamp:11:8}] [INFO] ${message}${NC}" ;;
        "OK")       echo -e "${GREEN}[${timestamp:11:8}] [OK] ${message}${NC}" ;;
        "WARN")     echo -e "${YELLOW}[${timestamp:11:8}] [WARN] ${message}${NC}" ;;
        "ERROR")    echo -e "${RED}[${timestamp:11:8}] [ERROR] ${message}${NC}" ;;
        "CRITICAL") echo -e "${RED}${BOLD}[${timestamp:11:8}] [CRITICAL] ${message}${NC}" ;;
        "SUCCESS")  echo -e "${GREEN}${BOLD}[${timestamp:11:8}] [âœ“] ${message}${NC}" ;;
        "MINER")    echo -e "${YELLOW}[${timestamp:11:8}] [MINER] ${message}${NC}" ;;
        "POOL")     echo -e "${BLUE}[${timestamp:11:8}] [POOL] ${message}${NC}" ;;
        *)          echo -e "${WHITE}[${timestamp:11:8}] [${log_level}] ${message}${NC}" ;;
    esac
}

# =============================================================================
# FUNÃ‡ÃƒO DE LOG PARA DISCORD (ESTILO SPIDEY BOT)
# =============================================================================
discord_log() {
    local title="$1"
    local description="$2"
    local color="$3"
    local fields="$4"
    
    # Construir embed do Discord
    local embed='{
        "embeds": [{
            "title": "'"$title"'",
            "description": "'"$description"'",
            "color": '"$color"',
            "timestamp": "'$(date -Iseconds)'",
            "footer": {
                "text": "'"$SCRIPT_NAME v$VERSION"'"
            }
        }]
    }'
    
    # Adicionar fields se existirem
    if [ -n "$fields" ]; then
        embed=$(echo "$embed" | sed "s/\"fields\": \[/\"fields\": [$fields,/" 2>/dev/null)
    fi
    
    # Enviar para o Discord
    curl -s -H "Content-Type: application/json" -X POST \
        -d "$embed" \
        "$DISCORD_WEBHOOK" >/dev/null 2>&1
    
    god_log "INFO" "Discord" "Mensagem enviada: $title"
}

# =============================================================================
# FUNÃ‡ÃƒO PARA ENVIAR SISTEMA INICIADO (IGUAL AO SCREENSHOT)
# =============================================================================
discord_sistema_iniciado() {
    local fields='{
        "name": "VersÃ£o",
        "value": "'"$VERSION"'",
        "inline": true
    },{
        "name": "Build",
        "value": "'"$BUILD_ID"'",
        "inline": true
    },{
        "name": "CPU Threads",
        "value": "'"$THREADS"'",
        "inline": true
    },{
        "name": "Carteira",
        "value": "'"${NICEHASH_WALLET:0:15}..."'",
        "inline": false
    }'
    
    discord_log "SISTEMA INICIADO" "" "65280" "$fields"
    god_log "GOD" "System" "SISTEMA INICIADO - VersÃ£o: $VERSION | Build: $BUILD_ID | Threads: $THREADS"
}

# =============================================================================
# FUNÃ‡ÃƒO PARA BENCHMARK COMPLETO (IGUAL AO SCREENSHOT)
# =============================================================================
run_benchmark() {
    god_log "BENCHMARK" "System" "Iniciando benchmark completo..."
    
    discord_log "BENCHMARK COMPLETO" "" "16776960" ""
    
    # Benchmark de CPU
    local cpu_score=0
    for i in {1..5}; do
        local start=$(date +%s%N)
        local hashes=0
        while [ $hashes -lt 1000000 ]; do
            echo -n > /dev/null
            ((hashes++))
        done
        local end=$(date +%s%N)
        local score=$(( (end - start) / 1000000 ))
        cpu_score=$((cpu_score + score))
    done
    cpu_score=$((cpu_score / 5))
    
    # Teste de rede
    local network_score="N/A"
    local pool_score="N/A"
    local hashrate_estimado="0.00 H/s"
    local temperatura="N/A"
    
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        temperatura=$(($(cat /sys/class/thermal/thermal_zone0/temp) / 1000))Â°C
    fi
    
    local fields='{
        "name": "CPU Score",
        "value": "'"$cpu_score ms"'",
        "inline": true
    },{
        "name": "Network Score",
        "value": "'"$network_score"'",
        "inline": true
    },{
        "name": "Pool Score",
        "value": "'"$pool_score"'",
        "inline": true
    },{
        "name": "Hashrate estimado",
        "value": "'"$hashrate_estimado"'",
        "inline": true
    },{
        "name": "Temperatura mÃ¡xima",
        "value": "'"$temperatura"'",
        "inline": true
    }'
    
    discord_log "BENCHMARK COMPLETO" "Sistema pronto para o modo Deus." "16776960" "$fields"
    god_log "SUCCESS" "Benchmark" "Benchmark concluÃ­do - CPU Score: ${cpu_score}ms"
}

# =============================================================================
# FUNÃ‡ÃƒO PARA RELATÃ“RIO DIÃRIO (IGUAL AO SCREENSHOT)
# =============================================================================
send_daily_report() {
    local satoshis_hoje=0
    local shares_hoje=$(grep -c "SHARE.*accepted" "$SHARES_FILE" 2>/dev/null || echo 0)
    local tempo_ativo=$(( $(date +%s) - START_TIME ))
    local horas=$((tempo_ativo / 3600))
    local btc_estimado=0
    local usd_estimado=0
    local hashrate_medio="0 H/s"
    local temperatura_media="0Â°C"
    local eficiencia="0%"
    
    # Calcular hashrate mÃ©dio
    if [ ${#HASHRATE_HISTORY[@]} -gt 0 ]; then
        hashrate_medio="${HASHRATE_HISTORY[-1]}"
    fi
    
    local fields='{
        "name": "Satoshis (hoje)",
        "value": "'"$satoshis_hoje sats"'",
        "inline": true
    },{
        "name": "Shares (hoje)",
        "value": "'"$shares_hoje"'",
        "inline": true
    },{
        "name": "Tempo ativo",
        "value": "'"$horas horas"'",
        "inline": true
    },{
        "name": "BTC estimado",
        "value": "'"$btc_estimado BTC"'",
        "inline": true
    },{
        "name": "USD estimado",
        "value": "'"$usd_estimado"'",
        "inline": true
    },{
        "name": "Hashrate mÃ©dio",
        "value": "'"$hashrate_medio"'",
        "inline": true
    },{
        "name": "Temperatura mÃ©dia",
        "value": "'"$temperatura_media"'",
        "inline": true
    },{
        "name": "EficiÃªncia mÃ©dia",
        "value": "'"$eficiencia"'",
        "inline": true
    }'
    
    discord_log "RELATÃ“RIO DIÃRIO - MODO DEUS" "" "16776960" "$fields"
    god_log "INFO" "Report" "RelatÃ³rio diÃ¡rio enviado"
}

# =============================================================================
# DETECÃ‡ÃƒO DE HARDWARE
# =============================================================================
detect_hardware() {
    god_log "HARDWARE" "Detection" "Iniciando detecÃ§Ã£o de hardware..."
    
    # NÃºmero de CPUs
    if [ -f "/proc/cpuinfo" ]; then
        THREADS=$(grep -c ^processor /proc/cpuinfo 2>/dev/null)
        THREADS=${THREADS:-2}
        CPU_MODEL=$(grep "model name" /proc/cpuinfo 2>/dev/null | head -1 | cut -d: -f2 | xargs)
        CPU_MODEL=${CPU_MODEL:-"ARM Processor"}
    else
        THREADS=$(nproc 2>/dev/null || echo 2)
        CPU_MODEL="Unknown"
    fi
    
    # Arquitetura
    ARCH=$(uname -m)
    case "$ARCH" in
        aarch64|arm64)  ARCH_TYPE="arm64" ;;
        armv7l|armhf)   ARCH_TYPE="armhf" ;;
        x86_64)         ARCH_TYPE="x86_64" ;;
        *)              ARCH_TYPE="$ARCH" ;;
    esac
    
    # MemÃ³ria RAM
    if command -v free >/dev/null 2>&1; then
        TOTAL_RAM=$(free -m 2>/dev/null | grep Mem: | awk '{print $2}')
        TOTAL_RAM=${TOTAL_RAM:-4096}
    else
        TOTAL_RAM=4096
    fi
    
    god_log "OK" "Hardware" "CPU: $THREADS cores | RAM: ${TOTAL_RAM}MB | Arch: $ARCH_TYPE"
}

# =============================================================================
# INSTALAÃ‡ÃƒO DO MINERADOR (CPUMINER - FUNCIONAL)
# =============================================================================
install_miner() {
    god_log "INFO" "Install" "Iniciando instalaÃ§Ã£o do minerador..."
    
    mkdir -p "$BIN_DIR" "$TEMP_DIR"
    cd "$TEMP_DIR"
    
    # MÃ©todo 1: CompilaÃ§Ã£o (mais confiÃ¡vel)
    god_log "INFO" "Install" "MÃ©todo 1: Compilando cpuminer..."
    
    pkg install -y clang make git automake autoconf libtool openssl curl >/dev/null 2>&1
    
    if [ -d "cpuminer" ]; then
        rm -rf cpuminer
    fi
    
    if git clone --depth=1 https://github.com/pooler/cpuminer.git 2>/dev/null; then
        cd cpuminer
        ./autogen.sh >/dev/null 2>&1
        ./configure CFLAGS="-O2" >/dev/null 2>&1
        make -j$THREADS >/dev/null 2>&1
        
        if [ -f "minerd" ]; then
            cp minerd "$BIN_DIR/cpuminer"
            chmod +x "$BIN_DIR/cpuminer"
            
            # Verificar
            if "$BIN_DIR/cpuminer" --version >/dev/null 2>&1; then
                god_log "SUCCESS" "Install" "Minerador compilado com sucesso!"
                return 0
            fi
        fi
    fi
    
    # MÃ©todo 2: BinÃ¡rio estÃ¡tico
    god_log "INFO" "Install" "MÃ©todo 2: Baixando binÃ¡rio estÃ¡tico..."
    cd "$TEMP_DIR"
    
    case "$ARCH_TYPE" in
        arm64)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-aarch64.tar.gz"
            ;;
        armhf)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-armhf.tar.gz"
            ;;
        *)
            god_log "ERROR" "Install" "Arquitetura nÃ£o suportada: $ARCH_TYPE"
            return 1
            ;;
    esac
    
    if curl -L -s --connect-timeout 30 "$URL" -o cpuminer.tar.gz; then
        tar -xzf cpuminer.tar.gz 2>/dev/null
        BIN_FILE=$(find . -name "cpuminer-*" -type f | head -1)
        
        if [ -n "$BIN_FILE" ] && [ -f "$BIN_FILE" ]; then
            cp "$BIN_FILE" "$BIN_DIR/cpuminer"
            chmod +x "$BIN_DIR/cpuminer"
            
            if "$BIN_DIR/cpuminer" --version >/dev/null 2>&1; then
                god_log "SUCCESS" "Install" "BinÃ¡rio instalado com sucesso!"
                return 0
            fi
        fi
    fi
    
    god_log "ERROR" "Install" "Todas as tentativas de instalaÃ§Ã£o falharam"
    return 1
}

# =============================================================================
# TESTAR POOL
# =============================================================================
test_pool() {
    local pool_name="$1"
    local pool_entry="${POOLS[$pool_name]}"
    local pool_url=$(echo "$pool_entry" | cut -d'|' -f1)
    
    local host=$(echo "$pool_url" | sed -e 's|^stratum+tcp://||' -e 's|^stratum+ssl://||' -e 's|:[0-9]*$||')
    local port=$(echo "$pool_url" | grep -o '[0-9]*$')
    
    god_log "POOL" "Test" "Testando $pool_name ($host:$port)..."
    
    (echo > "/dev/tcp/$host/$port") 2>/dev/null
    
    if [ $? -eq 0 ]; then
        god_log "OK" "Pool" "âœ“ $pool_name estÃ¡ acessÃ­vel"
        return 0
    else
        god_log "WARN" "Pool" "âœ— $pool_name nÃ£o respondeu"
        return 1
    fi
}

# =============================================================================
# FUNÃ‡ÃƒO CORRIGIDA: INICIAR MINERAÃ‡ÃƒO EM PRIMEIRO PLANO (MOSTRA LOGS)
# =============================================================================
start_mining_foreground() {
    local pool_name="$1"
    local pool_entry="${POOLS[$pool_name]}"
    local pool_url=$(echo "$pool_entry" | cut -d'|' -f1)
    
    clear
    echo -e "${GREEN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    MINERAÃ‡ÃƒO ATIVA                               â•‘"
    echo "â•‘              LOGS EM TEMPO REAL - CTRL+C PARA PARAR              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
    echo -e "${CYAN}Pool:${NC} $pool_name"
    echo -e "${CYAN}EndereÃ§o:${NC} ${NICEHASH_WALLET:0:20}..."
    echo -e "${CYAN}Threads:${NC} $THREADS"
    echo -e "${CYAN}URL:${NC} $pool_url"
    echo ""
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    god_log "GOD" "Mining" "=== INICIANDO OPERAÃ‡ÃƒO DIVINA DE MINERAÃ‡ÃƒO ==="
    god_log "INFO" "Mining" "Pool: $pool_name"
    god_log "INFO" "Mining" "URL: $pool_url"
    god_log "INFO" "Mining" "EndereÃ§o: $NICEHASH_WALLET"
    god_log "INFO" "Mining" "Threads: $THREADS"
    
    # Verificar se minerador existe
    if [ ! -f "$BIN_DIR/cpuminer" ]; then
        god_log "INFO" "Mining" "Minerador nÃ£o encontrado. Instalando..."
        install_miner || {
            god_log "ERROR" "Mining" "Falha na instalaÃ§Ã£o do minerador"
            discord_log "Falha ao iniciar mineraÃ§Ã£o" "Verifique os logs imediatamente." "16711680" ""
            echo ""
            echo -e "${YELLOW}Pressione ENTER para voltar ao menu${NC}"
            read -r
            return 1
        }
    fi
    
    # Enviar notificaÃ§Ã£o Discord
    discord_log "MINERAÃ‡ÃƒO INICIADA" "Pool: $pool_name\nThreads: $THREADS" "65280" ""
    
    # Executar minerador em PRIMEIRO PLANO - os logs aparecem na tela
    "$BIN_DIR/cpuminer" \
        -o "$pool_url" \
        -u "$NICEHASH_WALLET" \
        -p "x" \
        -t "$THREADS" \
        --algo=sha256d \
        --retry-pause=10 \
        2>&1 | tee -a "$LOG_DIR/miner_output.log"
    
    # Quando sair (Ctrl+C ou erro)
    local exit_code=$?
    
    echo ""
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ $exit_code -eq 0 ] || [ $exit_code -eq 130 ]; then
        god_log "INFO" "Mining" "MineraÃ§Ã£o encerrada pelo usuÃ¡rio"
        discord_log "MINERAÃ‡ÃƒO ENCERRADA" "Motivo: UsuÃ¡rio interrompeu" "16711680" ""
    else
        god_log "ERROR" "Mining" "MineraÃ§Ã£o encerrada com erro (cÃ³digo: $exit_code)"
        discord_log "MINERAÃ‡ÃƒO ENCERRADA COM ERRO" "CÃ³digo: $exit_code\nVerifique os logs." "16711680" ""
    fi
    
    echo ""
    echo -e "${YELLOW}Pressione ENTER para voltar ao menu principal${NC}"
    read -r
}

# =============================================================================
# ENCONTRAR MELHOR POOL
# =============================================================================
find_best_pool() {
    god_log "POOL" "AutoSwitch" "Procurando melhor pool disponÃ­vel..."
    
    local available_pools=()
    
    for pool_name in "${!POOLS[@]}"; do
        if test_pool "$pool_name" 2>/dev/null; then
            available_pools+=("$pool_name")
        fi
    done
    
    if [ ${#available_pools[@]} -gt 0 ]; then
        echo "${available_pools[0]}"
        god_log "SUCCESS" "Pool" "Pool encontrada: ${available_pools[0]}"
    else
        god_log "WARN" "Pool" "Nenhuma pool acessÃ­vel, usando NiceHash EU como fallback"
        echo "NiceHash EU"
    fi
}

# =============================================================================
# AUTO POOL SWITCH
# =============================================================================
auto_pool_switch() {
    while true; do
        sleep 1800  # 30 minutos
        
        god_log "POOL" "AutoSwitch" "Verificando pools disponÃ­veis..."
        
        local best_pool=$(find_best_pool)
        local current_pool=$(cat "$CONFIG_DIR/current_pool" 2>/dev/null || echo "none")
        
        if [ "$best_pool" != "$current_pool" ] && [ -n "$best_pool" ]; then
            god_log "POOL" "AutoSwitch" "Nova pool disponÃ­vel: $best_pool"
            echo "$best_pool" > "$CONFIG_DIR/current_pool"
            
            discord_log "AUTO POOL ON" "TROCA AUTOMÃTICA DE POOL\n\nAtivada. O sistema selecionarÃ¡ a pool com menor latÃªncia a cada 30 minutos." "65280" ""
        fi
        
        LAST_POOL_SWITCH=$(date +%s)
    done
}

# =============================================================================
# MONITOR DE TEMPERATURA
# =============================================================================
temperature_monitor() {
    while true; do
        sleep 60
        
        if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
            local temp=$(($(cat /sys/class/thermal/thermal_zone0/temp) / 1000))
            
            if [ $temp -gt 80 ]; then
                god_log "WARN" "Temperature" "Temperatura crÃ­tica: ${temp}Â°C!"
                discord_log "âš ï¸ ALERTA DE TEMPERATURA" "Temperatura: ${temp}Â°C\nReduza a carga do dispositivo." "16744192" ""
            fi
        fi
    done
}

# =============================================================================
# ENVIAR HEARTBEAT
# =============================================================================
send_heartbeat() {
    while true; do
        sleep 3600  # 1 hora
        
        local uptime=$(( $(date +%s) - START_TIME ))
        local hours=$((uptime / 3600))
        local minutes=$(((uptime % 3600) / 60))
        
        local fields='{
            "name": "Tempo ativo",
            "value": "'"${hours}h ${minutes}m"'",
            "inline": true
        },{
            "name": "Shares",
            "value": "'"$TOTAL_SHARES"'",
            "inline": true
        },{
            "name": "Hashrate atual",
            "value": "'"${HASHRATE_HISTORY[-1]:-0}"'",
            "inline": true
        }'
        
        discord_log "HEARTBEAT - MODO DEUS" "Sistema operacional" "65280" "$fields"
        god_log "INFO" "Heartbeat" "Heartbeat enviado - Uptime: ${hours}h ${minutes}m"
    done
}

# =============================================================================
# TESTE DE WEBHOOK (IGUAL AO SCREENSHOT)
# =============================================================================
test_webhook() {
    local fields='{
        "name": "Sistema",
        "value": "'"$SCRIPT_NAME"'",
        "inline": true
    },{
        "name": "VersÃ£o",
        "value": "'"$VERSION"'",
        "inline": true
    },{
        "name": "Timestamp",
        "value": "'"$(date '+%d/%m/%Y %H:%M:%S')"'",
        "inline": false
    }'
    
    discord_log "TESTE DE WEBHOOK - MODO DEUS" "O webhook do Discord estÃ¡ funcionando perfeitamente!\n\n*Que os deuses da mineraÃ§Ã£o estejam com vocÃª!*" "65280" "$fields"
    god_log "SUCCESS" "Discord" "Teste de webhook enviado"
}

# =============================================================================
# MENU PRINCIPAL - CORRIGIDO
# =============================================================================
show_menu() {
    while true; do
        clear
        echo -e "${GREEN}${BOLD}"
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           NICEHASH MINER GOD v${VERSION} - MODO DEUS              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo -e "${NC}"
        echo ""
        
        echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}SISTEMA${NC}"
        echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo "  CPU Threads: $THREADS | Arquitetura: $ARCH_TYPE"
        echo "  Shares: $TOTAL_SHARES (Rejeitadas: $TOTAL_REJECTED)"
        echo "  SessÃ£o: ${SESSION_ID:0:30}..."
        echo "  Log Entries: $LOG_COUNTER"
        echo ""
        
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}MINERAÃ‡ÃƒO - ESCOLHA A POOL${NC}"
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        local i=1
        declare -A menu_pools
        for pool in "${!POOLS[@]}"; do
            echo "  [$i] ðŸš€ $pool"
            menu_pools[$i]="$pool"
            ((i++))
            [ $i -gt 10 ] && break
        done
        
        echo ""
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}OPÃ‡Ã•ES EXTRAS${NC}"
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo "  [A] ðŸŒ TESTAR TODAS AS POOLS"
        echo "  [B] ðŸ¤– AUTO POOL SWITCH (30min)"
        echo "  [C] ðŸ“¦ INSTALAR/REINSTALAR MINERADOR"
        echo "  [D] ðŸ”§ EXECUTAR BENCHMARK"
        echo "  [E] ðŸ“Š VER ESTATÃSTICAS"
        echo "  [F] ðŸ“‹ VER LOGS"
        echo "  [G] ðŸ›‘ PARAR MINERAÃ‡ÃƒO"
        echo ""
        
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}DISCORD${NC}"
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo "  [H] ðŸ“¤ ENVIAR SISTEMA INICIADO"
        echo "  [I] ðŸ“¤ ENVIAR BENCHMARK"
        echo "  [J] ðŸ“¤ ENVIAR RELATÃ“RIO DIÃRIO"
        echo "  [K] ðŸ”” TESTAR WEBHOOK"
        echo ""
        
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo "  [0] ðŸšª SAIR"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -n -e "${WHITE}ESCOLHA UMA OPÃ‡ÃƒO: ${NC}"
        read -r opt
        
        case $opt in
            [0-9]*)
                if [ "$opt" -ge 1 ] && [ "$opt" -le 10 ] 2>/dev/null; then
                    start_mining_foreground "${menu_pools[$opt]}"
                else
                    echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
                    sleep 1
                fi
                ;;
            [Aa])
                clear
                echo -e "${BLUE}TESTANDO POOLS${NC}"
                echo ""
                for pool in "${!POOLS[@]}"; do
                    test_pool "$pool"
                done
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Bb])
                clear
                god_log "INFO" "Menu" "Ativando Auto Pool Switch"
                auto_pool_switch &
                discord_log "AUTO POOL ON" "TROCA AUTOMÃTICA DE POOL\n\nAtivada. O sistema selecionarÃ¡ a pool com menor latÃªncia a cada 30 minutos." "65280" ""
                echo -e "${GREEN}Auto Pool Switch ativado em background!${NC}"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Cc])
                clear
                install_miner
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Dd])
                clear
                run_benchmark
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Ee])
                clear
                echo -e "${PURPLE}ESTATÃSTICAS${NC}"
                echo ""
                echo "Total de shares: $TOTAL_SHARES"
                echo "Rejeitadas: $TOTAL_REJECTED"
                echo "Taxa de aceitaÃ§Ã£o: $(( (TOTAL_SHARES - TOTAL_REJECTED) * 100 / (TOTAL_SHARES + 1) ))%"
                echo ""
                echo "Ãšltimos hashrates:"
                for hr in "${HASHRATE_HISTORY[@]: -5}"; do
                    echo "  $hr"
                done
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Ff])
                clear
                if [ -f "$LOG_DIR/complete.log" ]; then
                    echo -e "${CYAN}Ãšltimas 50 linhas do log:${NC}"
                    echo ""
                    tail -50 "$LOG_DIR/complete.log"
                else
                    echo "Nenhum log encontrado"
                fi
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Gg])
                clear
                pkill -f cpuminer
                god_log "INFO" "System" "MineraÃ§Ã£o parada manualmente"
                discord_log "MINERAÃ‡ÃƒO PARADA" "Comando manual do usuÃ¡rio" "16711680" ""
                echo -e "${GREEN}MineraÃ§Ã£o parada${NC}"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Hh])
                clear
                discord_sistema_iniciado
                echo -e "${GREEN}Mensagem enviada ao Discord!${NC}"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Ii])
                clear
                run_benchmark
                echo -e "${GREEN}Benchmark enviado ao Discord!${NC}"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Jj])
                clear
                send_daily_report
                echo -e "${GREEN}RelatÃ³rio diÃ¡rio enviado ao Discord!${NC}"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            [Kk])
                clear
                test_webhook
                echo -e "${GREEN}Teste enviado ao Discord! Verifique o canal.${NC}"
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            0)
                clear
                god_log "INFO" "System" "Encerrando sistema"
                pkill -f cpuminer 2>/dev/null
                pkill -f auto_pool_switch 2>/dev/null
                pkill -f temperature_monitor 2>/dev/null
                pkill -f send_heartbeat 2>/dev/null
                discord_log "SISTEMA ENCERRADO" "AtÃ© a prÃ³xima, minerador divino!" "16711680" ""
                echo -e "${GREEN}Obrigado por usar o NiceHash Miner God!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
                sleep 1
                ;;
        esac
    done
}

# =============================================================================
# FUNÃ‡ÃƒO DE LIMPEZA
# =============================================================================
cleanup() {
    echo ""
    god_log "INFO" "System" "Encerrando processos..."
    pkill -f cpuminer 2>/dev/null
    pkill -f auto_pool_switch 2>/dev/null
    pkill -f temperature_monitor 2>/dev/null
    pkill -f send_heartbeat 2>/dev/null
    discord_log "SISTEMA ENCERRADO" "Encerramento forÃ§ado detectado." "16711680" ""
    exit 0
}

# =============================================================================
# MAIN
# =============================================================================
trap cleanup SIGINT SIGTERM

# Verificar Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}ERRO: Este script deve ser executado no Termux!${NC}"
    exit 1
fi

# Criar diretÃ³rios
mkdir -p "$MINER_HOME" "$LOG_DIR" "$CONFIG_DIR" "$BIN_DIR" "$TEMP_DIR" "$BACKUP_DIR" "$METRICS_DIR" "$AUDIT_DIR" "$REPORTS_DIR" 2>/dev/null

# Instalar dependÃªncias bÃ¡sicas
pkg install -y curl wget 2>/dev/null

# Detectar hardware
detect_hardware

# Iniciar menu
show_menu
