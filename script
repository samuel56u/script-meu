#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# BITCOIN MINER TERMUX PROFESSIONAL v10.0
# Sistema completo: Dashboard, Discord Logs, Monitoramento, Backup, Tudo!
# ============================================================================

# ============================================================================
# CONFIGURA√á√ÉO DO SISTEMA
# ============================================================================

# Diret√≥rios ABSOLUTOS (sem vari√°veis nulas)
export MINER_ROOT="/data/data/com.termux/files/home/bitcoin_miner_pro"
export MINER_BIN="$MINER_ROOT/bin"
export MINER_CONFIG="$MINER_ROOT/config"
export MINER_LOGS="$MINER_ROOT/logs"
export MINER_STATS="$MINER_ROOT/stats"
export MINER_SCRIPTS="$MINER_ROOT/scripts"
export MINER_BACKUP="$MINER_ROOT/backup"
export MINER_TEMP="$MINER_ROOT/temp"

# Carteira Bitcoin (ALTERE PARA SUA)
export BTC_WALLET="3Jg8E9nQrN4L2q7V1tXwY5zP6bR8cD0mF2aH4jK5l"

# Discord Webhook (ALTERE PARA SEU)
export DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# Configura√ß√µes de Performance
export CPU_THREADS=4
export CPU_PRIORITY=3
export DONATE_LEVEL=1
export CPU_MAX=80

# Pools de Minera√ß√£o
export POOLS=(
    "randomxmonero.auto.nicehash.com:9200"
    "randomxmonero.usa.nicehash.com:3380"
    "randomxmonero.eu.nicehash.com:3380"
    "randomxmonero.br.nicehash.com:3380"
    "randomxmonero.jp.nicehash.com:3380"
)

# ============================================================================
# SISTEMA DE CORES COMPLETO
# ============================================================================

# Cores b√°sicas
BLACK='\033[0;30m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'

# Cores personalizadas
ORANGE='\033[38;5;208m'
PINK='\033[38;5;213m'
LIME='\033[38;5;154m'
TEAL='\033[38;5;123m'
VIOLET='\033[38;5;129m'
GOLD='\033[38;5;220m'
SILVER='\033[38;5;248m'

# Estilos
BOLD='\033[1m'
DIM='\033[2m'
ITALIC='\033[3m'
UNDERLINE='\033[4m'
BLINK='\033[5m'
REVERSE='\033[7m'

# Reset
NC='\033[0m'
RESET='\033[0m'

# Cores tem√°ticas
COLOR_TITLE="${PURPLE}${BOLD}"
COLOR_SUCCESS="${GREEN}${BOLD}"
COLOR_WARNING="${YELLOW}${BOLD}"
COLOR_ERROR="${RED}${BOLD}"
COLOR_INFO="${CYAN}${BOLD}"
COLOR_PROFIT="${GOLD}${BOLD}"
COLOR_HASHRATE="${LIME}${BOLD}"
COLOR_STATUS="${TEAL}${BOLD}"
COLOR_MENU="${BLUE}${BOLD}"
COLOR_OPTION="${WHITE}"
COLOR_INPUT="${CYAN}"

# ============================================================================
# SISTEMA DE LOGS AVAN√áADO
# ============================================================================

log_system() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SYSTEM] $1" >> "$MINER_LOGS/system.log"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$MINER_LOGS/combined.log"
}

log_miner() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [MINER] $1" >> "$MINER_LOGS/miner.log"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$MINER_LOGS/combined.log"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >> "$MINER_LOGS/error.log"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$MINER_LOGS/combined.log"
    echo -e "${COLOR_ERROR}[ERROR]${NC} $1"
}

log_warning() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARNING] $1" >> "$MINER_LOGS/warning.log"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$MINER_LOGS/combined.log"
    echo -e "${COLOR_WARNING}[WARNING]${NC} $1"
}

log_success() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SUCCESS] $1" >> "$MINER_LOGS/success.log"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$MINER_LOGS/combined.log"
    echo -e "${COLOR_SUCCESS}[SUCCESS]${NC} $1"
}

log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" >> "$MINER_LOGS/info.log"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$MINER_LOGS/combined.log"
    echo -e "${COLOR_INFO}[INFO]${NC} $1"
}

# ============================================================================
# SISTEMA DE DISCORD WEBHOOK
# ============================================================================

discord_send() {
    local message="$1"
    local color="$2"
    local title="$3"
    
    if [ -z "$DISCORD_WEBHOOK" ] || [ "$DISCORD_WEBHOOK" = "" ]; then
        return 0
    fi
    
    # Criar embed Discord
    local json_payload=$(cat << EOF
{
  "embeds": [
    {
      "title": "$title",
      "description": "$message",
      "color": $color,
      "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')",
      "footer": {
        "text": "Bitcoin Miner Termux v10.0"
      },
      "thumbnail": {
        "url": "https://cdn-icons-png.flaticon.com/512/825/825517.png"
      }
    }
  ]
}
EOF
    )
    
    # Enviar via curl
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "$json_payload" \
         "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [DISCORD] $title: $message" >> "$MINER_LOGS/discord.log"
}

discord_mining_start() {
    local worker_name="$1"
    discord_send "Mining started with worker: $worker_name\nWallet: $BTC_WALLET\nPool: ${POOLS[0]}" "3066993" "üöÄ MINING STARTED"
}

discord_mining_stop() {
    local worker_name="$1"
    discord_send "Mining stopped for worker: $worker_name" "15158332" "üõë MINING STOPPED"
}

discord_share_accepted() {
    local share_num="$1"
    local difficulty="$2"
    local hashrate="$3"
    discord_send "Share #$share_num accepted\nDifficulty: $difficulty\nHashrate: $hashrate" "2067276" "‚úÖ SHARE ACCEPTED"
}

discord_profit_report() {
    local hashrate="$1"
    local satoshis="$2"
    local btc="$3"
    local usd="$4"
    discord_send "Hashrate: $hashrate\nDaily: $satoshis satoshis\nBTC: $btc\nUSD: \$$usd" "15844367" "üí∞ PROFIT REPORT"
}

discord_error() {
    local error_msg="$1"
    discord_send "Error: $error_msg" "15158332" "‚ùå MINING ERROR"
}

# ============================================================================
# SISTEMA DE INSTALA√á√ÉO DO XMRIG (15 M√âTODOS)
# ============================================================================

install_xmrig_comprehensive() {
    log_info "Starting comprehensive XMRig installation..."
    
    # Criar diret√≥rio tempor√°rio
    mkdir -p "$MINER_TEMP"
    cd "$MINER_TEMP"
    
    # Lista de m√©todos de instala√ß√£o
    local methods=(
        "method_github_release"
        "method_github_binary"
        "method_mirror_minerio"
        "method_mirror_minerrocks"
        "method_binaries_xmrig"
        "method_termux_repo"
        "method_android_miner"
        "method_compile_source"
        "method_dpkg_package"
        "method_archive_org"
        "method_ipfs"
        "method_torrent"
        "method_local_cache"
        "method_compatible_binary"
        "method_qemu_emulation"
    )
    
    # Tentar cada m√©todo
    for method in "${methods[@]}"; do
        log_info "Trying method: $method"
        
        if $method; then
            if [ -f "$MINER_BIN/xmrig" ]; then
                chmod +x "$MINER_BIN/xmrig"
                
                # Testar o bin√°rio
                if "$MINER_BIN/xmrig" --help > /dev/null 2>&1; then
                    log_success "XMRig installed successfully via $method"
                    
                    # Salvar no cache
                    cp "$MINER_BIN/xmrig" "$MINER_ROOT/.cache/xmrig_latest"
                    
                    # Mostrar vers√£o
                    local version=$("$MINER_BIN/xmrig" --version 2>/dev/null | head -1)
                    log_info "Version: $version"
                    
                    discord_send "XMRig installed successfully\nMethod: $method\nVersion: $version" "3066993" "‚úÖ XMRIG INSTALLED"
                    
                    return 0
                fi
            fi
        fi
    done
    
    log_error "All installation methods failed!"
    discord_error "Failed to install XMRig after 15 methods"
    return 1
}

# M√©todos de instala√ß√£o individuais
method_github_release() {
    log_info "Method: GitHub Release"
    wget -q "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64.tar.gz" -O xmrig.tar.gz
    if [ $? -eq 0 ]; then
        tar -xzf xmrig.tar.gz
        find . -name "xmrig" -type f -exec cp {} "$MINER_BIN/xmrig" \;
        return 0
    fi
    return 1
}

method_github_binary() {
    log_info "Method: GitHub Binary"
    wget -q "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64" -O "$MINER_BIN/xmrig"
    return $?
}

method_mirror_minerio() {
    log_info "Method: Miner.io Mirror"
    wget -q "https://dl.miner.io/xmrig/v6.20.0/xmrig-6.20.0-linux-arm64" -O "$MINER_BIN/xmrig"
    return $?
}

method_compile_source() {
    log_info "Method: Compile from Source"
    
    # Instalar depend√™ncias de compila√ß√£o
    pkg install -y git build-essential cmake libuv-dev libssl-dev libhwloc-dev -y
    
    # Clonar e compilar
    git clone https://github.com/xmrig/xmrig.git
    cd xmrig
    mkdir build
    cd build
    cmake .. -DWITH_HTTPD=OFF
    make -j$(nproc)
    
    if [ -f "xmrig" ]; then
        cp xmrig "$MINER_BIN/xmrig"
        return 0
    fi
    return 1
}

# [Resto dos m√©todos...]

# ============================================================================
# SISTEMA DE CONFIGURA√á√ÉO
# ============================================================================

create_configuration() {
    log_info "Creating system configuration..."
    
    # Gerar worker name √∫nico
    local worker_id="termux_$(date +%s)_$(cat /proc/sys/kernel/random/uuid | cut -c1-4)"
    
    # Criar arquivo de configura√ß√£o principal
    cat > "$MINER_CONFIG/config.json" << EOF
{
    "autosave": true,
    "autosave-interval": 30,
    "cpu": true,
    "opencl": false,
    "cuda": false,
    "donate-level": $DONATE_LEVEL,
    "donate-over-proxy": 1,
    "log-file": "$MINER_LOGS/miner.json.log",
    "pools": [
        {
            "url": "${POOLS[0]}",
            "user": "$BTC_WALLET.$worker_id",
            "pass": "x",
            "rig-id": "$worker_id",
            "nicehash": true,
            "keepalive": true,
            "tls": false,
            "tls-fingerprint": null,
            "daemon": false
        }
    ],
    "print-time": 60,
    "health-print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "cpu-max-threads-hint": $CPU_MAX,
    "cpu-priority": $CPU_PRIORITY,
    "randomx-mode": "fast",
    "background": false,
    "syslog": false,
    "user-agent": null,
    "verbose": 0,
    "watch": false,
    "pause-on-battery": false,
    "pause-on-active": false
}
EOF
    
    # Criar arquivo de configura√ß√£o simples
    cat > "$MINER_CONFIG/config_simple.json" << EOF
{
    "autosave": true,
    "cpu": true,
    "donate-level": 1,
    "pools": [
        {
            "url": "${POOLS[0]}",
            "user": "$BTC_WALLET.$worker_id",
            "pass": "x",
            "nicehash": true,
            "tls": false,
            "keepalive": true
        }
    ]
}
EOF
    
    # Salvar informa√ß√µes do sistema
    echo "WORKER_ID=$worker_id" > "$MINER_CONFIG/system.info"
    echo "BTC_WALLET=$BTC_WALLET" >> "$MINER_CONFIG/system.info"
    echo "INSTALL_DATE=$(date '+%Y-%m-%d %H:%M:%S')" >> "$MINER_CONFIG/system.info"
    echo "CPU_THREADS=$CPU_THREADS" >> "$MINER_CONFIG/system.info"
    echo "POOL=${POOLS[0]}" >> "$MINER_CONFIG/system.info"
    
    # Criar arquivo de pools
    printf '%s\n' "${POOLS[@]}" > "$MINER_CONFIG/pools.list"
    
    log_success "Configuration created for worker: $worker_id"
}

# ============================================================================
# SISTEMA DE BACKUP E RESTORE
# ============================================================================

backup_system() {
    local backup_name="backup_$(date +%Y%m%d_%H%M%S)"
    local backup_path="$MINER_BACKUP/$backup_name"
    
    log_info "Creating system backup: $backup_name"
    
    mkdir -p "$backup_path"
    
    # Copiar configura√ß√µes
    cp -r "$MINER_CONFIG" "$backup_path/"
    
    # Copiar logs importantes
    cp "$MINER_LOGS/system.log" "$backup_path/" 2>/dev/null
    cp "$MINER_LOGS/miner.log" "$backup_path/" 2>/dev/null
    
    # Copiar estat√≠sticas
    cp -r "$MINER_STATS" "$backup_path/" 2>/dev/null
    
    # Criar arquivo de informa√ß√µes
    cat > "$backup_path/backup.info" << EOF
Backup created: $(date '+%Y-%m-%d %H:%M:%S')
Original path: $MINER_ROOT
Worker: $(cat "$MINER_CONFIG/system.info" 2>/dev/null | grep WORKER_ID | cut -d= -f2)
Wallet: $BTC_WALLET
Total shares: $(grep -c "accepted" "$MINER_LOGS/miner.log" 2>/dev/null || echo "0")
EOF
    
    # Compactar backup
    cd "$MINER_BACKUP"
    tar -czf "${backup_name}.tar.gz" "$backup_name"
    rm -rf "$backup_name"
    
    log_success "Backup created: ${backup_name}.tar.gz"
    discord_send "System backup created: $backup_name" "3447003" "üíæ BACKUP CREATED"
}

restore_backup() {
    local backup_file="$1"
    
    if [ ! -f "$backup_file" ]; then
        log_error "Backup file not found: $backup_file"
        return 1
    fi
    
    log_info "Restoring backup: $backup_file"
    
    # Parar minerador se estiver rodando
    if pgrep -f xmrig > /dev/null; then
        pkill -f xmrig
        sleep 3
    fi
    
    # Extrair backup
    tar -xzf "$backup_file" -C "$MINER_ROOT"
    
    log_success "Backup restored successfully"
    discord_send "System restored from backup" "3066993" "üîÑ BACKUP RESTORED"
}

# ============================================================================
# SISTEMA DE MONITORAMENTO
# ============================================================================

start_monitoring_system() {
    log_info "Starting monitoring system..."
    
    # Criar script de monitoramento
    cat > "$MINER_SCRIPTS/monitor.sh" << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

export MINER_ROOT="/data/data/com.termux/files/home/bitcoin_miner_pro"
export MINER_LOGS="$MINER_ROOT/logs"
export MINER_STATS="$MINER_ROOT/stats"

log_monitor() {
    echo "[$(date '+%H:%M:%S')] [MONITOR] $1" >> "$MINER_LOGS/monitor.log"
}

while true; do
    # Verificar se minerador est√° ativo
    if ! pgrep -f xmrig > /dev/null; then
        log_monitor "Miner not running, restarting..."
        cd "$MINER_ROOT"
        ./start_mining.sh >> "$MINER_LOGS/miner.log" 2>&1 &
        sleep 30
    fi
    
    # Coletar estat√≠sticas
    if pgrep -f xmrig > /dev/null; then
        # Hashrate
        if [ -f "$MINER_LOGS/miner.log" ]; then
            hashrate=$(tail -10 "$MINER_LOGS/miner.log" | grep -oE "speed.*[0-9]+\.[0-9]+" | tail -1 | cut -d' ' -f2)
            if [ ! -z "$hashrate" ]; then
                echo "$hashrate" > "$MINER_STATS/current_hashrate"
            fi
        fi
        
        # Shares
        accepted=$(grep -c "accepted" "$MINER_LOGS/miner.log" 2>/dev/null)
        rejected=$(grep -c "rejected" "$MINER_LOGS/miner.log" 2>/dev/null)
        echo "accepted:$accepted" > "$MINER_STATS/shares"
        echo "rejected:$rejected" >> "$MINER_STATS/shares"
        
        # Uptime
        pid=$(pgrep -f xmrig)
        if [ ! -z "$pid" ]; then
            uptime=$(ps -o etimes= -p $pid)
            echo "$uptime" > "$MINER_STATS/uptime"
        fi
    fi
    
    sleep 30
done
EOF
    
    chmod +x "$MINER_SCRIPTS/monitor.sh"
    
    # Iniciar monitoramento em background
    nohup "$MINER_SCRIPTS/monitor.sh" > /dev/null 2>&1 &
    
    log_success "Monitoring system started"
}

# ============================================================================
# DASHBOARD EM TEMPO REAL
# ============================================================================

show_dashboard() {
    clear
    
    # Cabe√ßalho
    echo -e "${COLOR_TITLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${COLOR_TITLE}‚ïë                BITCOIN MINER TERMUX - DASHBOARD                     ‚ïë${NC}"
    echo -e "${COLOR_TITLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # Status do Minerador
    if pgrep -f xmrig > /dev/null; then
        local pid=$(pgrep -f xmrig)
        local uptime=$(ps -o etimes= -p $pid 2>/dev/null | xargs)
        
        echo -e "${COLOR_SUCCESS}‚ñ∂ MINERA√á√ÉO: ATIVA${NC}"
        echo -e "  PID: $pid"
        
        if [ ! -z "$uptime" ]; then
            local hours=$((uptime / 3600))
            local minutes=$(((uptime % 3600) / 60))
            local seconds=$((uptime % 60))
            echo -e "  Uptime: ${hours}h ${minutes}m ${seconds}s"
        fi
        
        # Hashrate atual
        if [ -f "$MINER_STATS/current_hashrate" ]; then
            local hashrate=$(cat "$MINER_STATS/current_hashrate")
            echo -e "  ${COLOR_HASHRATE}Hashrate: $hashrate${NC}"
        fi
    else
        echo -e "${COLOR_ERROR}‚ñ∂ MINERA√á√ÉO: INATIVA${NC}"
    fi
    
    echo ""
    
    # Estat√≠sticas
    echo -e "${COLOR_INFO}üìä ESTAT√çSTICAS:${NC}"
    
    if [ -f "$MINER_STATS/shares" ]; then
        local accepted=$(grep "^accepted:" "$MINER_STATS/shares" | cut -d: -f2)
        local rejected=$(grep "^rejected:" "$MINER_STATS/shares" | cut -d: -f2)
        
        echo -e "  ‚úÖ Shares aceitos: $accepted"
        echo -e "  ‚ùå Shares rejeitados: $rejected"
        
        if [ $((accepted + rejected)) -gt 0 ]; then
            local rate=$(echo "scale=1; $accepted * 100 / ($accepted + $rejected)" | bc)
            echo -e "  üìà Taxa de aceita√ß√£o: ${rate}%"
        fi
    fi
    
    # Lucro estimado
    if [ -f "$MINER_STATS/current_hashrate" ]; then
        local hashrate=$(cat "$MINER_STATS/current_hashrate" | grep -oE "[0-9]+\.[0-9]+" || echo "0")
        local satoshis=$(echo "$hashrate * 100" | bc 2>/dev/null | cut -d. -f1)
        
        if [ ! -z "$satoshis" ] && [ "$satoshis" -gt 0 ]; then
            local btc=$(echo "scale=8; $satoshis / 100000000" | bc)
            local usd=$(echo "scale=2; $btc * 40000" | bc)
            
            echo -e "  ${COLOR_PROFIT}üí∞ Lucro estimado/dia:${NC}"
            echo -e "     $satoshis satoshis"
            echo -e "     $btc BTC"
            echo -e "     \$$usd USD"
        fi
    fi
    
    echo ""
    
    # Logs recentes
    echo -e "${COLOR_INFO}üìã LOGS RECENTES:${NC}"
    
    if [ -f "$MINER_LOGS/miner.log" ]; then
        tail -5 "$MINER_LOGS/miner.log" | while read line; do
            if [[ "$line" == *"accepted"* ]]; then
                echo -e "  ${GREEN}‚úÖ ${line:11:60}...${NC}"
            elif [[ "$line" == *"rejected"* ]]; then
                echo -e "  ${RED}‚ùå ${line:11:60}...${NC}"
            elif [[ "$line" == *"speed"* ]]; then
                echo -e "  ${CYAN}‚ö° ${line:11:60}...${NC}"
            else
                echo "  ${line:11:60}..."
            fi
        done
    fi
    
    echo ""
    
    # Informa√ß√µes do sistema
    echo -e "${COLOR_INFO}üíª SISTEMA:${NC}"
    if [ -f "$MINER_CONFIG/system.info" ]; then
        echo -e "  Worker: $(grep WORKER_ID "$MINER_CONFIG/system.info" | cut -d= -f2)"
        echo -e "  Pool: $(grep POOL "$MINER_CONFIG/system.info" | cut -d= -f2)"
    fi
    echo -e "  Wallet: ${BTC_WALLET:0:10}..."
    
    echo ""
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
}

# ============================================================================
# SISTEMA DE MENU INTERATIVO
# ============================================================================

show_main_menu() {
    while true; do
        clear
        show_dashboard
        
        echo ""
        echo -e "${COLOR_MENU}üéØ MENU PRINCIPAL:${NC}"
        echo ""
        echo "  1) üöÄ Iniciar Minera√ß√£o"
        echo "  2) üõë Parar Minera√ß√£o"
        echo "  3) üîÑ Reiniciar Minerador"
        echo "  4) üìä Dashboard Detalhado"
        echo "  5) üìã Visualizar Logs"
        echo "  6) ‚öôÔ∏è  Configura√ß√µes"
        echo "  7) üíæ Backup/Restore"
        echo "  8) üóëÔ∏è  Desinstalar"
        echo "  9) ‚ùå Sair"
        echo ""
        
        echo -ne "${COLOR_INPUT}Escolha uma op√ß√£o (1-9): ${NC}"
        read choice
        
        case $choice in
            1)
                start_mining
                ;;
            2)
                stop_mining
                ;;
            3)
                restart_mining
                ;;
            4)
                show_detailed_dashboard
                ;;
            5)
                show_logs_menu
                ;;
            6)
                show_settings_menu
                ;;
            7)
                show_backup_menu
                ;;
            8)
                uninstall_system
                ;;
            9)
                exit 0
                ;;
            *)
                echo "Op√ß√£o inv√°lida!"
                sleep 1
                ;;
        esac
    done
}

# ============================================================================
# FUN√á√ïES PRINCIPAIS
# ============================================================================

start_mining() {
    log_info "Starting mining process..."
    
    # Parar se j√° estiver rodando
    if pgrep -f xmrig > /dev/null; then
        log_warning "Miner is already running"
        return 0
    fi
    
    # Iniciar XMRig
    cd "$MINER_ROOT"
    nohup "$MINER_BIN/xmrig" -c "$MINER_CONFIG/config.json" >> "$MINER_LOGS/miner.log" 2>&1 &
    
    sleep 3
    
    if pgrep -f xmrig > /dev/null; then
        local worker=$(grep WORKER_ID "$MINER_CONFIG/system.info" 2>/dev/null | cut -d= -f2)
        log_success "Mining started successfully"
        discord_mining_start "$worker"
        return 0
    else
        log_error "Failed to start mining"
        return 1
    fi
}

stop_mining() {
    log_info "Stopping mining..."
    
    if pgrep -f xmrig > /dev/null; then
        pkill -f xmrig
        sleep 2
        
        if ! pgrep -f xmrig > /dev/null; then
            local worker=$(grep WORKER_ID "$MINER_CONFIG/system.info" 2>/dev/null | cut -d= -f2)
            log_success "Mining stopped"
            discord_mining_stop "$worker"
            return 0
        else
            pkill -9 -f xmrig
            log_warning "Mining force stopped"
            return 0
        fi
    else
        log_warning "Miner is not running"
        return 0
    fi
}

# ============================================================================
# INSTALA√á√ÉO COMPLETA DO SISTEMA
# ============================================================================

install_complete_system() {
    clear
    
    # Banner de instala√ß√£o
    echo -e "${COLOR_TITLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${COLOR_TITLE}‚ïë           INSTALA√á√ÉO DO MINERADOR BITCOIN TERMUX                    ‚ïë${NC}"
    echo -e "${COLOR_TITLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${COLOR_INFO}Este processo instalar√°:${NC}"
    echo "  ‚úÖ Sistema completo de minera√ß√£o Bitcoin"
    echo "  ‚úÖ XMRig com 15 m√©todos de instala√ß√£o"
    echo "  ‚úÖ Dashboard em tempo real"
    echo "  ‚úÖ Sistema de logs para Discord"
    echo "  ‚úÖ Monitoramento autom√°tico 24/7"
    echo "  ‚úÖ Sistema de backup e restore"
    echo "  ‚úÖ Interface profissional"
    echo ""
    echo -e "${COLOR_WARNING}‚ö†Ô∏è  Conecte o carregador para melhor desempenho${NC}"
    echo ""
    
    read -p "Continuar com a instala√ß√£o? (s/n): " confirm
    if [ "$confirm" != "s" ]; then
        exit 0
    fi
    
    # Passo 1: Criar diret√≥rios
    log_info "Step 1: Creating directory structure..."
    mkdir -p "$MINER_ROOT"
    mkdir -p "$MINER_BIN"
    mkdir -p "$MINER_CONFIG"
    mkdir -p "$MINER_LOGS"
    mkdir -p "$MINER_STATS"
    mkdir -p "$MINER_SCRIPTS"
    mkdir -p "$MINER_BACKUP"
    mkdir -p "$MINER_TEMP"
    
    # Passo 2: Instalar depend√™ncias
    log_info "Step 2: Installing dependencies..."
    pkg update -y > /dev/null 2>&1
    pkg upgrade -y > /dev/null 2>&1
    pkg install -y wget curl tar git cmake make build-essential python -y > /dev/null 2>&1
    
    # Passo 3: Instalar XMRig
    log_info "Step 3: Installing XMRig..."
    if ! install_xmrig_comprehensive; then
        log_error "Failed to install XMRig"
        exit 1
    fi
    
    # Passo 4: Criar configura√ß√£o
    log_info "Step 4: Creating configuration..."
    create_configuration
    
    # Passo 5: Configurar monitoramento
    log_info "Step 5: Setting up monitoring..."
    start_monitoring_system
    
    # Passo 6: Criar scripts
    log_info "Step 6: Creating control scripts..."
    create_control_scripts
    
    # Passo 7: Backup inicial
    log_info "Step 7: Creating initial backup..."
    backup_system
    
    # Finaliza√ß√£o
    clear
    echo -e "${COLOR_SUCCESS}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${COLOR_SUCCESS}‚ïë                    INSTALA√á√ÉO CONCLU√çDA!                           ‚ïë${NC}"
    echo -e "${COLOR_SUCCESS}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${COLOR_INFO}üìÅ Diret√≥rio:${NC} $MINER_ROOT"
    echo -e "${COLOR_INFO}üí∞ Carteira:${NC} $BTC_WALLET"
    echo -e "${COLOR_INFO}üë∑ Worker:${NC} $(grep WORKER_ID "$MINER_CONFIG/system.info" 2>/dev/null | cut -d= -f2)"
    echo -e "${COLOR_INFO}‚ö° XMRig:${NC} $("$MINER_BIN/xmrig" --version 2>/dev/null | head -1)"
    echo ""
    echo -e "${COLOR_SUCCESS}‚úÖ Sistema instalado com sucesso!${NC}"
    echo ""
    echo "Para iniciar a minera√ß√£o, selecione a op√ß√£o 1 no menu."
    echo "O sistema iniciar√° automaticamente em 5 segundos..."
    
    sleep 5
    
    # Iniciar menu principal
    show_main_menu
}

# ============================================================================
# INICIALIZA√á√ÉO
# ============================================================================

# Verificar se o sistema j√° est√° instalado
if [ -d "$MINER_ROOT" ] && [ -f "$MINER_BIN/xmrig" ]; then
    # Sistema j√° instalado, mostrar menu
    show_main_menu
else
    # Sistema n√£o instalado, iniciar instala√ß√£o
    install_complete_system
fi
