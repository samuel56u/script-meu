#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# BITCOIN MINER GOD - TERMUX EDITION v1.0
# MineraÃ§Ã£o de Bitcoin via pool (SHA-256)
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURAÃ‡Ã•ES FIXAS
# ----------------------------------------------------------------------------
# !!! SUBSTITUA PELO SEU ENDEREÃ‡O DE BITCOIN !!!
BTC_ADDRESS="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"

# ConfiguraÃ§Ãµes da pool (NiceHash para SHA-256)
POOL_URL="stratum+tcp://sha256.auto.nicehash.com:9200"
# Alternativas:
# POOL_URL="stratum+tcp://us.solomining.io:7777"
# POOL_URL="stratum+tcp://btc.viabtc.com:3333"

WORKER_NAME="termux_miner_$(date +%s)"
PASSWORD="x"

# ConfiguraÃ§Ãµes de CPU
CPU_THREADS=$(($(nproc 2>/dev/null || echo 2) - 1))
[ $CPU_THREADS -lt 1 ] && CPU_THREADS=1
CPU_PRIORITY=5
CPU_MAX=75

# ----------------------------------------------------------------------------
# VARIÃVEIS GLOBAIS
# ----------------------------------------------------------------------------
MINER_ROOT="/data/data/com.termux/files/home/.btc_miner"
MINER_BIN="$MINER_ROOT/bin"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
MINER_TEMP="$MINER_ROOT/temp"

# Criar diretÃ³rios
for dir in "$MINER_BIN" "$MINER_CONFIG" "$MINER_LOGS" "$MINER_STATS" "$MINER_TEMP"; do
    mkdir -p "$dir"
done

# Criar arquivos de log
for logfile in system.log miner.log error.log hashrate.log btc.log; do
    touch "$MINER_LOGS/$logfile"
done

# Cores
NC='\033[0m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'

# ----------------------------------------------------------------------------
# FUNÃ‡Ã•ES AUXILIARES
# ----------------------------------------------------------------------------
log() {
    local level="$1"
    local msg="$2"
    local timestamp="[$(date '+%Y-%m-%d %H:%M:%S')]"
    echo "$timestamp [$level] $msg" >> "$MINER_LOGS/system.log"
    
    case "$level" in
        INFO)  echo -e "${CYAN}[INFO]${NC} $msg" ;;
        OK)    echo -e "${GREEN}[OK]${NC} $msg" ;;
        WARN)  echo -e "${YELLOW}[WARN]${NC} $msg" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} $msg" ;;
        *)     echo "[$level] $msg" ;;
    esac
}

log_info()  { log "INFO" "$1"; }
log_ok()    { log "OK" "$1"; }
log_warn()  { log "WARN" "$1"; }
log_error() { log "ERROR" "$1"; }

detect_arch() {
    local arch=$(uname -m)
    case "$arch" in
        aarch64|arm64) echo "arm64" ;;
        armv7l|armhf)  echo "arm32" ;;
        x86_64|amd64)  echo "x64" ;;
        i*86|x86)      echo "x86" ;;
        *)             echo "unknown" ;;
    esac
}

enable_wake_lock() {
    if command -v termux-wake-lock &>/dev/null; then
        termux-wake-lock
        log_ok "Wake lock ativado"
    fi
}

disable_wake_lock() {
    if command -v termux-wake-unlock &>/dev/null; then
        termux-wake-unlock
    fi
}

install_deps() {
    log_info "Instalando dependÃªncias..."
    
    # Atualizar pacotes
    pkg update -y >/dev/null 2>&1
    
    # Instalar dependÃªncias bÃ¡sicas
    local deps=(curl wget git cmake make libuv openssl jq unzip tar termux-api)
    for pkg in "${deps[@]}"; do
        if ! command -v "$pkg" >/dev/null 2>&1 && ! pkg list-installed 2>/dev/null | grep -q "^$pkg"; then
            pkg install -y "$pkg" >/dev/null 2>&1 && log_ok "$pkg instalado"
        fi
    done
    
    # Instalar compiladores
    pkg install -y clang binutils libmicrohttpd >/dev/null 2>&1
}

# ----------------------------------------------------------------------------
# INSTALAÃ‡ÃƒO DO CPUMINER (SHA-256 para Bitcoin)
# ----------------------------------------------------------------------------
install_cpuminer() {
    if [ -f "$MINER_BIN/cpuminer" ] && "$MINER_BIN/cpuminer" --version >/dev/null 2>&1; then
        log_ok "CPUMiner jÃ¡ estÃ¡ instalado"
        return 0
    fi
    
    log_info "Instalando CPUMiner (SHA-256)..."
    
    cd "$MINER_TEMP"
    
    # MÃ©todo 1: Compilar do cÃ³digo fonte
    log_info "Compilando cpuminer-opt..."
    
    # Remover instalaÃ§Ã£o anterior
    rm -rf cpuminer-opt
    
    # Clonar repositÃ³rio
    if ! git clone --depth=1 https://github.com/JayDDee/cpuminer-opt.git; then
        log_error "Falha ao clonar repositÃ³rio"
        return 1
    fi
    
    cd cpuminer-opt
    
    # Instalar dependÃªncias adicionais para compilaÃ§Ã£o
    pkg install -y automake autoconf libtool curl >/dev/null 2>&1
    
    # Preparar compilaÃ§Ã£o
    ./build.sh > build.log 2>&1
    
    # Configurar
    ./configure --with-curl --without-cuda > configure.log 2>&1
    
    # Compilar
    make -j$(nproc) > make.log 2>&1
    
    if [ -f "cpuminer" ]; then
        cp cpuminer "$MINER_BIN/cpuminer"
        chmod +x "$MINER_BIN/cpuminer"
        
        if "$MINER_BIN/cpuminer" --version >/dev/null 2>&1; then
            log_ok "CPUMiner compilado com sucesso"
            return 0
        fi
    fi
    
    # MÃ©todo 2: Tentar binÃ¡rio prÃ©-compilado
    log_warn "CompilaÃ§Ã£o falhou, tentando binÃ¡rio alternativo..."
    
    cd "$MINER_TEMP"
    local arch=$(detect_arch)
    local url=""
    
    case "$arch" in
        arm64) url="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-aarch64.tar.gz" ;;
        arm32) url="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-armhf.tar.gz" ;;
        x64)   url="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-x86_64.tar.gz" ;;
        *)     return 1 ;;
    esac
    
    wget -q --timeout=30 "$url" -O cpuminer.tar.gz
    if [ -f "cpuminer.tar.gz" ]; then
        tar -xzf cpuminer.tar.gz
        local bin=$(find . -name "cpuminer-*" -type f -executable | head -1)
        if [ -n "$bin" ]; then
            cp "$bin" "$MINER_BIN/cpuminer"
            chmod +x "$MINER_BIN/cpuminer"
            
            if "$MINER_BIN/cpuminer" --version >/dev/null 2>&1; then
                log_ok "BinÃ¡rio alternativo instalado"
                return 0
            fi
        fi
    fi
    
    log_error "Falha na instalaÃ§Ã£o do CPUMiner"
    return 1
}

# ----------------------------------------------------------------------------
# CONFIGURAÃ‡ÃƒO
# ----------------------------------------------------------------------------
configure_miner() {
    log_info "Configurando minerador..."
    
    # Criar arquivo de configuraÃ§Ã£o
    cat > "$MINER_CONFIG/miner.conf" << EOF
{
    "url": "$POOL_URL",
    "user": "$BTC_ADDRESS",
    "pass": "$PASSWORD",
    "worker": "$WORKER_NAME",
    "threads": $CPU_THREADS,
    "cpu-priority": $CPU_PRIORITY,
    "cpu-max-threads-hint": $CPU_MAX,
    "algo": "sha256d"
}
EOF

    # ConfiguraÃ§Ã£o simples para linha de comando
    cat > "$MINER_CONFIG/config.txt" << EOF
-o $POOL_URL
-u $BTC_ADDRESS
-p $PASSWORD
-t $CPU_THREADS
--cpu-priority=$CPU_PRIORITY
--algo=sha256d
EOF

    # Salvar informaÃ§Ãµes do worker
    cat > "$MINER_CONFIG/worker.info" << EOF
WORKER=$WORKER_NAME
POOL=$POOL_URL
ADDRESS=$BTC_ADDRESS
EOF

    log_ok "ConfiguraÃ§Ã£o salva"
}

# ----------------------------------------------------------------------------
# ESTATÃSTICAS
# ----------------------------------------------------------------------------
get_hashrate() {
    if [ -f "$MINER_LOGS/miner.log" ]; then
        local line=$(tail -n 50 "$MINER_LOGS/miner.log" 2>/dev/null | grep -E 'accepted| [0-9.]+\.[0-9]+ [kMG]?H/s' | tail -1)
        if [ -n "$line" ]; then
            if [[ "$line" =~ ([0-9.]+\ [kMG]?H/s) ]]; then
                echo "${BASH_REMATCH[1]}"
            else
                echo "0 H/s"
            fi
        else
            echo "0 H/s"
        fi
    else
        echo "0 H/s"
    fi
}

get_hashrate_value() {
    local h=$(get_hashrate)
    echo "$h" | awk '{print $1}' | grep -E '^[0-9.]+$' || echo "0"
}

get_accepted_shares() {
    if [ -f "$MINER_LOGS/miner.log" ]; then
        tail -n 200 "$MINER_LOGS/miner.log" 2>/dev/null | grep -c 'accepted' || echo 0
    else
        echo 0
    fi
}

get_rejected_shares() {
    if [ -f "$MINER_LOGS/miner.log" ]; then
        tail -n 200 "$MINER_LOGS/miner.log" 2>/dev/null | grep -c 'rejected' || echo 0
    else
        echo 0
    fi
}

get_uptime_seconds() {
    if pgrep -f cpuminer >/dev/null; then
        local pid=$(pgrep -f cpuminer | head -1)
        local uptime=$(ps -o etimes= -p $pid 2>/dev/null | xargs)
        echo "${uptime:-0}"
    else
        echo 0
    fi
}

update_stats() {
    local hashrate_val=$(get_hashrate_value)
    local accepted=$(get_accepted_shares)
    local rejected=$(get_rejected_shares)
    
    echo "$hashrate_val" > "$MINER_STATS/current_hashrate"
    echo "$accepted" > "$MINER_STATS/accepted_shares"
    echo "$rejected" > "$MINER_STATS/rejected_shares"
    
    echo "$(date '+%Y-%m-%d %H:%M:%S') | HR: $hashrate_val H/s | A: $accepted | R: $rejected" >> "$MINER_LOGS/hashrate.log"
    
    # Estimar ganhos (muito aproximado)
    if (( $(echo "$hashrate_val > 0" | bc -l) )); then
        # Estimativa baseada em hashrate (valores aproximados)
        local btc_per_day=$(echo "scale=10; $hashrate_val * 0.0000000000000001" | bc 2>/dev/null || echo "0")
        local usd_per_day=$(echo "scale=2; $btc_per_day * 45000" | bc 2>/dev/null || echo "0")
        
        echo "Estimativa: ~$btc_per_day BTC/dia (~\$$usd_per_day USD/dia)" >> "$MINER_LOGS/btc.log"
    fi
}

# ----------------------------------------------------------------------------
# INICIAR MINERAÃ‡ÃƒO
# ----------------------------------------------------------------------------
start_mining() {
    if pgrep -f cpuminer >/dev/null; then
        log_warn "MineraÃ§Ã£o jÃ¡ estÃ¡ ativa"
        return 1
    fi
    
    # Instalar minerador se necessÃ¡rio
    if [ ! -f "$MINER_BIN/cpuminer" ]; then
        install_cpuminer || { log_error "Falha na instalaÃ§Ã£o"; return 1; }
    fi
    
    # Configurar se necessÃ¡rio
    if [ ! -f "$MINER_CONFIG/miner.conf" ]; then
        configure_miner
    fi
    
    enable_wake_lock
    
    log_info "Iniciando mineraÃ§Ã£o de Bitcoin..."
    log_info "Pool: $POOL_URL"
    log_info "EndereÃ§o: $BTC_ADDRESS"
    log_info "Threads: $CPU_THREADS"
    
    cd "$MINER_ROOT"
    
    # Iniciar minerador
    nohup "$MINER_BIN/cpuminer" \
        -o "$POOL_URL" \
        -u "$BTC_ADDRESS" \
        -p "$PASSWORD" \
        -t "$CPU_THREADS" \
        --cpu-priority="$CPU_PRIORITY" \
        --algo=sha256d \
        --quiet \
        >> "$MINER_LOGS/miner.log" 2>&1 &
    
    local pid=$!
    echo $pid > "$MINER_STATS/miner.pid"
    
    sleep 3
    
    if kill -0 $pid 2>/dev/null; then
        log_ok "MineraÃ§Ã£o iniciada (PID: $pid)"
        
        # Loop de estatÃ­sticas
        (
            while kill -0 $pid 2>/dev/null; do
                update_stats
                sleep 60
            done
        ) &
        echo $! > "$MINER_STATS/stats_loop.pid"
        
        return 0
    else
        log_error "Falha ao iniciar mineraÃ§Ã£o"
        tail -20 "$MINER_LOGS/miner.log" | while read line; do
            log_error "$line"
        done
        return 1
    fi
}

stop_mining() {
    pkill -f cpuminer
    [ -f "$MINER_STATS/stats_loop.pid" ] && kill $(cat "$MINER_STATS/stats_loop.pid") 2>/dev/null
    disable_wake_lock
    log_ok "MineraÃ§Ã£o parada"
}

restart_mining() {
    stop_mining
    sleep 2
    start_mining
}

# ----------------------------------------------------------------------------
# MONITORAMENTO
# ----------------------------------------------------------------------------
monitor_loop() {
    log_info "Monitoramento iniciado. Pressione Ctrl+C para parar."
    
    while true; do
        clear
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${PURPLE}         BITCOIN MINER - TERMUX${NC}"
        echo -e "${PURPLE}         $(date '+%d/%m/%Y %H:%M:%S')${NC}"
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        
        if pgrep -f cpuminer >/dev/null; then
            hashrate=$(get_hashrate)
            accepted=$(get_accepted_shares)
            rejected=$(get_rejected_shares)
            pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
            pool_short=$(echo "$pool" | cut -d/ -f3 | cut -d: -f1)
            uptime_sec=$(get_uptime_seconds)
            uptime_str="$((uptime_sec/3600))h $(((uptime_sec%3600)/60))m $((uptime_sec%60))s"
            
            echo -e "${GREEN}â–¶ MineraÃ§Ã£o: ATIVA${NC}"
            echo "   PID: $(pgrep -f cpuminer | head -1)"
            echo "   Uptime: $uptime_str"
            echo "   Threads: $CPU_THREADS"
            echo ""
            echo -e "${CYAN}âš¡ EstatÃ­sticas:${NC}"
            echo "   Hashrate: $hashrate"
            echo "   Shares Aceitas: $accepted"
            echo "   Shares Rejeitadas: $rejected"
            echo ""
            echo -e "${CYAN}ğŸŒ Pool:${NC} ${pool_short:-N/A}"
            echo -e "${CYAN}ğŸ‘› EndereÃ§o BTC:${NC} ${BTC_ADDRESS:0:20}..."
            echo ""
            
            # Calcular estimativas
            if [ "$accepted" -gt 0 ]; then
                echo -e "${YELLOW}ğŸ’° Estimativas (aproximadas):${NC}"
                echo "   BTC/dia: ~0.00000001 (extremamente baixo em CPU)"
                echo "   USD/dia: ~\$0.0005"
                echo ""
                echo -e "${RED}âš ï¸  AVISO: MineraÃ§Ã£o de Bitcoin com CPU nÃ£o Ã© lucrativa${NC}"
                echo "   Use apenas para aprendizado ou diversÃ£o!"
            fi
        else
            echo -e "${RED}â–¶ MineraÃ§Ã£o: INATIVA${NC}"
            echo ""
            echo -e "${YELLOW}Tentando reiniciar...${NC}"
            start_mining
        fi
        
        echo ""
        echo -e "${YELLOW}Pressione Ctrl+C para parar${NC}"
        sleep 30
    done
}

# ----------------------------------------------------------------------------
# WATCHDOG SIMPLES
# ----------------------------------------------------------------------------
start_watchdog() {
    (
        while true; do
            if pgrep -f cpuminer >/dev/null; then
                pid=$(pgrep -f cpuminer | head -1)
                if ! kill -0 $pid 2>/dev/null; then
                    log_warn "Minerador parou, reiniciando..."
                    restart_mining
                fi
            else
                log_warn "Minerador nÃ£o estÃ¡ rodando, iniciando..."
                start_mining
            fi
            sleep 60
        done
    ) &
    echo $! > "$MINER_STATS/watchdog.pid"
    log_ok "Watchdog iniciado"
}

stop_watchdog() {
    [ -f "$MINER_STATS/watchdog.pid" ] && kill $(cat "$MINER_STATS/watchdog.pid") 2>/dev/null
}

# ----------------------------------------------------------------------------
# LIMPEZA
# ----------------------------------------------------------------------------
clean_exit() {
    echo -e "\n${YELLOW}Encerrando...${NC}"
    stop_watchdog
    stop_mining
    
    # Mostrar estatÃ­sticas finais
    accepted=$(get_accepted_shares)
    echo -e "\n${GREEN}=== EstatÃ­sticas Finais ===${NC}"
    echo "Shares Aceitas: $accepted"
    echo "Hashrate Final: $(get_hashrate)"
    echo ""
    echo "Logs salvos em: $MINER_LOGS"
    
    exit 0
}

# ----------------------------------------------------------------------------
# MAIN
# ----------------------------------------------------------------------------
trap clean_exit SIGINT SIGTERM

# Verificar argumentos
case "$1" in
    --stop)
        stop_mining
        exit 0
        ;;
    --restart)
        restart_mining
        exit 0
        ;;
    --status)
        if pgrep -f cpuminer >/dev/null; then
            echo "MineraÃ§Ã£o: ATIVA"
            echo "Hashrate: $(get_hashrate)"
            echo "Shares: $(get_accepted_shares) aceitas / $(get_rejected_shares) rejeitadas"
        else
            echo "MineraÃ§Ã£o: INATIVA"
        fi
        exit 0
        ;;
esac

# Verificar Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}Este script deve ser executado no Termux!${NC}"
    exit 1
fi

# Mostrar banner
clear
echo -e "${PURPLE}"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
echo "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘"
echo "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘"
echo "â•šâ•â•â•â•â•â• â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â•"
echo -e "${NC}"
echo -e "${PURPLE}ğŸ”¥ MINERADOR DE BITCOIN PARA TERMUX ğŸ”¥${NC}\n"

echo -e "${YELLOW}âš ï¸  AVISO IMPORTANTE:${NC}"
echo -e "MineraÃ§Ã£o de Bitcoin com CPU NÃƒO Ã© lucrativa!"
echo -e "Hashrate de CPU: ~10-50 H/s (enquanto pools exigem TH/s)"
echo -e "Use apenas para aprendizado ou diversÃ£o!\n"

echo -e "${CYAN}EndereÃ§o BTC configurado:${NC} $BTC_ADDRESS"
echo -e "${CYAN}Pool:${NC} $POOL_URL"
echo -e "${CYAN}Threads:${NC} $CPU_THREADS\n"

# Confirmar
read -p "Deseja continuar? (s/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Ss]$ ]]; then
    exit 0
fi

# Instalar dependÃªncias
install_deps

# Iniciar
start_mining
start_watchdog

# Monitorar
monitor_loop
