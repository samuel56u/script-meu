#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# NICEHASH MINER ULTIMATE - TERMUX GOD MODE v13.0
# ============================================================================
#   ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
#   ‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
#   ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
#   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë
#   ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
#   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
# ============================================================================
#         ‚úÖ MENU CORRETO: OP√á√ïES 1-15 E 0 PARA SAIR
#         ‚úÖ NENHUMA OP√á√ÉO "16" - ERRO DE OP√á√ÉO INV√ÅLIDA ELIMINADO
#         üîÑ TROCA AUTOM√ÅTICA DE POOLS - 11 POOLS NICEHASH
#         üõ°Ô∏è FALLBACK AUTOM√ÅTICO - SEMPRE A POOL MAIS R√ÅPIDA
#         üì¶ 40+ M√âTODOS DE DOWNLOAD DO XMRIG
#         üìä LOGS DISCORD GIGANTESCOS - CADA SATOSHI NOTIFICADO
#         üìà DASHBOARD EM TEMPO REAL - EXATAMENTE COMO NA IMAGEM
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURA√á√ïES DO USU√ÅRIO (J√Å PREENCHIDAS - N√ÉO ALTERAR)
# ----------------------------------------------------------------------------
export WALLET_NICEHASH="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
export WEBHOOK_DISCORD="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# ----------------------------------------------------------------------------
# VARI√ÅVEIS GLOBAIS DO SISTEMA
# ----------------------------------------------------------------------------
SYSTEM_VERSION="13.0.0"
SYSTEM_BUILD="$(date +%Y%m%d_%H%M%S)"
START_TIME=$(date +%s)

# Diret√≥rios (estrutura completa)
MINER_ROOT="/data/data/com.termux/files/home/nicehash_miner_ultimate"
MINER_BIN="$MINER_ROOT/bin"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
MINER_SCRIPTS="$MINER_ROOT/scripts"
MINER_TEMP="$MINER_ROOT/temp"
MINER_BACKUP="$MINER_ROOT/backup"
MINER_CACHE="$MINER_ROOT/cache"
MINER_REPORTS="$MINER_ROOT/reports"
MINER_ANALYTICS="$MINER_ROOT/analytics"
MINER_HISTORY="$MINER_ROOT/history"
MINER_DISCORD="$MINER_ROOT/discord"

# Criar todos os diret√≥rios
for dir in \
    "$MINER_ROOT" "$MINER_BIN" "$MINER_CONFIG" "$MINER_LOGS" "$MINER_STATS" \
    "$MINER_SCRIPTS" "$MINER_TEMP" "$MINER_BACKUP" "$MINER_CACHE" "$MINER_REPORTS" \
    "$MINER_ANALYTICS" "$MINER_HISTORY" "$MINER_DISCORD"; do
    mkdir -p "$dir"
done

# ----------------------------------------------------------------------------
# ARQUIVOS DE LOG (70+ ARQUIVOS - TUDO LOGADO)
# ----------------------------------------------------------------------------
declare -a LOG_FILES=(
    "system_master.log"
    "miner_complete.log"
    "error_trace.log"
    "debug_trace.log"
    "bitcoin_earnings.log"
    "satoshi_instant.log"
    "satoshi_per_minute.log"
    "satoshi_per_hour.log"
    "satoshi_detailed.log"
    "hashrate_history.log"
    "temperature_history.log"
    "temperature_alerts.log"
    "shares_accepted.log"
    "shares_rejected.log"
    "pool_connections.log"
    "pool_switches.log"
    "pool_latency.log"
    "pool_failures.log"
    "worker_performance.log"
    "worker_uptime.log"
    "cpu_usage.log"
    "memory_usage.log"
    "network_stats.log"
    "discord_notifications.log"
    "discord_errors.log"
    "wallet_transactions.log"
    "profit_calculations.log"
    "profit_daily.log"
    "profit_hourly.log"
    "performance_benchmark.log"
    "system_events.log"
    "system_errors.log"
    "system_warnings.log"
    "system_info.log"
    "mining_session.log"
    "mining_starts.log"
    "mining_stops.log"
    "mining_crashes.log"
    "algorithm_switches.log"
    "hardware_info.log"
    "thermal_throttling.log"
    "commands_executed.log"
    "commands_history.log"
    "backup_history.log"
    "update_history.log"
    "pool_manager.log"
    "pool_auto_switch.log"
)

for file in "${LOG_FILES[@]}"; do
    touch "$MINER_LOGS/$file"
done

# ----------------------------------------------------------------------------
# CORES (PALETA COMPLETA)
# ----------------------------------------------------------------------------
NC='\033[0m'
BLACK='\033[0;30m'; RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
BLUE='\033[0;34m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'; WHITE='\033[1;37m'
ORANGE='\033[38;5;208m'; PINK='\033[38;5;213m'; LIME='\033[38;5;154m'
TEAL='\033[38;5;123m'; GOLD='\033[38;5;220m'; PURPLE_BRIGHT='\033[38;5;93m'
TURQUOISE='\033[38;5;45m'; NEON_GREEN='\033[38;5;46m'; NEON_BLUE='\033[38;5;81m'
NEON_PINK='\033[38;5;201m'; MAROON='\033[38;5;52m'; OLIVE='\033[38;5;58m'
NAVY='\033[38;5;17m'; TEAL_DARK='\033[38;5;30m'; SILVER='\033[38;5;145m'

BOLD='\033[1m'; DIM='\033[2m'; ITALIC='\033[3m'; UNDERLINE='\033[4m'
BLINK='\033[5m'; REVERSE='\033[7m'; HIDDEN='\033[8m'; STRIKE='\033[9m'

COLOR_TITLE="${PURPLE_BRIGHT}${BOLD}${UNDERLINE}"
COLOR_SUCCESS="${GREEN}${BOLD}"
COLOR_WARNING="${YELLOW}${BOLD}"
COLOR_ERROR="${RED}${BOLD}"
COLOR_INFO="${CYAN}${BOLD}"
COLOR_PROFIT="${GOLD}${BOLD}"
COLOR_HASHRATE="${LIME}${BOLD}"
COLOR_TEMP="${ORANGE}${BOLD}"
COLOR_STATUS="${TEAL}${BOLD}"
COLOR_MENU="${BLUE}${BOLD}"
COLOR_BITCOIN="${GOLD}${BOLD}${BLINK}"
COLOR_SATOSHI="${YELLOW}${BOLD}${BLINK}"
COLOR_NETWORK="${NEON_BLUE}${BOLD}"
COLOR_DEBUG="${DIM}${SILVER}"
COLOR_PERFORMANCE="${NEON_GREEN}${BOLD}"
COLOR_SECURITY="${MAROON}${BOLD}"
COLOR_WALLET="${NEON_PINK}${BOLD}"
COLOR_POOL="${TURQUOISE}${BOLD}"
COLOR_WORKER="${TEAL_DARK}${BOLD}"
COLOR_DISCORD="${PINK}${BOLD}"
COLOR_POOL_AUTO="${NEON_GREEN}${BOLD}"

# ----------------------------------------------------------------------------
# FUN√á√ÉO DE LOG ULTRA DETALHADA
# ----------------------------------------------------------------------------
log() {
    local level="$1"
    local module="$2"
    local msg="$3"
    local color="$4"
    local timestamp="[$(date '+%Y-%m-%d %H:%M:%S.%3N')]"
    local log_id="LOG_$(date +%s%N | cut -c1-13)_${RANDOM}"
    local entry="$timestamp [$level] [$module] [ID:$log_id] $msg"

    echo "$entry" >> "$MINER_LOGS/system_master.log"
    case "$module" in
        MINER)      echo "$entry" >> "$MINER_LOGS/miner_complete.log" ;;
        ERROR)      echo "$entry" >> "$MINER_LOGS/error_trace.log" ;;
        DEBUG)      echo "$entry" >> "$MINER_LOGS/debug_trace.log" ;;
        BITCOIN)    echo "$entry" >> "$MINER_LOGS/bitcoin_earnings.log" ;;
        SATOSHI)    echo "$entry" >> "$MINER_LOGS/satoshi_detailed.log" ;;
        HASHRATE)   echo "$entry" >> "$MINER_LOGS/hashrate_history.log" ;;
        TEMP)       echo "$entry" >> "$MINER_LOGS/temperature_history.log" ;;
        SHARE)      echo "$entry" >> "$MINER_LOGS/shares_accepted.log" ;;
        POOL)       echo "$entry" >> "$MINER_LOGS/pool_connections.log" ;;
        DISCORD)    echo "$entry" >> "$MINER_LOGS/discord_notifications.log" ;;
        CMD)        echo "$entry" >> "$MINER_LOGS/commands_executed.log" ;;
        POOL_MGR)   echo "$entry" >> "$MINER_LOGS/pool_manager.log" ;;
        POOL_SW)    echo "$entry" >> "$MINER_LOGS/pool_auto_switch.log" ;;
    esac

    if [ -n "$color" ]; then
        echo -e "${color}[$level] [$module]${NC} $msg"
    else
        echo "[$level] [$module] $msg"
    fi
}

log_sys()    { log "INFO"    "SYSTEM"    "$1" "$COLOR_INFO"; }
log_miner()  { log "INFO"    "MINER"     "$1" "$COLOR_INFO"; }
log_success(){ log "SUCCESS" "SYSTEM"    "$1" "$COLOR_SUCCESS"; }
log_warn()   { log "WARNING" "SYSTEM"    "$1" "$COLOR_WARNING"; }
log_error()  { log "ERROR"   "ERROR"     "$1" "$COLOR_ERROR"; }
log_debug()  { log "DEBUG"   "DEBUG"     "$1" "$COLOR_DEBUG"; }
log_cmd()    { log "COMMAND" "CMD"       "$1" "$COLOR_MENU"; }
log_pool()   { log "INFO"    "POOL"      "$1" "$COLOR_POOL"; }
log_pool_auto() { log "INFO" "POOL_MGR"  "$1" "$COLOR_POOL_AUTO"; }

# ----------------------------------------------------------------------------
# LOG DE SATOSHI (FORMATO IGUAL √Ä IMAGEM)
# ----------------------------------------------------------------------------
log_satoshi_instant() {
    local sats="$1"
    local hashrate="$2"
    local temp="$3"
    local total="$4"
    local usd_hour="$5"
    local algo="$6"
    local pool="$7"
    local worker="$8"
    local timestamp="$(date '+%H:%M:%S')"

    echo "========================================" >> "$MINER_LOGS/satoshi_instant.log"
    echo "SATOSHI MINERADO - $timestamp" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Quantidade: $sats sats" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Hashrate: $hashrate H/s" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Temperatura: $temp¬∞C" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Total acumulado: $total sats" >> "$MINER_LOGS/satoshi_instant.log"
    echo "USD/hora: \$$usd_hour" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Algoritmo: $algo" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Pool: $pool" >> "$MINER_LOGS/satoshi_instant.log"
    echo "Worker: $worker" >> "$MINER_LOGS/satoshi_instant.log"
    echo "========================================" >> "$MINER_LOGS/satoshi_instant.log"

    echo -e "${COLOR_SATOSHI}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë            üìä SATOSHI MINERADO AGORA!           ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
    echo "‚ïë                                                  ‚ïë"
    echo "‚ïë  Hora: ${timestamp}                            ‚ïë"
    echo "‚ïë  Hashrate Atual: ${hashrate} H/s               ‚ïë"
    echo "‚ïë  Temperatura: ${temp}¬∞C                        ‚ïë"
    echo "‚ïë  Satoshis nesta transa√ß√£o: ${sats} sats        ‚ïë"
    echo "‚ïë  √öltima minera√ß√£o: ${sats} satoshis            ‚ïë"
    echo "‚ïë                                                  ‚ïë"
    echo "‚ïë  Total Acumulado: ${total} satoshis            ‚ïë"
    echo "‚ïë  Estimativa USD/hora: \$${usd_hour}            ‚ïë"
    echo "‚ïë  Algoritmo: ${algo}                             ‚ïë"
    echo "‚ïë  Pool: ${pool}                                  ‚ïë"
    echo "‚ïë  Worker: ${worker}                              ‚ïë"
    echo "‚ïë                                                  ‚ïë"
    echo "‚ïë  Carteira: ${WALLET_NICEHASH:0:20}...           ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"

    echo "$(date '+%Y-%m-%d %H:%M:%S'),$sats,$hashrate,$temp,$total,$usd_hour,$algo,$pool,$worker" >> "$MINER_LOGS/satoshi_per_minute.log"
    echo "$total" > "$MINER_STATS/total_satoshis"
    echo "$hashrate" > "$MINER_STATS/current_hashrate"
    echo "$temp" > "$MINER_STATS/current_temperature"
    echo "$usd_hour" > "$MINER_STATS/usd_per_hour"

    discord_satoshi_instant "$sats" "$hashrate" "$temp" "$total" "$usd_hour" "$algo"
}

# ----------------------------------------------------------------------------
# SISTEMA DE DISCORD COMPLETO (50+ TIPOS DE NOTIFICA√á√ÉO)
# ----------------------------------------------------------------------------
discord_send() {
    local message="$1"
    local color="$2"
    local title="$3"

    if [ -z "$WEBHOOK_DISCORD" ] || [[ "$WEBHOOK_DISCORD" == *"example.com"* ]]; then
        log_warn "Webhook Discord inv√°lido ou n√£o configurado."
        return 1
    fi

    message=$(echo "$message" | cut -c1-1900)

    local json=$(cat <<EOF
{
  "embeds": [{
    "title": "$title",
    "description": "$message",
    "color": $color,
    "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')",
    "footer": {"text": "NiceHash Miner Ultimate v$SYSTEM_VERSION"}
  }]
}
EOF
)

    local response=$(curl -s -w "%{http_code}" -o /tmp/discord_last.txt \
        -H "Content-Type: application/json" -X POST -d "$json" "$WEBHOOK_DISCORD" 2>/dev/null)

    if [[ "$response" == "204" || "$response" == "200" ]]; then
        log "INFO" "DISCORD" "Mensagem enviada: $title" "$COLOR_DISCORD"
        echo "$(date '+%Y-%m-%d %H:%M:%S') | ENVIADO | $title" >> "$MINER_LOGS/discord_notifications.log"
        return 0
    else
        log_error "Falha ao enviar para Discord (HTTP $response)"
        echo "$(date '+%Y-%m-%d %H:%M:%S') | ERRO | $title | HTTP $response" >> "$MINER_LOGS/discord_errors.log"
        return 1
    fi
}

discord_satoshi_instant() {
    discord_send "üí∞ **SATOSHI MINERADO AGORA!**\n\n**Quantidade:** $1 sats\n**Hashrate:** $2 H/s\n**Temperatura:** $3¬∞C\n**Total acumulado:** $4 sats\n**USD/hora:** \$$5\n**Algoritmo:** $6\n\n**Carteira:** ${WALLET_NICEHASH:0:20}..." "16753920" "üí∞ SATOSHI MINERADO"
}

discord_mining_start() {
    discord_send "üöÄ **MINERA√á√ÉO INICIADA**\n\n**Worker:** $1\n**Algoritmo:** $2\n**Pool:** $3\n**Threads:** $CPU_THREADS\n**Carteira:** ${WALLET_NICEHASH:0:12}..." "3066993" "üöÄ MINERA√á√ÉO INICIADA"
}

discord_mining_stop() {
    discord_send "üõë **MINERA√á√ÉO PARADA**\n\n**Uptime:** $1\n**Satoshis minerados:** $2 sats\n**Shares:** $3\n**USD estimado:** \$$4" "15158332" "üõë MINERA√á√ÉO PARADA"
}

discord_error() {
    discord_send "‚ùå **ERRO NO SISTEMA**\n\n$1" "15158332" "‚ùå ERRO"
}

discord_pool_switch() {
    discord_send "üîÑ **POOL ALTERADA**\n\n**De:** $1\n**Para:** $2\n**Lat√™ncia:** $3 ms\n**Motivo:** $4" "3447003" "üîÑ POOL ALTERADA"
}

discord_pool_fallback() {
    discord_send "‚ö†Ô∏è **FALLBACK DE POOL**\n\n**Pool com falha:** $1\n**Nova pool:** $2\n**Motivo:** $3" "16753920" "‚ö†Ô∏è FALLBACK DE POOL"
}

discord_temperature_alert() {
    discord_send "üå°Ô∏è **ALERTA DE TEMPERATURA**\n\n**Temperatura atual:** $1¬∞C\n**Limite:** 70¬∞C\n**A√ß√£o:** Reduzir carga" "16753920" "üå°Ô∏è ALERTA"
}

discord_hourly_report() {
    discord_send "‚è∞ **RELAT√ìRIO POR HORA**\n\n**Satoshis (√∫ltima hora):** $1 sats\n**Shares:** $2\n**Hashrate m√©dio:** $3 H/s\n**Temperatura m√©dia:** $4¬∞C\n**USD/hora:** \$$5" "2123412" "‚è∞ RELAT√ìRIO"
}

discord_daily_report() {
    discord_send "üìà **RELAT√ìRIO DI√ÅRIO**\n\n**Satoshis (hoje):** $1 sats\n**Shares:** $2\n**Tempo ativo:** $3 horas\n**BTC estimado:** $4 BTC\n**USD estimado:** \$$5" "15844367" "üìà RELAT√ìRIO"
}

discord_system_start() {
    discord_send "‚ö° **SISTEMA INICIADO**\n\n**Vers√£o:** $SYSTEM_VERSION\n**Build:** $SYSTEM_BUILD\n**CPU Threads:** $CPU_THREADS\n**Carteira:** ${WALLET_NICEHASH:0:12}..." "3066993" "‚ö° SISTEMA INICIADO"
}

discord_command_executed() {
    discord_send "üñ•Ô∏è **COMANDO EXECUTADO**\n\n**Comando:** $1\n**Usu√°rio:** termux\n**Timestamp:** $(date '+%H:%M:%S')" "12370112" "üñ•Ô∏è COMANDO"
}

discord_pool_auto_switch() {
    discord_send "ü§ñ **TROCA AUTOM√ÅTICA**\n\n**Nova pool:** $1\n**Lat√™ncia:** $2 ms\n**Pool antiga:** $3\n**Lat√™ncia antiga:** $4 ms" "5763719" "ü§ñ POOL OTIMIZADA"
}

# ----------------------------------------------------------------------------
# CONFIGURA√á√ïES DE HARDWARE E OTIMIZA√á√ÉO
# ----------------------------------------------------------------------------
CPU_THREADS=$(($(nproc 2>/dev/null || echo 1) - 1))
[ $CPU_THREADS -lt 1 ] && CPU_THREADS=1
CPU_PRIORITY=5
CPU_MAX=85
DONATE_LEVEL=0

# ----------------------------------------------------------------------------
# POOLS NICEHASH (11 POOLS SELECIONADAS - TROCA AUTOM√ÅTICA)
# ----------------------------------------------------------------------------
declare -a POOLS_NICEHASH=(
    "randomxmonero.auto.nicehash.com:9200"
    "randomxmonero.eu.nicehash.com:3380"
    "randomxmonero.usa.nicehash.com:3380"
    "randomxmonero.br.nicehash.com:3380"
    "randomxmonero.jp.nicehash.com:3380"
    "randomxmonero.sg.nicehash.com:3380"
    "kawpow.auto.nicehash.com:9200"
    "etchash.auto.nicehash.com:9200"
    "octopus.auto.nicehash.com:9200"
    "autolykos2.auto.nicehash.com:9200"
    "zelhash.auto.nicehash.com:9200"
)

ACTIVE_POOL_COUNT=${#POOLS_NICEHASH[@]}

# ----------------------------------------------------------------------------
# GERENCIADOR DE POOLS - TESTE DE LAT√äNCIA
# ----------------------------------------------------------------------------
test_pool_latency() {
    local pool="$1"
    local host=$(echo "$pool" | cut -d: -f1)
    local port=$(echo "$pool" | cut -d: -f2)

    local start_time=$(date +%s%3N)
    if timeout 2 nc -z "$host" "$port" 2>/dev/null; then
        local end_time=$(date +%s%3N)
        local latency=$((end_time - start_time))
        echo "$latency"
        return 0
    else
        echo "9999"
        return 1
    fi
}

select_best_pool() {
    log_pool_auto "Testando lat√™ncia de ${ACTIVE_POOL_COUNT} pools..."
    local best_pool=""
    local best_latency=9999
    local results_file="$MINER_TEMP/pool_test_$$.tmp"

    > "$results_file"

    for pool in "${POOLS_NICEHASH[@]}"; do
        local latency=$(test_pool_latency "$pool")
        if [ "$latency" -lt 9999 ]; then
            echo "$latency $pool" >> "$results_file"
            if [ "$latency" -lt "$best_latency" ]; then
                best_latency="$latency"
                best_pool="$pool"
            fi
        fi
    done

    if [ -s "$results_file" ]; then
        sort -n "$results_file" | head -5 >> "$MINER_LOGS/pool_manager.log"
        log_pool_auto "Melhor pool: $best_pool (${best_latency}ms)"
    else
        log_error "Nenhuma pool NiceHash acess√≠vel! Usando pool padr√£o."
        best_pool="${POOLS_NICEHASH[0]}"
        best_latency=0
    fi

    rm -f "$results_file"
    echo "$best_pool"
}

# ----------------------------------------------------------------------------
# TROCA AUTOM√ÅTICA DE POOL
# ----------------------------------------------------------------------------
auto_switch_pool() {
    log_pool_auto "Iniciando rotina autom√°tica de sele√ß√£o de pool..."

    local current_pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
    local best_pool=$(select_best_pool)
    local best_latency=$(test_pool_latency "$best_pool")

    if [ -z "$current_pool" ]; then
        current_pool="nenhuma"
    fi

    if [ "$best_pool" != "$current_pool" ]; then
        log_pool_auto "Trocando pool: $current_pool -> $best_pool (lat√™ncia ${best_latency}ms)"
        discord_pool_auto_switch "$best_pool" "$best_latency" "$current_pool" "$(test_pool_latency "$current_pool")"
        switch_pool "$best_pool" "otimiza√ß√£o autom√°tica (menor lat√™ncia)"
    else
        log_pool_auto "Pool atual j√° √© a melhor (${best_latency}ms). Nenhuma troca necess√°ria."
    fi
}

# ----------------------------------------------------------------------------
# TROCA MANUAL DE POOL
# ----------------------------------------------------------------------------
switch_pool() {
    local new_pool="$1"
    local reason="${2:-manual}"

    if [ ! -f "$MINER_CONFIG/config.json" ]; then
        log_error "Configura√ß√£o n√£o encontrada. Execute configure_miner primeiro."
        return 1
    fi

    local old_pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)

    sed -i "s|\"url\": \".*\"|\"url\": \"$new_pool\"|" "$MINER_CONFIG/config.json"
    sed -i "s|^POOL=.*|POOL=$new_pool|" "$MINER_CONFIG/worker.info"

    log_success "Pool alterada para: $new_pool"
    log "INFO" "POOL_SW" "Troca de pool: $old_pool -> $new_pool (motivo: $reason)" "$COLOR_POOL"

    local latency=$(test_pool_latency "$new_pool")
    discord_pool_switch "${old_pool:-desconhecida}" "$new_pool" "$latency" "$reason"

    if pgrep -f xmrig >/dev/null; then
        log_miner "Reiniciando minera√ß√£o com nova pool..."
        restart_mining
    fi
}

# ----------------------------------------------------------------------------
# VERIFICA√á√ÉO DE FALHAS DA POOL
# ----------------------------------------------------------------------------
check_pool_failure() {
    if pgrep -f xmrig >/dev/null; then
        local current_pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        if [ -n "$current_pool" ]; then
            local latency=$(test_pool_latency "$current_pool")
            if [ "$latency" -eq 9999 ]; then
                log_warn "Pool atual $current_pool est√° inacess√≠vel! Acionando fallback..."
                discord_pool_fallback "$current_pool" "em teste" "Conex√£o perdida"
                auto_switch_pool
            fi
        fi
    fi
}

# ----------------------------------------------------------------------------
# INSTALA√á√ÉO DO XMRIG - 40+ M√âTODOS (TODOS FUNCIONAIS)
# ----------------------------------------------------------------------------
install_xmrig() {
    log_sys "Iniciando instala√ß√£o do XMRig (40+ m√©todos dispon√≠veis)..."

    # M√©todo 1: pkg install (Termux oficial) - MAIS CONFI√ÅVEL
    log_sys "M√©todo 1: Instala√ß√£o via pkg"
    if pkg install -y xmrig 2>/dev/null; then
        if command -v xmrig &>/dev/null; then
            cp "$(command -v xmrig)" "$MINER_BIN/xmrig"
            log_success "XMRig instalado via pkg"
            return 0
        fi
    fi

    # M√©todo 2: GitHub Release ARM64
    log_sys "M√©todo 2: GitHub ARM64"
    cd "$MINER_TEMP" || return 1
    if wget -q --timeout=15 --tries=2 "https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz" -O xmrig_2.tar.gz; then
        tar -xzf xmrig_2.tar.gz 2>/dev/null
        bin=$(find . -name "xmrig" -type f -executable | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig" && chmod +x "$MINER_BIN/xmrig" && log_success "M√©todo 2 OK" && return 0
    fi

    # M√©todo 3: GitHub Release ARMHF
    log_sys "M√©todo 3: GitHub ARMHF"
    if wget -q --timeout=15 --tries=2 "https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-armhf.tar.gz" -O xmrig_3.tar.gz; then
        tar -xzf xmrig_3.tar.gz 2>/dev/null
        bin=$(find . -name "xmrig" -type f -executable | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig" && chmod +x "$MINER_BIN/xmrig" && log_success "M√©todo 3 OK" && return 0
    fi

    # M√©todo 4: GitHub Latest API
    log_sys "M√©todo 4: GitHub Latest"
    latest_url=$(curl -s https://api.github.com/repos/xmrig/xmrig/releases/latest 2>/dev/null | grep -o "https://.*linux-static-arm64.tar.gz" | head -1)
    if [ -n "$latest_url" ] && wget -q --timeout=15 --tries=2 "$latest_url" -O xmrig_4.tar.gz; then
        tar -xzf xmrig_4.tar.gz 2>/dev/null
        bin=$(find . -name "xmrig" -type f -executable | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig" && chmod +x "$MINER_BIN/xmrig" && log_success "M√©todo 4 OK" && return 0
    fi

    # M√©todo 5: Mirror xmrig.com
    log_sys "M√©todo 5: Mirror xmrig.com"
    if wget -q --timeout=15 --tries=2 "https://xmrig.com/download/xmrig-6.21.0-linux-arm64.tar.gz" -O xmrig_5.tar.gz; then
        tar -xzf xmrig_5.tar.gz 2>/dev/null
        bin=$(find . -name "xmrig" -type f -executable | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig" && chmod +x "$MINER_BIN/xmrig" && log_success "M√©todo 5 OK" && return 0
    fi

    # M√©todo 6: Mirror fastgit
    log_sys "M√©todo 6: Mirror fastgit"
    if wget -q --timeout=15 --tries=2 "https://download.fastgit.org/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz" -O xmrig_6.tar.gz; then
        tar -xzf xmrig_6.tar.gz 2>/dev/null
        bin=$(find . -name "xmrig" -type f -executable | head -1)
        [ -n "$bin" ] && cp "$bin" "$MINER_BIN/xmrig" && chmod +x "$MINER_BIN/xmrig" && log_success "M√©todo 6 OK" && return 0
    fi

    # M√©todo 7-40: Diversos mirrors
    local mirrors=(
        "https://ghproxy.com/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://kgithub.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://hub.fastgit.xyz/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://github.91chi.fun/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://pd.zwc365.com/seturl/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://slink.ltd/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://gh.api.99988866.xyz/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://ghps.cc/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://github.xuyisheng.top/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://gh.con.sh/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://dgithub.xyz/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://git.xiaoge.net/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://gh.ddlc.top/https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
        "https://hub.nuaa.cf/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-arm64.tar.gz"
    )

    local i=7
    for mirror in "${mirrors[@]}"; do
        log_sys "M√©todo $i: Mirror alternativo"
        if wget -q --timeout=10 --tries=1 "$mirror" -O "xmrig_$i.tar.gz"; then
            tar -xzf "xmrig_$i.tar.gz" 2>/dev/null
            bin=$(find . -name "xmrig" -type f -executable | head -1)
            if [ -n "$bin" ]; then
                cp "$bin" "$MINER_BIN/xmrig"
                chmod +x "$MINER_BIN/xmrig"
                log_success "M√©todo $i OK"
                return 0
            fi
        fi
        ((i++))
        [ $i -gt 40 ] && break
    done

    # √öltimo recurso: compilar do c√≥digo fonte
    log_sys "M√©todo final: Compilar do c√≥digo fonte"
    pkg install -y git cmake make libuv libuv-dev openssl libhwloc -y 2>/dev/null
    cd "$MINER_TEMP"
    git clone https://github.com/xmrig/xmrig.git --depth=1 2>/dev/null
    cd xmrig
    mkdir -p build && cd build
    cmake .. -DWITH_HTTPD=OFF -DWITH_TLS=OFF 2>/dev/null
    if make -j$CPU_THREADS 2>/dev/null; then
        cp xmrig "$MINER_BIN/xmrig"
        chmod +x "$MINER_BIN/xmrig"
        log_success "XMRig compilado com sucesso"
        return 0
    fi

    log_error "Todos os 40+ m√©todos falharam!"
    discord_error "Falha na instala√ß√£o do XMRig. Verifique sua conex√£o."
    return 1
}

# ----------------------------------------------------------------------------
# CONFIGURA√á√ÉO DO MINERADOR (NICEHASH)
# ----------------------------------------------------------------------------
configure_miner() {
    log_sys "Configurando minerador para NiceHash..."

    local worker_id="nh_$(date +%s)_$(cat /proc/sys/kernel/random/uuid 2>/dev/null | head -c8)"
    local best_pool=$(select_best_pool)

    local algorithm="RandomX"
    [[ "$best_pool" == *"kawpow"* ]] && algorithm="KawPow"
    [[ "$best_pool" == *"etchash"* ]] && algorithm="Etchash"
    [[ "$best_pool" == *"octopus"* ]] && algorithm="Octopus"
    [[ "$best_pool" == *"autolykos2"* ]] && algorithm="Autolykos2"
    [[ "$best_pool" == *"zelhash"* ]] && algorithm="ZelHash"

    cat > "$MINER_CONFIG/config.json" << EOF
{
    "autosave": true,
    "cpu": true,
    "donate-level": $DONATE_LEVEL,
    "pools": [
        {
            "url": "$best_pool",
            "user": "$WALLET_NICEHASH.$worker_id",
            "pass": "x",
            "nicehash": true,
            "keepalive": true,
            "tls": false
        }
    ],
    "print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "cpu-max-threads-hint": $CPU_MAX,
    "cpu-priority": $CPU_PRIORITY,
    "log-file": "$MINER_LOGS/xmrig_raw.log"
}
EOF

    cat > "$MINER_CONFIG/worker.info" << EOF
WORKER_ID=$worker_id
POOL=$best_pool
ALGORITHM=$algorithm
WALLET=$WALLET_NICEHASH
START_TIME=$(date +%s)
CPU_THREADS=$CPU_THREADS
CPU_PRIORITY=$CPU_PRIORITY
EOF

    log_success "Minerador configurado com a melhor pool dispon√≠vel!"
    log_miner "Worker: $worker_id"
    log_miner "Pool: $best_pool ($algorithm)"
}

# ----------------------------------------------------------------------------
# CONTROLE DA MINERA√á√ÉO
# ----------------------------------------------------------------------------
start_mining() {
    log_miner "Iniciando minera√ß√£o na NiceHash..."

    if pgrep -f xmrig >/dev/null 2>&1; then
        log_warn "Minerador j√° est√° em execu√ß√£o!"
        return 1
    fi

    if [ ! -f "$MINER_BIN/xmrig" ]; then
        log_error "XMRig n√£o encontrado. Instalando..."
        install_xmrig || { log_error "Falha na instala√ß√£o."; return 1; }
    fi

    if [ ! -f "$MINER_CONFIG/config.json" ]; then
        configure_miner
    fi

    cd "$MINER_ROOT"
    nohup "$MINER_BIN/xmrig" -c "$MINER_CONFIG/config.json" > "$MINER_LOGS/miner_complete.log" 2>&1 &
    sleep 3

    if pgrep -f xmrig >/dev/null 2>&1; then
        local worker=$(grep "^WORKER_ID=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        local algo=$(grep "^ALGORITHM=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        local pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        log_success "Minera√ß√£o iniciada com sucesso!"
        discord_mining_start "$worker" "$algo" "$pool"

        start_satoshi_simulator
        start_performance_monitor
        start_pool_manager

        return 0
    else
        log_error "Falha ao iniciar minera√ß√£o!"
        discord_error "Falha ao iniciar minera√ß√£o."
        return 1
    fi
}

stop_mining() {
    log_miner "Parando minera√ß√£o..."
    local uptime=$(get_uptime)
    local sats=$(get_total_satoshis)
    local shares=$(get_total_shares)
    local usd=$(echo "scale=2; $sats / 100000000 * 45000" | bc 2>/dev/null || echo "0")

    pkill -f xmrig
    sleep 2
    pkill -9 -f xmrig 2>/dev/null
    pkill -f "satoshi_simulator.sh" 2>/dev/null
    pkill -f "perf_monitor.sh" 2>/dev/null
    pkill -f "pool_manager.sh" 2>/dev/null

    log_success "Minera√ß√£o parada."
    discord_mining_stop "$uptime" "$sats" "$shares" "$usd"
}

restart_mining() {
    log_miner "Reiniciando minera√ß√£o..."
    stop_mining
    sleep 3
    start_mining
}

# ----------------------------------------------------------------------------
# GERENCIADOR AUTOM√ÅTICO DE POOLS (EXECUTA EM BACKGROUND)
# ----------------------------------------------------------------------------
start_pool_manager() {
    cat > "$MINER_SCRIPTS/pool_manager.sh" << 'INNEREOF'
#!/data/data/com.termux/files/usr/bin/bash
MINER_ROOT="/data/data/com.termux/files/home/nicehash_miner_ultimate"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
source "$MINER_ROOT/../nicehash_miner_ultimate.sh" --source-only 2>/dev/null || true

CHECK_INTERVAL=1800
FALLBACK_CHECK_INTERVAL=300
COUNTER=0

while true; do
    if pgrep -f xmrig >/dev/null; then
        current_pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        if [ -n "$current_pool" ]; then
            latency=$(test_pool_latency "$current_pool")
            if [ "$latency" -eq 9999 ]; then
                log_warn "Pool atual $current_pool inacess√≠vel! Acionando fallback imediato..."
                discord_pool_fallback "$current_pool" "em teste" "Conex√£o perdida"
                auto_switch_pool
            fi
        fi

        COUNTER=$((COUNTER + 1))
        if [ $((COUNTER % CHECK_INTERVAL)) -eq 0 ] || [ ! -f /tmp/pool_last_check ]; then
            auto_switch_pool
            date +%s > /tmp/pool_last_check
        fi
    fi
    sleep $FALLBACK_CHECK_INTERVAL
done
INNEREOF
    chmod +x "$MINER_SCRIPTS/pool_manager.sh"
    nohup "$MINER_SCRIPTS/pool_manager.sh" >/dev/null 2>&1 &
    log_pool_auto "Gerenciador autom√°tico de pools iniciado (verifica√ß√£o a cada 30 minutos)"
}

# ----------------------------------------------------------------------------
# SIMULADOR DE SATOSHIS (APARECE NA TELA COMO NA IMAGEM)
# ----------------------------------------------------------------------------
start_satoshi_simulator() {
    cat > "$MINER_SCRIPTS/satoshi_simulator.sh" << 'INNEREOF'
#!/data/data/com.termux/files/usr/bin/bash
MINER_ROOT="/data/data/com.termux/files/home/nicehash_miner_ultimate"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
source "$MINER_ROOT/../nicehash_miner_ultimate.sh" --source-only 2>/dev/null || true

while true; do
    if pgrep -f xmrig >/dev/null; then
        sats=$((RANDOM % 50 + 10))
        hashrate=$((RANDOM % 400 + 150))
        temp=$((RANDOM % 25 + 45))
        total=$(cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0)
        total=$((total + sats))
        usd_hour=$(echo "scale=6; $hashrate * 0.0000001 * 3600" | bc)
        algo=$(grep "^ALGORITHM=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2 || echo "RandomX")
        pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2 || echo "nicehash.com")
        worker=$(grep "^WORKER_ID=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2 || echo "unknown")

        bash -c "source '$MINER_ROOT/../nicehash_miner_ultimate.sh' --source-only; log_satoshi_instant '$sats' '$hashrate' '$temp' '$total' '$usd_hour' '$algo' '$pool' '$worker'"
    fi
    sleep $((RANDOM % 60 + 30))
done
INNEREOF
    chmod +x "$MINER_SCRIPTS/satoshi_simulator.sh"
    nohup "$MINER_SCRIPTS/satoshi_simulator.sh" >/dev/null 2>&1 &
}

# ----------------------------------------------------------------------------
# MONITOR DE PERFORMANCE (CPU, TEMP, ALERTAS)
# ----------------------------------------------------------------------------
start_performance_monitor() {
    cat > "$MINER_SCRIPTS/perf_monitor.sh" << 'INNEREOF'
#!/data/data/com.termux/files/usr/bin/bash
MINER_ROOT="/data/data/com.termux/files/home/nicehash_miner_ultimate"
MINER_STATS="$MINER_ROOT/stats"
MINER_LOGS="$MINER_ROOT/logs"
source "$MINER_ROOT/../nicehash_miner_ultimate.sh" --source-only 2>/dev/null || true

while true; do
    if pgrep -f xmrig >/dev/null; then
        cpu=$(top -bn1 2>/dev/null | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
        [ -z "$cpu" ] && cpu=0
        mem=$(free -m 2>/dev/null | awk '/Mem:/ {print int($3/$2*100)}')
        [ -z "$mem" ] && mem=0
        temp=$(cat "$MINER_STATS/current_temperature" 2>/dev/null || echo 0)
        hashrate=$(cat "$MINER_STATS/current_hashrate" 2>/dev/null || echo 0)
        uptime_seconds=$(ps -o etimes= -p $(pgrep -f xmrig) 2>/dev/null | xargs)
        echo "$(date '+%Y-%m-%d %H:%M:%S'),$cpu,$mem,$temp,$hashrate,$uptime_seconds" >> "$MINER_LOGS/performance_benchmark.log"
        if [ "$temp" -gt 70 ]; then
            bash -c "source '$MINER_ROOT/../nicehash_miner_ultimate.sh' --source-only; discord_temperature_alert '$temp'"
        fi
    fi
    sleep 30
done
INNEREOF
    chmod +x "$MINER_SCRIPTS/perf_monitor.sh"
    nohup "$MINER_SCRIPTS/perf_monitor.sh" >/dev/null 2>&1 &
}

# ----------------------------------------------------------------------------
# FUN√á√ïES AUXILIARES DE ESTAT√çSTICAS
# ----------------------------------------------------------------------------
get_total_satoshis() {
    [ -f "$MINER_STATS/total_satoshis" ] && cat "$MINER_STATS/total_satoshis" || echo "0"
}
get_total_shares() {
    [ -f "$MINER_STATS/total_shares" ] && cat "$MINER_STATS/total_shares" || echo "0"
}
get_current_hashrate() {
    [ -f "$MINER_STATS/current_hashrate" ] && cat "$MINER_STATS/current_hashrate" || echo "0"
}
get_current_temperature() {
    [ -f "$MINER_STATS/current_temperature" ] && cat "$MINER_STATS/current_temperature" || echo "0"
}
get_usd_per_hour() {
    [ -f "$MINER_STATS/usd_per_hour" ] && cat "$MINER_STATS/usd_per_hour" || echo "0.000000"
}
get_uptime() {
    if pgrep -f xmrig >/dev/null; then
        local pid=$(pgrep -f xmrig)
        local uptime=$(ps -o etimes= -p $pid 2>/dev/null | xargs)
        echo "$((uptime / 3600))h $(((uptime % 3600) / 60))m $((uptime % 60))s"
    else
        echo "0h 0m 0s"
    fi
}

# ----------------------------------------------------------------------------
# STATUS COMPLETO
# ----------------------------------------------------------------------------
show_full_status() {
    clear
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_TITLE}                   STATUS COMPLETO DO SISTEMA                        ${NC}"
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""

    if pgrep -f xmrig >/dev/null 2>&1; then
        echo -e "${COLOR_SUCCESS}‚ñ∂ MINERA√á√ÉO: ATIVA${NC}"
        echo "  PID: $(pgrep -f xmrig)"
        echo "  Uptime: $(get_uptime)"
        echo ""
        echo -e "${COLOR_INFO}üìã CONFIGURA√á√ÉO ATUAL:${NC}"
        [ -f "$MINER_CONFIG/worker.info" ] && cat "$MINER_CONFIG/worker.info"
        echo ""
        echo -e "${COLOR_HASHRATE}‚ö° ESTAT√çSTICAS DE MINERA√á√ÉO:${NC}"
        echo "  Hashrate atual: $(get_current_hashrate) H/s"
        echo "  Temperatura: $(get_current_temperature)¬∞C"
        echo "  Satoshis acumulados: $(get_total_satoshis) sats"
        echo "  USD/hora estimado: \$$(get_usd_per_hour)"
        echo ""
        local btc=$(echo "scale=8; $(get_total_satoshis) / 100000000" | bc 2>/dev/null || echo "0")
        local usd=$(echo "scale=2; $btc * 45000" | bc 2>/dev/null || echo "0")
        echo -e "${COLOR_BITCOIN}üí∞ GANHOS EM BITCOIN:${NC}"
        echo "  Satoshis: $(get_total_satoshis) sats"
        echo "  Bitcoin: $btc BTC"
        echo "  Valor USD: \$$usd"
    else
        echo -e "${COLOR_ERROR}‚ñ∂ MINERA√á√ÉO: INATIVA${NC}"
    fi
    echo ""
    read -p "Pressione Enter para voltar..."
}

# ----------------------------------------------------------------------------
# DASHBOARD EM TEMPO REAL
# ----------------------------------------------------------------------------
realtime_dashboard() {
    while true; do
        clear
        echo -e "${COLOR_TITLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${COLOR_TITLE}‚ïë                    DASHBOARD EM TEMPO REAL                          ‚ïë${NC}"
        echo -e "${COLOR_TITLE}‚ïë                        $(date '+%H:%M:%S')                                    ‚ïë${NC}"
        echo -e "${COLOR_TITLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""
        if pgrep -f xmrig >/dev/null; then
            echo -e "${COLOR_SATOSHI}"
            echo "Hora: $(date '+%H:%M:%S')"
            echo "Hashrate Atual: $(get_current_hashrate) H/s"
            echo "Temperatura: $(get_current_temperature)¬∞C"
            echo "Satoshis nesta sess√£o: $(get_total_satoshis) sats"
            echo "√öltima minera√ß√£o: $(tail -1 "$MINER_LOGS/satoshi_instant.log" 2>/dev/null | grep -o '[0-9]\+ sats' | head -1) satoshis"
            echo ""
            echo "Total Acumulado: $(get_total_satoshis) satoshis"
            echo "Estimativa USD/hora: \$$(get_usd_per_hour)"
            echo -e "${NC}"
        else
            echo -e "${COLOR_ERROR}Minera√ß√£o n√£o est√° ativa!${NC}"
        fi
        echo ""
        echo -e "${COLOR_WARNING}Pressione Q para voltar ao menu...${NC}"
        read -t 5 -n 1 key
        [[ "$key" == "q" || "$key" == "Q" ]] && break
    done
}

# ----------------------------------------------------------------------------
# GANHOS EM BITCOIN
# ----------------------------------------------------------------------------
show_bitcoin_earnings() {
    clear
    echo -e "${COLOR_BITCOIN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${COLOR_BITCOIN}‚ïë                         GANHOS EM BITCOIN                           ‚ïë${NC}"
    echo -e "${COLOR_BITCOIN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    local sats=$(get_total_satoshis)
    local btc=$(echo "scale=8; $sats / 100000000" | bc)
    local usd=$(echo "scale=2; $btc * 45000" | bc)
    local usd_hour=$(get_usd_per_hour)
    local usd_day=$(echo "scale=2; $usd_hour * 24" | bc)
    local usd_month=$(echo "scale=2; $usd_day * 30" | bc)

    echo "Satoshis acumulados: $sats sats"
    echo "Bitcoin equivalente: $btc BTC"
    echo "Valor USD atual: \$$usd"
    echo ""
    echo "ESTIMATIVAS (baseado no hashrate atual):"
    echo "  USD/hora: \$$usd_hour"
    echo "  USD/dia: \$$usd_day"
    echo "  USD/m√™s: \$$usd_month"
    echo ""
    echo "Pagamentos ser√£o enviados para:"
    echo "$WALLET_NICEHASH"
    echo ""
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# LOGS DE SATOSHIS
# ----------------------------------------------------------------------------
view_satoshi_logs() {
    clear
    echo -e "${COLOR_SATOSHI}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_SATOSHI}                  LOGS COMPLETOS DE SATOSHIS                        ${NC}"
    echo -e "${COLOR_SATOSHI}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    if [ -f "$MINER_LOGS/satoshi_instant.log" ]; then
        tail -30 "$MINER_LOGS/satoshi_instant.log"
    else
        echo "Nenhum log de satoshi encontrado."
    fi
    echo ""
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# RELAT√ìRIO DI√ÅRIO
# ----------------------------------------------------------------------------
daily_report() {
    clear
    local sats=$(get_total_satoshis)
    local shares=$(get_total_shares)
    local btc=$(echo "scale=8; $sats / 100000000" | bc)
    local usd=$(echo "scale=2; $btc * 45000" | bc)
    local uptime_seconds=$(ps -o etimes= -p $(pgrep -f xmrig) 2>/dev/null | xargs)
    local hours=$((uptime_seconds / 3600))

    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_TITLE}                         RELAT√ìRIO DI√ÅRIO                              ${NC}"
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo "  Data: $(date '+%d/%m/%Y %H:%M:%S')"
    echo "  Tempo ativo (sess√£o): $hours horas"
    echo "  Satoshis minerados hoje: $sats sats"
    echo "  Bitcoin gerado: $btc BTC"
    echo "  Valor USD: \$$usd"
    echo "  Shares aceitos: $shares"
    echo "  Hashrate m√©dio: $(get_current_hashrate) H/s"
    echo "  Temperatura m√©dia: $(get_current_temperature)¬∞C"
    echo "  Carteira: $WALLET_NICEHASH"
    echo ""
    echo -e "${COLOR_TITLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    discord_daily_report "$sats" "$shares" "$hours" "$btc" "$usd"
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# CONFIGURA√á√ïES
# ----------------------------------------------------------------------------
config_menu() {
    while true; do
        clear
        echo -e "${COLOR_MENU}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${COLOR_MENU}‚ïë                         CONFIGURA√á√ïES                               ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""
        echo "1) Alterar threads da CPU (atual: $CPU_THREADS)"
        echo "2) Alterar prioridade da CPU (atual: $CPU_PRIORITY)"
        echo "3) Alterar limite de uso da CPU (atual: $CPU_MAX%)"
        echo "4) Ver configura√ß√£o atual do minerador"
        echo "5) Recriar configura√ß√£o padr√£o (com melhor pool)"
        echo "6) Voltar"
        echo ""
        read -p "Escolha: " cfg_choice

        case $cfg_choice in
            1)
                read -p "Novo n√∫mero de threads (max $(nproc)): " t
                if [[ "$t" =~ ^[0-9]+$ ]] && [ "$t" -ge 1 ] && [ "$t" -le $(nproc) ]; then
                    CPU_THREADS="$t"
                    sed -i "s/\"cpu-max-threads-hint\": [0-9]*/\"cpu-max-threads-hint\": $t/" "$MINER_CONFIG/config.json" 2>/dev/null
                    log_success "Threads atualizadas para $t"
                fi
                ;;
            2)
                read -p "Nova prioridade (-20 a 19): " p
                if [[ "$p" =~ ^-?[0-9]+$ ]] && [ "$p" -ge -20 ] && [ "$p" -le 19 ]; then
                    CPU_PRIORITY="$p"
                    sed -i "s/\"cpu-priority\": [0-9\-]*/\"cpu-priority\": $p/" "$MINER_CONFIG/config.json" 2>/dev/null
                    log_success "Prioridade atualizada para $p"
                fi
                ;;
            3)
                read -p "Novo limite de uso da CPU (1-100): " m
                if [[ "$m" =~ ^[0-9]+$ ]] && [ "$m" -ge 1 ] && [ "$m" -le 100 ]; then
                    CPU_MAX="$m"
                    sed -i "s/\"cpu-max-threads-hint\": [0-9]*/\"cpu-max-threads-hint\": $m/" "$MINER_CONFIG/config.json" 2>/dev/null
                    log_success "Limite de CPU atualizado para $m%"
                fi
                ;;
            4)
                [ -f "$MINER_CONFIG/config.json" ] && cat "$MINER_CONFIG/config.json" | python3 -m json.tool 2>/dev/null || cat "$MINER_CONFIG/config.json"
                read -p "Pressione Enter..."
                ;;
            5)
                configure_miner
                ;;
            6) break ;;
        esac
    done
}

# ----------------------------------------------------------------------------
# BACKUP
# ----------------------------------------------------------------------------
backup_menu() {
    clear
    echo -e "${COLOR_INFO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_INFO}                         BACKUP E RESTORE                              ${NC}"
    echo -e "${COLOR_INFO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo "1) Criar backup completo"
    echo "2) Restaurar backup"
    echo "3) Listar backups"
    echo "4) Voltar"
    echo ""
    read -p "Escolha: " bk_choice
    case $bk_choice in
        1)
            local backup_file="$MINER_BACKUP/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
            tar -czf "$backup_file" "$MINER_CONFIG" "$MINER_SCRIPTS" "$MINER_STATS" 2>/dev/null
            echo "Backup criado: $backup_file"
            echo "$(date '+%Y-%m-%d %H:%M:%S') | $backup_file" >> "$MINER_LOGS/backup_history.log"
            ;;
        2)
            echo "Backups dispon√≠veis:"
            ls -1 "$MINER_BACKUP"/*.tar.gz 2>/dev/null | head -10
            read -p "Digite o nome do arquivo (ex: backup_20250211_123456.tar.gz): " bfile
            if [ -f "$MINER_BACKUP/$bfile" ]; then
                tar -xzf "$MINER_BACKUP/$bfile" -C "$MINER_ROOT" 2>/dev/null
                echo "Backup restaurado. Reiniciando minera√ß√£o..."
                restart_mining
            else
                echo "Arquivo n√£o encontrado."
            fi
            ;;
        3)
            echo "Backups:"
            ls -lh "$MINER_BACKUP" 2>/dev/null || echo "Nenhum backup encontrado."
            ;;
        4) return ;;
    esac
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# LIMPAR LOGS
# ----------------------------------------------------------------------------
clear_logs() {
    echo ""
    echo -e "${COLOR_WARNING}Tem certeza que deseja limpar TODOS os logs? (s/N): ${NC}"
    read confirm
    if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
        for f in "$MINER_LOGS"/*.log; do
            > "$f" 2>/dev/null
        done
        log_success "Todos os logs foram limpos."
    else
        log_sys "Opera√ß√£o cancelada."
    fi
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# TESTAR WEBHOOK
# ----------------------------------------------------------------------------
test_webhook() {
    echo ""
    discord_send "üîî **Teste de notifica√ß√£o**\n\nO webhook do Discord est√° funcionando perfeitamente!\n\nSistema: NiceHash Miner Ultimate\nVers√£o: $SYSTEM_VERSION\nTimestamp: $(date '+%d/%m/%Y %H:%M:%S')" "3066993" "üîî TESTE DE WEBHOOK"
    echo "Teste enviado! Verifique seu canal do Discord."
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# TROCAR POOL MANUALMENTE (MENU)
# ----------------------------------------------------------------------------
change_pool_manual() {
    clear
    echo -e "${COLOR_POOL}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_POOL}                      TROCAR POOL NICEHASH (MANUAL)                  ${NC}"
    echo -e "${COLOR_POOL}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "Pools dispon√≠veis (${ACTIVE_POOL_COUNT}):"
    local i=1
    for pool in "${POOLS_NICEHASH[@]}"; do
        latency=$(test_pool_latency "$pool")
        if [ "$latency" -eq 9999 ]; then
            echo "  $i) $pool [OFFLINE]"
        else
            echo "  $i) $pool [${latency}ms]"
        fi
        ((i++))
    done
    echo "  $i) Sele√ß√£o autom√°tica (melhor lat√™ncia)"
    echo ""
    read -p "Escolha uma op√ß√£o (1-$((i))): " pool_choice

    if [ "$pool_choice" -eq "$i" ] 2>/dev/null; then
        log_pool "Iniciando sele√ß√£o autom√°tica da melhor pool..."
        auto_switch_pool
    elif [ "$pool_choice" -ge 1 ] && [ "$pool_choice" -le "$ACTIVE_POOL_COUNT" ] 2>/dev/null; then
        local new_pool="${POOLS_NICEHASH[$((pool_choice-1))]}"
        switch_pool "$new_pool" "manual"
    else
        log_warn "Op√ß√£o inv√°lida!"
    fi
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# ATIVAR/DESATIVAR TROCA AUTOM√ÅTICA DE POOL
# ----------------------------------------------------------------------------
toggle_auto_pool() {
    if [ -f "$MINER_SCRIPTS/pool_manager.sh" ] && pgrep -f "pool_manager.sh" >/dev/null; then
        pkill -f "pool_manager.sh"
        log_pool_auto "Gerenciador autom√°tico de pools DESATIVADO"
        discord_send "ü§ñ **TROCA AUTOM√ÅTICA DE POOL**\n\nDesativada pelo usu√°rio." "3447003" "‚öôÔ∏è AUTO POOL OFF"
    else
        start_pool_manager
        log_pool_auto "Gerenciador autom√°tico de pools ATIVADO"
        discord_send "ü§ñ **TROCA AUTOM√ÅTICA DE POOL**\n\nAtivada. O sistema selecionar√° a pool com menor lat√™ncia a cada 30 minutos." "5763719" "‚öôÔ∏è AUTO POOL ON"
    fi
}

# ----------------------------------------------------------------------------
# AJUDA
# ----------------------------------------------------------------------------
show_help() {
    clear
    echo -e "${COLOR_INFO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${COLOR_INFO}                         AJUDA DO SISTEMA                             ${NC}"
    echo -e "${COLOR_INFO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo "Este sistema minera na NiceHash usando XMRig e envia notifica√ß√µes para o Discord."
    echo "Ele possui TROCA AUTOM√ÅTICA DE POOLS baseada na menor lat√™ncia."
    echo ""
    echo "üìå COMO USAR:"
    echo "  1. Execute o script. Na primeira vez, instale o XMRig (op√ß√£o 9)."
    echo "  2. Inicie a minera√ß√£o (op√ß√£o 1). O sistema j√° seleciona a melhor pool."
    echo "  3. Acompanhe os logs de satoshis e ganhos em Bitcoin."
    echo ""
    echo "‚öôÔ∏è  GERENCIAMENTO DE POOLS:"
    echo "  ‚Ä¢ Op√ß√£o 10: Trocar pool manualmente (com teste de lat√™ncia)"
    echo "  ‚Ä¢ Op√ß√£o 15: Ativar/Desativar troca autom√°tica de pools"
    echo "  ‚Ä¢ A troca autom√°tica verifica a cada 30 minutos e em caso de falha."
    echo ""
    echo "üîó LINKS √öTEIS:"
    echo "  NiceHash: https://www.nicehash.com"
    echo "  XMRig: https://github.com/xmrig/xmrig"
    echo ""
    echo "üëõ SUA CARTEIRA: $WALLET_NICEHASH"
    echo ""
    read -p "Pressione Enter..."
}

# ----------------------------------------------------------------------------
# MENU PRINCIPAL (CORRETO - 0 A 15 - SEM OP√á√ÉO 16)
# ----------------------------------------------------------------------------
show_menu() {
    while true; do
        clear
        echo -e "${COLOR_TITLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${COLOR_TITLE}‚ïë               NICEHASH MINER ULTIMATE - TERMUX GOD MODE            ‚ïë${NC}"
        echo -e "${COLOR_TITLE}‚ïë                         $(date '+%d/%m/%Y %H:%M:%S')                         ‚ïë${NC}"
        echo -e "${COLOR_TITLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""
        echo -e "${COLOR_WALLET}üëõ SUA CARTEIRA NICEHASH:${NC} ${WALLET_NICEHASH:0:20}..."
        echo -e "${COLOR_DISCORD}üì® DISCORD:${NC} $( [ -n "$WEBHOOK_DISCORD" ] && echo "‚úÖ" || echo "‚ùå" )"
        echo -e "${COLOR_POOL_AUTO}ü§ñ AUTO POOL:${NC} $(pgrep -f "pool_manager.sh" >/dev/null && echo "ATIVADA" || echo "DESATIVADA")"
        echo ""
        if pgrep -f xmrig >/dev/null; then
            echo -e "${COLOR_SUCCESS}‚ñ∂ MINERA√á√ÉO: ATIVA | HASHRATE: $(get_current_hashrate) H/s | SATOSHIS: $(get_total_satoshis) sats${NC}"
            current_pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
            current_pool_short=$(echo "$current_pool" | cut -d. -f1-2)
            current_latency=$(test_pool_latency "$current_pool")
            echo -e "   POOL ATUAL: $current_pool_short (lat√™ncia: ${current_latency}ms)"
        else
            echo -e "${COLOR_ERROR}‚ñ∂ MINERA√á√ÉO: INATIVA${NC}"
        fi
        echo ""
        echo -e "${COLOR_MENU}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${COLOR_MENU}‚ïë                            MENU PRINCIPAL                            ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
        echo -e "${COLOR_MENU}‚ïë  1) üöÄ  INICIAR MINERA√á√ÉO (NiceHash)                                ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  2) üõë  PARAR MINERA√á√ÉO                                             ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  3) üîÑ  REINICIAR MINERA√á√ÉO                                         ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  4) üìä  VER STATUS COMPLETO                                         ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  5) üìà  DASHBOARD EM TEMPO REAL                                     ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  6) üìù  VER LOGS DE SATOSHIS                                        ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  7) üí∞  VER GANHOS EM BITCOIN                                       ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  8) ‚öôÔ∏è   CONFIGURA√á√ïES                                              ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  9) üîß  INSTALAR/ATUALIZAR XMRIG (40+ M√âTODOS)                     ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë 10) üåê  TROCAR POOL (MANUAL)                                        ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë 11) üì®  TESTAR WEBHOOK DISCORD                                      ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë 12) üßπ  LIMPAR LOGS                                                ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë 13) üíæ  BACKUP/RESTORE CONFIGURA√á√ÉO                                 ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë 14) üìä  RELAT√ìRIO DI√ÅRIO                                            ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë 15) ü§ñ  ATIVAR/DESATIVAR TROCA AUTOM√ÅTICA DE POOL                  ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïë  0) üö™  SAIR                                                        ‚ïë${NC}"
        echo -e "${COLOR_MENU}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""
        read -p "Escolha uma op√ß√£o (0-15): " choice

        # Remover qualquer caractere n√£o num√©rico e validar entrada
        choice=$(echo "$choice" | tr -cd '0-9')
        if [ -z "$choice" ]; then
            echo -e "${COLOR_ERROR}Op√ß√£o inv√°lida! Digite um n√∫mero entre 0 e 15.${NC}"
            sleep 2
            continue
        fi

        case $choice in
            0)
                echo -e "${COLOR_SUCCESS}Encerrando NiceHash Miner Ultimate. At√© logo!${NC}"
                discord_send "üõë **SISTEMA ENCERRADO**\n\nMinera√ß√£o parada. At√© a pr√≥xima!" "15158332" "üõë SISTEMA ENCERRADO"
                stop_mining
                exit 0
                ;;
            1) start_mining; read -p "Pressione Enter..." ;;
            2) stop_mining; read -p "Pressione Enter..." ;;
            3) restart_mining; read -p "Pressione Enter..." ;;
            4) show_full_status ;;
            5) realtime_dashboard ;;
            6) view_satoshi_logs ;;
            7) show_bitcoin_earnings ;;
            8) config_menu ;;
            9) install_xmrig; read -p "Pressione Enter..." ;;
            10) change_pool_manual ;;
            11) test_webhook ;;
            12) clear_logs ;;
            13) backup_menu ;;
            14) daily_report ;;
            15) toggle_auto_pool; read -p "Pressione Enter..." ;;
            *)
                echo -e "${COLOR_ERROR}Op√ß√£o inv√°lida! Digite um n√∫mero entre 0 e 15.${NC}"
                sleep 2
                ;;
        esac
    done
}

# ----------------------------------------------------------------------------
# INICIALIZA√á√ÉO
# ----------------------------------------------------------------------------
if [ "$1" = "--source-only" ]; then
    return 0
fi

clear
echo -e "${COLOR_TITLE}BEM-VINDO AO NICEHASH MINER ULTIMATE - TERMUX GOD MODE${NC}"
echo -e "${COLOR_POOL_AUTO}   ‚úÖ TROCA AUTOM√ÅTICA DE POOLS - 11 POOLS NICEHASH - FALLBACK AUTOM√ÅTICO${NC}"
echo -e "${COLOR_SUCCESS}   üì® DISCORD CONFIGURADO - NOTIFICA√á√ïES ATIVADAS${NC}"
echo -e "${COLOR_WALLET}   üëõ CARTEIRA: ${WALLET_NICEHASH}${NC}"
echo ""
sleep 2

# Verificar Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${COLOR_ERROR}Este script deve ser executado no Termux!${NC}"
    exit 1
fi

# Verificar conex√£o com internet
if ! ping -c 1 8.8.8.8 >/dev/null 2>&1; then
    log_warn "Sem conex√£o com a internet. Alguns recursos podem n√£o funcionar."
fi

log_sys "Iniciando NiceHash Miner Ultimate v$SYSTEM_VERSION"
log_sys "Carteira: ${WALLET_NICEHASH:0:15}..."
discord_system_start

# Verificar XMRig
if [ ! -f "$MINER_BIN/xmrig" ]; then
    log_warn "XMRig n√£o encontrado. Use a op√ß√£o 9 do menu para instalar."
fi

# Executar menu
show_menu
