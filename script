#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# XMRIG MINER GOD - TERMUX ULTIMATE EDITION v101.0 - MODO AUTOMÃTICO TOTAL
# ============================================================================
#   ðŸ”¥ FAZ TUDO SOZINHO: INSTALA, CONFIGURA, MINERA, MONITORA E TROCA POOL ðŸ”¥
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURAÃ‡Ã•ES FIXAS (ALTERE SE NECESSÃRIO)
# ----------------------------------------------------------------------------
WALLET_ADDRESS="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
WEBHOOK_DISCORD="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# ----------------------------------------------------------------------------
# VARIÃVEIS GLOBAIS
# ----------------------------------------------------------------------------
SYSTEM_VERSION="101.0"
MINER_ROOT="/data/data/com.termux/files/home/.xmrig_god_final"
MINER_BIN="$MINER_ROOT/bin"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_STATS="$MINER_ROOT/stats"
MINER_SCRIPTS="$MINER_ROOT/scripts"
MINER_TEMP="$MINER_ROOT/temp"
mkdir -p "$MINER_BIN" "$MINER_CONFIG" "$MINER_LOGS" "$MINER_STATS" "$MINER_SCRIPTS" "$MINER_TEMP"

# Arquivos de log
touch "$MINER_LOGS"/{system.log,miner.log,error.log,discord.log,satoshi.log,hashrate.log,xmrig_raw.log,pool.log,auto_pool.log,watchdog.log}

# ConfiguraÃ§Ãµes padrÃ£o
CPU_THREADS=$(($(nproc 2>/dev/null || echo 2) - 1))
[ $CPU_THREADS -lt 1 ] && CPU_THREADS=1
CPU_PRIORITY=5
CPU_MAX=75
TLS_ENABLED=false
AUTO_POOL=true
POOL_INTERVAL=1800  # 30 minutos
DONATE_LEVEL=0

# Cores
NC='\033[0m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; CYAN='\033[0;36m'; PURPLE='\033[0;35m'

# Lista de pools
POOLS=(
    "randomxmonero.auto.nicehash.com:9200"
    "randomxmonero.eu.nicehash.com:3380"
    "randomxmonero.usa.nicehash.com:3380"
    "pool.supportxmr.com:3333"
    "pool.supportxmr.com:443"
    "gulf.moneroocean.stream:10001"
)

# ----------------------------------------------------------------------------
# FUNÃ‡Ã•ES DE LOG E NOTIFICAÃ‡ÃƒO
# ----------------------------------------------------------------------------
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$1] $2" >> "$MINER_LOGS/system.log"; echo -e "${!1}[$1]${NC} $2"; }
log_info()  { log "INFO" "$1"; }
log_ok()    { log "OK" "$1"; }
log_warn()  { log "WARN" "$1"; }
log_error() { log "ERROR" "$1"; }

discord_send() {
    [ -z "$WEBHOOK_DISCORD" ] || [[ "$WEBHOOK_DISCORD" == *"example.com"* ]] && return
    curl -s -H "Content-Type: application/json" -X POST -d "{\"embeds\":[{\"title\":\"$3\",\"description\":\"$1\",\"color\":$2}]}" "$WEBHOOK_DISCORD" -o /dev/null
}

# ----------------------------------------------------------------------------
# UTILITÃRIOS
# ----------------------------------------------------------------------------
detect_arch() { case $(uname -m) in aarch64|arm64) echo "arm64";; armv7l|armhf) echo "arm32";; *) echo "unknown";; esac; }
verify_xmrig() { [ -f "$1" ] && chmod +x "$1" && "$1" --version &>/dev/null; }

enable_wake_lock() { command -v termux-wake-lock &>/dev/null && termux-wake-lock && log_ok "Wake lock ativado"; }

# ----------------------------------------------------------------------------
# INSTALAÃ‡ÃƒO DE DEPENDÃŠNCIAS
# ----------------------------------------------------------------------------
install_deps() {
    log_info "Verificando dependÃªncias..."
    pkg update -y &>/dev/null
    for pkg in curl wget nc git cmake make libuv libhwloc openssl unzip tar; do
        if ! command -v "$pkg" &>/dev/null && ! pkg list-installed 2>/dev/null | grep -q "^$pkg"; then
            pkg install -y "$pkg" &>/dev/null && log_ok "$pkg instalado"
        fi
    done
}

# ----------------------------------------------------------------------------
# MÃ‰TODOS DE INSTALAÃ‡ÃƒO DO XMRIG
# ----------------------------------------------------------------------------
method_mooo_binary() {
    log_info "Baixando binÃ¡rio do xmrig.mooo.info..."
    cd "$MINER_TEMP"
    rm -f xmrig.zip xmrig.tar
    local arch=$(detect_arch)
    local url="http://xmrig.mooo.info/xmrigARM-1.9.5-android-arm64v8.zip"
    [ "$arch" = "arm32" ] && url="http://xmrig.mooo.info/xmrigARM-1.9.3-android-arm32v7.zip"
    wget -q --timeout=30 --tries=3 "$url" -O xmrig.zip || wget -q --timeout=30 --tries=3 "$url" -O xmrig.tar
    if [ -f "xmrig.zip" ]; then
        unzip -q xmrig.zip && cp $(find . -name "xmrigARM" -type f) "$MINER_BIN/xmrig" 2>/dev/null
    elif [ -f "xmrig.tar" ]; then
        tar -xf xmrig.tar && cp $(find . -name "xmrig" -type f -executable) "$MINER_BIN/xmrig" 2>/dev/null
    fi
    verify_xmrig "$MINER_BIN/xmrig" && { log_ok "XMRig instalado via mooo.info"; discord_send "âœ… Instalado (mooo.info)" "3066993" "OK"; return 0; }
    return 1
}

method_mooo_script() {
    log_info "Tentando script miner.sh..."
    cd "$MINER_TEMP"
    export WORKER="god_auto_$(date +%s)" HOSTTYPE=$(detect_arch)
    curl -sL http://xmrig.mooo.info/miner.sh | sh -s pool.supportxmr.com:3333 "$WALLET_ADDRESS" rx/0 "$CPU_THREADS" &>/tmp/miner_sh.log &
    sleep 30
    [ -f "$MINER_TEMP/xmrig" ] && cp "$MINER_TEMP/xmrig" "$MINER_BIN/xmrig" 2>/dev/null
    verify_xmrig "$MINER_BIN/xmrig" && { log_ok "XMRig instalado via miner.sh"; discord_send "âœ… Instalado (miner.sh)" "3066993" "OK"; return 0; }
    return 1
}

method_compile() {
    log_info "Compilando XMRig (pode levar minutos)..."
    pkg install -y git cmake make libuv libhwloc openssl &>/dev/null
    cd "$MINER_TEMP" && rm -rf xmrig
    git clone --depth=1 --branch v6.19.0 https://github.com/xmrig/xmrig.git &>/dev/null || return 1
    cd xmrig && mkdir -p build && cd build
    cmake .. -DWITH_TLS=OFF -DWITH_HTTPD=OFF -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DWITH_HWLOC=OFF -DCMAKE_BUILD_TYPE=Release &>/tmp/cmake.log
    make -j$CPU_THREADS &>/tmp/make.log
    [ -f "xmrig" ] && cp xmrig "$MINER_BIN/xmrig"
    verify_xmrig "$MINER_BIN/xmrig" && { log_ok "XMRig compilado"; discord_send "âœ… Compilado" "3066993" "OK"; return 0; }
    return 1
}

install_xmrig_auto() {
    verify_xmrig "$MINER_BIN/xmrig" && { log_ok "XMRig jÃ¡ instalado"; return 0; }
    log_info "Instalando XMRig..."
    rm -f "$MINER_BIN/xmrig"
    pkg uninstall -y xmrig &>/dev/null
    install_deps
    method_mooo_binary || method_mooo_script || method_compile || {
        log_error "FALHA NA INSTALAÃ‡ÃƒO"
        discord_send "âŒ Falha na instalaÃ§Ã£o" "15158332" "ERRO"
        exit 1
    }
}

# ----------------------------------------------------------------------------
# POOLS
# ----------------------------------------------------------------------------
test_latency() {
    local host="${1%:*}" port="${1##*:}"
    if date +%N &>/dev/null; then
        local start=$(date +%s%N)
        timeout 2 nc -z -w 2 "$host" "$port" &>/dev/null
        echo $(( ($(date +%s%N) - start) / 1000000 ))
    else
        local start=$(date +%s)
        timeout 2 nc -z -w 2 "$host" "$port" &>/dev/null
        echo $(( ($(date +%s) - start) * 1000 ))
    fi
}

select_best_pool() {
    local best_pool="${POOLS[0]}" best_lat=999999
    for pool in "${POOLS[@]}"; do
        lat=$(test_latency "$pool" 2>/dev/null || echo 9999)
        [[ "$lat" =~ ^[0-9]+$ ]] && [ "$lat" -lt "$best_lat" ] && { best_lat="$lat"; best_pool="$pool"; }
    done
    echo "$best_pool"
}

configure_miner() {
    local pool=$(select_best_pool) worker="god_auto_$(date +%s)_$RANDOM"
    cat > "$MINER_CONFIG/config.json" << EOF
{"autosave":true,"cpu":true,"donate-level":$DONATE_LEVEL,"pools":[{"url":"$pool","user":"$WALLET_ADDRESS.$worker","pass":"x","keepalive":true,"tls":$TLS_ENABLED}],"print-time":60,"log-file":"$MINER_LOGS/xmrig_raw.log","cpu-max-threads-hint":$CPU_MAX,"cpu-priority":$CPU_PRIORITY}
EOF
    echo -e "WORKER=$worker\nPOOL=$pool\nWALLET=$WALLET_ADDRESS\nTLS=$TLS_ENABLED" > "$MINER_CONFIG/worker.info"
    log_ok "Configurado com pool: $pool"
}

# ----------------------------------------------------------------------------
# ESTATÃSTICAS
# ----------------------------------------------------------------------------
get_hashrate() {
    local f="$MINER_LOGS/xmrig_raw.log"; [ ! -s "$f" ] && f="$MINER_LOGS/miner.log"
    [ -f "$f" ] && tail -n50 "$f" 2>/dev/null | grep -E 'speed.*H/s' | tail -1 | sed -E 's/.* ([0-9.]+) H\/s.*/\1 H\/s/' || echo "0 H/s"
}
get_hashrate_value() { echo "$(get_hashrate)" | awk '{print $1}' | grep -E '^[0-9.]+$' || echo "0"; }
get_shares() { [ -f "$MINER_LOGS/xmrig_raw.log" ] && tail -n100 "$MINER_LOGS/xmrig_raw.log" 2>/dev/null | grep -c 'accepted' || echo 0; }
get_temp() { [ -f /sys/class/thermal/thermal_zone0/temp ] && awk '{printf "%.0f", $1/1000}' /sys/class/thermal/thermal_zone0/temp 2>/dev/null || echo 0; }
get_total_satoshis() { cat "$MINER_STATS/total_satoshis" 2>/dev/null || echo 0; }
get_total_shares() { cat "$MINER_STATS/total_shares" 2>/dev/null || echo 0; }
get_uptime_seconds() { pgrep -f xmrig >/dev/null && echo $(ps -o etimes= -p $(pgrep -f xmrig) 2>/dev/null | xargs) || echo 0; }

update_stats() {
    local h=$(get_hashrate_value) t=$(get_temp) s=$(get_shares) os=$(get_total_shares)
    [ "$s" -gt "$os" ] && echo "$s" > "$MINER_STATS/total_shares"
    echo "$h" > "$MINER_STATS/current_hashrate"
    echo "$t" > "$MINER_STATS/current_temp"
    echo "$(date '+%Y-%m-%d %H:%M:%S') | Shares: $s | HR: $h H/s" >> "$MINER_LOGS/shares_history.log"
    echo "$h" >> "$MINER_LOGS/hashrate.log"
}

log_satoshi_auto() {
    local s=$(get_shares) last=$(cat "$MINER_STATS/last_shares" 2>/dev/null || echo 0)
    local diff=$((s - last)); [ $diff -lt 0 ] && diff=0
    local sat=$((diff * 10)) total=$(($(get_total_satoshis) + sat))
    echo "$total" > "$MINER_STATS/total_satoshis"; echo "$s" > "$MINER_STATS/last_shares"
    echo "$(date '+%H:%M:%S') | +$sat sats | HR: $(get_hashrate) | Temp: $(get_temp)Â°C | Total: $total sats" >> "$MINER_LOGS/satoshi.log"
    [ $(( $(date +%s) % 600 )) -lt 60 ] && discord_send "ðŸ’° +$sat sats | HR: $(get_hashrate) | Total: $total sats" "16753920" "Satoshis"
}

# ----------------------------------------------------------------------------
# TROCA DE POOL
# ----------------------------------------------------------------------------
switch_pool() {
    local new="$1" reason="$2"
    local old=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
    local lat=$(test_latency "$new")
    sed -i "s|\"url\": \".*\"|\"url\": \"$new\"|" "$MINER_CONFIG/config.json"
    sed -i "s|^POOL=.*|POOL=$new|" "$MINER_CONFIG/worker.info"
    log_ok "Pool: $old -> $new (${lat}ms) | $reason"
    discord_send "ðŸ”„ Pool alterada\nDe: $old\nPara: $new (${lat}ms)\nMotivo: $reason" "3447003" "Troca"
    pkill -f xmrig; sleep 2; start_mining
}

# ----------------------------------------------------------------------------
# AUTO POOL DAEMON
# ----------------------------------------------------------------------------
start_auto_pool() {
    local SELF="$(realpath "$0")"
    cat > "$MINER_SCRIPTS/auto_pool.sh" << EOF
#!/data/data/com.termux/files/usr/bin/bash
MINER_CONFIG="$MINER_CONFIG"; MINER_LOGS="$MINER_LOGS"; POOL_INTERVAL=$POOL_INTERVAL; SELF="$SELF"
test_latency() { host="\${1%:*}"; port="\${1##*:}"; timeout 2 nc -z -w 2 "\$host" "\$port" &>/dev/null && echo 100 || echo 9999; }
select_best() { echo "pool.supportxmr.com:3333"; }
while true; do
    if pgrep -f xmrig >/dev/null; then
        cur=\$(grep "^POOL=" "\$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        [ -n "\$cur" ] && lat=\$(test_latency "\$cur")
        if [ "\$lat" -ge 9999 ]; then
            best=\$(select_best)
            echo "\$(date) | Fallback: \$best" >> "\$MINER_LOGS/auto_pool.log"
            "\$SELF" --switch-pool "\$best" "fallback"
        elif [ ! -f /tmp/pool_check ] || [ \$(( \$(date +%s) - \$(cat /tmp/pool_check) )) -ge \$POOL_INTERVAL ]; then
            best=\$(select_best)
            [ "\$best" != "\$cur" ] && "\$SELF" --switch-pool "\$best" "otimizaÃ§Ã£o"
            date +%s > /tmp/pool_check
        fi
    fi
    sleep 60
done
EOF
    chmod +x "$MINER_SCRIPTS/auto_pool.sh"
    nohup "$MINER_SCRIPTS/auto_pool.sh" &>/dev/null &
    echo $! > "$MINER_STATS/auto_pool.pid"
    log_ok "Auto pool iniciado"
}

stop_auto_pool() { [ -f "$MINER_STATS/auto_pool.pid" ] && kill $(cat "$MINER_STATS/auto_pool.pid") 2>/dev/null; pkill -f auto_pool.sh; }

# ----------------------------------------------------------------------------
# WATCHDOG
# ----------------------------------------------------------------------------
start_watchdog() {
    local SELF="$(realpath "$0")"
    cat > "$MINER_SCRIPTS/watchdog.sh" << EOF
#!/data/data/com.termux/files/usr/bin/bash
while true; do
    if pgrep -f xmrig >/dev/null; then
        pid=\$(pgrep -f xmrig)
        cpu=\$(ps -p \$pid -o %cpu | tail -1 | tr -d ' ' 2>/dev/null)
        if [ -z "\$cpu" ] || [ "\$cpu" = "0.0" ] || [ "\$cpu" = "0" ]; then
            echo "\$(date) | Travado, reiniciando" >> "$MINER_LOGS/watchdog.log"
            pkill -f xmrig; sleep 2; "\$SELF" --restart-mining
        fi
    fi
    sleep 30
done
EOF
    chmod +x "$MINER_SCRIPTS/watchdog.sh"
    nohup "$MINER_SCRIPTS/watchdog.sh" &>/dev/null &
    echo $! > "$MINER_STATS/watchdog.pid"
    log_ok "Watchdog iniciado"
}

stop_watchdog() { [ -f "$MINER_STATS/watchdog.pid" ] && kill $(cat "$MINER_STATS/watchdog.pid") 2>/dev/null; pkill -f watchdog.sh; }

# ----------------------------------------------------------------------------
# INICIAR MINERAÃ‡ÃƒO
# ----------------------------------------------------------------------------
start_mining() {
    pgrep -f xmrig &>/dev/null && { log_warn "JÃ¡ estÃ¡ rodando"; return 1; }
    install_xmrig_auto
    [ ! -f "$MINER_CONFIG/config.json" ] && configure_miner
    enable_wake_lock
    echo "$(get_shares)" > "$MINER_STATS/last_shares"
    cd "$MINER_ROOT"
    nohup "$MINER_BIN/xmrig" -c "$MINER_CONFIG/config.json" >> "$MINER_LOGS/miner.log" 2>&1 &
    local pid=$!
    echo $pid > "$MINER_STATS/miner.pid"
    sleep 3
    if kill -0 $pid 2>/dev/null; then
        local worker=$(grep "^WORKER=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        local pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2)
        log_ok "MineraÃ§Ã£o iniciada (PID: $pid) | Pool: $pool"
        discord_send "ðŸš€ Iniciada\nWorker: $worker\nPool: $pool" "3066993" "InÃ­cio"
        ( while kill -0 $pid 2>/dev/null; do update_stats; log_satoshi_auto; sleep 60; done ) &
        echo $! > "$MINER_STATS/stats_loop.pid"
        return 0
    else
        log_error "Falha ao iniciar"
        discord_send "âŒ Falha ao iniciar" "15158332" "ERRO"
        return 1
    fi
}

restart_mining() { pkill -f xmrig; sleep 2; start_mining; }

# ----------------------------------------------------------------------------
# MONITORAMENTO PRINCIPAL
# ----------------------------------------------------------------------------
monitor_loop() {
    log_info "Monitorando. Ctrl+C para parar."
    while true; do
        clear
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${PURPLE}         XMRIG MINER GOD â€“ MODO AUTOMÃTICO TOTAL v$SYSTEM_VERSION${NC}"
        echo -e "${PURPLE}                    $(date '+%d/%m/%Y %H:%M:%S')${NC}"
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        if pgrep -f xmrig >/dev/null; then
            h=$(get_hashrate); t=$(get_temp); s=$(get_total_satoshis); sh=$(get_total_shares)
            pool=$(grep "^POOL=" "$MINER_CONFIG/worker.info" 2>/dev/null | cut -d= -f2 | cut -d. -f1-2)
            up=$(get_uptime_seconds); up_str="$((up/3600))h $(((up%3600)/60))m $((up%60))s"
            usd=$(echo "scale=6; $(get_hashrate_value) * 0.00000001 * 45000 * 3600" | bc 2>/dev/null || echo 0)
            echo -e "${GREEN}â–¶ ATIVA   PID: $(pgrep -f xmrig)   Uptime: $up_str${NC}\n"
            echo -e "${CYAN}âš¡ EstatÃ­sticas:${NC}"
            echo "   Hashrate: $h"
            echo "   Temp: $tÂ°C"
            echo "   Satoshis: $s sats"
            echo "   Shares: $sh"
            echo "   USD/hora: \$$usd"
            echo ""
            echo -e "${CYAN}ðŸŒ Pool:${NC} ${pool:-N/A}"
            echo -e "${CYAN}ðŸ‘› Carteira:${NC} ${WALLET_ADDRESS:0:20}..."
        else
            echo -e "${RED}â–¶ INATIVA${NC}\n"
            echo -e "${YELLOW}Tentando reiniciar...${NC}"
            start_mining
        fi
        echo -e "\n${YELLOW}Ctrl+C para encerrar${NC}"
        sleep 60
    done
}

# ----------------------------------------------------------------------------
# TRATAMENTO DE ARGUMENTOS
# ----------------------------------------------------------------------------
[ "$1" = "--switch-pool" ] && [ -n "$2" ] && { switch_pool "$2" "$3"; exit 0; }
[ "$1" = "--restart-mining" ] && { restart_mining; exit 0; }
[ "$1" = "--source-only" ] && return 0

# ----------------------------------------------------------------------------
# TRAP DE SAÃDA
# ----------------------------------------------------------------------------
clean_exit() {
    echo -e "\n${YELLOW}Encerrando...${NC}"
    stop_auto_pool; stop_watchdog
    pkill -f xmrig; [ -f "$MINER_STATS/stats_loop.pid" ] && kill $(cat "$MINER_STATS/stats_loop.pid") 2>/dev/null
    command -v termux-wake-unlock &>/dev/null && termux-wake-unlock
    local sats=$(get_total_satoshis)
    discord_send "ðŸ›‘ Encerrado\nTotal: $sats sats" "15158332" "Parada"
    exit 0
}
trap clean_exit SIGINT SIGTERM

# ----------------------------------------------------------------------------
# EXECUÃ‡ÃƒO
# ----------------------------------------------------------------------------
clear
echo -e "${PURPLE}ðŸ”¥ XMRIG MINER GOD â€“ MODO AUTOMÃTICO TOTAL v$SYSTEM_VERSION ðŸ”¥${NC}\n"
[ ! -d "/data/data/com.termux" ] && { echo -e "${RED}Apenas Termux${NC}"; exit 1; }

# Inicializa stats
for f in total_satoshis total_shares current_hashrate current_temp last_shares; do
    [ ! -f "$MINER_STATS/$f" ] && echo "0" > "$MINER_STATS/$f"
done

install_deps
start_mining
[ "$AUTO_POOL" = true ] && start_auto_pool
start_watchdog
monitor_loop
