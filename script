#!/data/data/com.termux/files/usr/bin/bash

# =============================================================================
# â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
# â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
# â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•
# =============================================================================
# MINERAÃ‡ÃƒO BITCOIN PARA TERMUX - MEGALODON FINAL EDITION
# =============================================================================
# âœ… TODOS OS BINÃRIOS SÃƒO VERIFICADOS ANTES DE USAR
# âœ… COMPILAÃ‡ÃƒO DIRETA SE BINÃRIO FALHAR
# âœ… 100% FUNCIONAL NO TERMUX
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURAÃ‡Ã•ES
# -----------------------------------------------------------------------------
BTC_ADDRESS="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
MINER_HOME="/data/data/com.termux/files/home/.miner_megalodon"

# -----------------------------------------------------------------------------
# CORES
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# -----------------------------------------------------------------------------
# LOG
# -----------------------------------------------------------------------------
log() {
    local level="$1"
    local msg="$2"
    local timestamp=$(date '+%H:%M:%S')
    
    case "$level" in
        "INFO")  echo -e "${CYAN}[$timestamp INFO]${NC} $msg" ;;
        "OK")    echo -e "${GREEN}[$timestamp OK]${NC} $msg" ;;
        "WARN")  echo -e "${YELLOW}[$timestamp WARN]${NC} $msg" ;;
        "ERROR") echo -e "${RED}[$timestamp ERROR]${NC} $msg" ;;
        *)       echo "[$timestamp] $msg" ;;
    esac
}

# -----------------------------------------------------------------------------
# BANNER
# -----------------------------------------------------------------------------
show_banner() {
    clear
    echo -e "${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                                   â•‘"
    echo "â•‘   â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•‘"
    echo "â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â•‘"
    echo "â•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â•‘"
    echo "â•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â•‘"
    echo "â•‘   â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â•‘"
    echo "â•‘   â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•   â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘              BITCOIN MINER MEGALODON FINAL EDITION               â•‘"
    echo "â•‘                   VERIFICAÃ‡ÃƒO DE BINÃRIOS ATIVA                  â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# -----------------------------------------------------------------------------
# DETECTAR HARDWARE
# -----------------------------------------------------------------------------
detect_hardware() {
    log "INFO" "Detectando hardware..."
    
    # NÃºmero de CPUs
    if [ -f "/proc/cpuinfo" ]; then
        CPU_CORES=$(grep -c ^processor /proc/cpuinfo 2>/dev/null)
        CPU_CORES=${CPU_CORES:-2}
    else
        CPU_CORES=$(nproc 2>/dev/null || echo 2)
    fi
    
    # Arquitetura
    ARCH=$(uname -m)
    case "$ARCH" in
        aarch64|arm64)  ARCH_TYPE="aarch64" ;;
        armv7l|armhf)   ARCH_TYPE="armhf" ;;
        x86_64)         ARCH_TYPE="x86_64" ;;
        i686|i386)      ARCH_TYPE="i686" ;;
        *)              ARCH_TYPE="$ARCH" ;;
    esac
    
    log "OK" "CPU: $CPU_CORES cores | Arquitetura: $ARCH_TYPE"
}

# -----------------------------------------------------------------------------
# VERIFICAR SE O BINÃRIO Ã‰ VÃLIDO
# -----------------------------------------------------------------------------
check_binary() {
    local binary="$1"
    
    # Verificar se o arquivo existe
    if [ ! -f "$binary" ]; then
        return 1
    fi
    
    # Verificar se Ã© executÃ¡vel
    if [ ! -x "$binary" ]; then
        return 1
    fi
    
    # Verificar se nÃ£o Ã© um script de texto
    if file "$binary" 2>/dev/null | grep -q "text executable"; then
        return 1
    fi
    
    # Verificar se Ã© um binÃ¡rio vÃ¡lido (ELF)
    if file "$binary" 2>/dev/null | grep -q "ELF"; then
        # Teste rÃ¡pido de execuÃ§Ã£o
        "$binary" --version >/dev/null 2>&1
        if [ $? -eq 0 ] || [ $? -eq 1 ]; then  # 1 tambÃ©m Ã© aceitÃ¡vel (--version pode retornar 1)
            return 0
        fi
    fi
    
    return 1
}

# -----------------------------------------------------------------------------
# COMPILAR MINERADOR DO ZERO (MÃ‰TODO MAIS CONFIÃVEL)
# -----------------------------------------------------------------------------
compile_miner() {
    log "INFO" "Compilando minerador do cÃ³digo fonte (mÃ©todo mais confiÃ¡vel)..."
    
    cd "$MINER_HOME/temp"
    
    # Instalar dependÃªncias de compilaÃ§Ã£o
    log "INFO" "Instalando dependÃªncias de compilaÃ§Ã£o..."
    pkg update -y >/dev/null 2>&1
    pkg install -y clang make git automake autoconf libtool openssl curl binutils >/dev/null 2>&1
    
    # Clonar repositÃ³rio
    log "INFO" "Baixando cÃ³digo fonte..."
    if [ -d "cpuminer" ]; then
        rm -rf cpuminer
    fi
    
    if ! git clone --depth=1 https://github.com/pooler/cpuminer.git 2>/dev/null; then
        log "ERROR" "Falha ao clonar repositÃ³rio"
        return 1
    fi
    
    cd cpuminer
    
    # Compilar
    log "INFO" "Compilando (pode levar alguns minutos)..."
    
    ./autogen.sh >/dev/null 2>&1
    
    # Configurar para Termux
    if [ "$ARCH_TYPE" = "aarch64" ] || [ "$ARCH_TYPE" = "armhf" ]; then
        ./configure CFLAGS="-O2 -march=armv8-a" --without-crypto >/dev/null 2>&1
    else
        ./configure CFLAGS="-O2" >/dev/null 2>&1
    fi
    
    # Compilar com todos os cores
    make -j$CPU_CORES >/dev/null 2>&1
    
    if [ -f "minerd" ]; then
        cp minerd "$MINER_HOME/bin/cpuminer"
        chmod +x "$MINER_HOME/bin/cpuminer"
        
        # Verificar binÃ¡rio compilado
        if check_binary "$MINER_HOME/bin/cpuminer"; then
            log "OK" "CompilaÃ§Ã£o concluÃ­da com sucesso!"
            return 0
        fi
    fi
    
    log "ERROR" "Falha na compilaÃ§Ã£o"
    return 1
}

# -----------------------------------------------------------------------------
# MÃ‰TODO 2: BINÃRIO ESTÃTICO (SE COMPILAÃ‡ÃƒO FALHAR)
# -----------------------------------------------------------------------------
download_static_binary() {
    log "INFO" "Tentando baixar binÃ¡rio estÃ¡tico..."
    
    cd "$MINER_HOME/temp"
    
    # URLs de binÃ¡rios estÃ¡ticos (mais confiÃ¡veis)
    case "$ARCH_TYPE" in
        aarch64)
            URL="https://github.com/btclinux/cpuminer-static/releases/download/v1.0/cpuminer-aarch64"
            ;;
        armhf)
            URL="https://github.com/btclinux/cpuminer-static/releases/download/v1.0/cpuminer-armv7"
            ;;
        x86_64)
            URL="https://github.com/btclinux/cpuminer-static/releases/download/v1.0/cpuminer-x86-64"
            ;;
        *)
            log "WARN" "Arquitetura nÃ£o suportada para binÃ¡rio estÃ¡tico"
            return 1
            ;;
    esac
    
    # Baixar binÃ¡rio
    if curl -L -s --connect-timeout 30 "$URL" -o cpuminer; then
        chmod +x cpuminer
        
        # Verificar se Ã© binÃ¡rio vÃ¡lido
        if check_binary cpuminer; then
            cp cpuminer "$MINER_HOME/bin/cpuminer"
            log "OK" "BinÃ¡rio estÃ¡tico baixado com sucesso!"
            return 0
        fi
    fi
    
    log "WARN" "BinÃ¡rio estÃ¡tico invÃ¡lido"
    return 1
}

# -----------------------------------------------------------------------------
# MÃ‰TODO 3: CPUMINER-OPT (ÃšLTIMA TENTATIVA)
# -----------------------------------------------------------------------------
download_cpuminer_opt() {
    log "INFO" "Tentando cpuminer-opt..."
    
    cd "$MINER_HOME/temp"
    
    case "$ARCH_TYPE" in
        aarch64)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-aarch64.tar.gz"
            ;;
        armhf)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-armhf.tar.gz"
            ;;
        x86_64)
            URL="https://github.com/rplant8/cpuminer-opt-rplant/releases/download/5.0.29/cpuminer-opt-linux-x86_64.tar.gz"
            ;;
        *)
            return 1
            ;;
    esac
    
    if curl -L -s --connect-timeout 30 "$URL" -o cpuminer.tar.gz; then
        tar -xzf cpuminer.tar.gz 2>/dev/null
        BIN_FILE=$(find . -name "cpuminer-*" -type f | head -1)
        
        if [ -n "$BIN_FILE" ] && [ -f "$BIN_FILE" ]; then
            chmod +x "$BIN_FILE"
            if check_binary "$BIN_FILE"; then
                cp "$BIN_FILE" "$MINER_HOME/bin/cpuminer"
                log "OK" "cpuminer-opt instalado com sucesso!"
                return 0
            fi
        fi
    fi
    
    return 1
}

# -----------------------------------------------------------------------------
# INSTALAR MINERADOR (TENTA VÃRIOS MÃ‰TODOS)
# -----------------------------------------------------------------------------
install_miner() {
    clear
    echo -e "${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              INSTALAÃ‡ÃƒO DO MINERADOR                             â•‘"
    echo "â•‘         TENTANDO MÃšLTIPLOS MÃ‰TODOS ATÃ‰ FUNCIONAR                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # Criar diretÃ³rios
    mkdir -p "$MINER_HOME"/{bin,logs,temp}
    
    # Limpar instalaÃ§Ã£o anterior
    rm -f "$MINER_HOME/bin/cpuminer"
    rm -rf "$MINER_HOME/temp"/*
    
    # MÃ©todo 1: CompilaÃ§Ã£o (mais confiÃ¡vel)
    echo ""
    log "INFO" "MÃ‰TODO 1: Compilando do cÃ³digo fonte..."
    if compile_miner; then
        log "OK" "âœ“ Minerador compilado com sucesso!"
        return 0
    fi
    log "WARN" "âœ— CompilaÃ§Ã£o falhou"
    
    # MÃ©todo 2: BinÃ¡rio estÃ¡tico
    echo ""
    log "INFO" "MÃ‰TODO 2: Tentando binÃ¡rio estÃ¡tico..."
    if download_static_binary; then
        log "OK" "âœ“ BinÃ¡rio estÃ¡tico funcionou!"
        return 0
    fi
    log "WARN" "âœ— BinÃ¡rio estÃ¡tico falhou"
    
    # MÃ©todo 3: cpuminer-opt
    echo ""
    log "INFO" "MÃ‰TODO 3: Tentando cpuminer-opt..."
    if download_cpuminer_opt; then
        log "OK" "âœ“ cpuminer-opt funcionou!"
        return 0
    fi
    log "WARN" "âœ— cpuminer-opt falhou"
    
    # Todos falharam
    echo ""
    log "ERROR" "âŒ TODOS OS MÃ‰TODOS DE INSTALAÃ‡ÃƒO FALHARAM!"
    log "ERROR" "Seu dispositivo pode nÃ£o ser compatÃ­vel com SHA256 mining"
    return 1
}

# -----------------------------------------------------------------------------
# POOLS
# -----------------------------------------------------------------------------
POOLS=(
    "stratum+tcp://btc.viabtc.com:3333|ViaBTC"
    "stratum+tcp://btc.f2pool.com:3333|F2Pool"
    "stratum+tcp://pool.antpool.com:3333|AntPool"
    "stratum+tcp://pool.btc.com:3333|BTC.com"
)

# -----------------------------------------------------------------------------
# TESTAR POOL
# -----------------------------------------------------------------------------
test_pool() {
    local url="$1"
    local name="$2"
    local host=$(echo "$url" | sed -e 's|^stratum+tcp://||' -e 's|:[0-9]*$||')
    local port=$(echo "$url" | grep -o '[0-9]*$')
    
    echo -n "  Testando $name... "
    (echo > "/dev/tcp/$host/$port") 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“ OK${NC}"
        return 0
    else
        echo -e "${RED}âœ— FALHOU${NC}"
        return 1
    fi
}

# -----------------------------------------------------------------------------
# INICIAR MINERAÃ‡ÃƒO
# -----------------------------------------------------------------------------
start_mining() {
    clear
    echo -e "${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    INICIANDO MINERAÃ‡ÃƒO                           â•‘"
    echo "â•‘               LOGS EM TEMPO REAL - CTRL+C PARA PARAR             â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # Verificar se minerador existe e Ã© vÃ¡lido
    if [ ! -f "$MINER_HOME/bin/cpuminer" ]; then
        log "WARN" "Minerador nÃ£o encontrado. Instalando..."
        install_miner || {
            log "ERROR" "Falha na instalaÃ§Ã£o do minerador"
            echo ""
            echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
            read -r
            return 1
        }
    fi
    
    # Verificar se o binÃ¡rio Ã© vÃ¡lido
    if ! check_binary "$MINER_HOME/bin/cpuminer"; then
        log "ERROR" "BinÃ¡rio do minerador estÃ¡ corrompido!"
        log "INFO" "Reinstalando..."
        rm -f "$MINER_HOME/bin/cpuminer"
        install_miner || {
            log "ERROR" "Falha na reinstalaÃ§Ã£o"
            echo ""
            echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
            read -r
            return 1
        }
    fi
    
    # Testar pools
    log "INFO" "Testando pools disponÃ­veis..."
    
    local pool_escolhida=""
    local pool_nome=""
    
    for pool in "${POOLS[@]}"; do
        IFS='|' read -r url name <<< "$pool"
        if test_pool "$url" "$name"; then
            pool_escolhida="$url"
            pool_nome="$name"
            break
        fi
    done
    
    if [ -z "$pool_escolhida" ]; then
        log "WARN" "Nenhuma pool respondeu. Usando ViaBTC como fallback"
        pool_escolhida="stratum+tcp://btc.viabtc.com:3333"
        pool_nome="ViaBTC (fallback)"
    fi
    
    log "OK" "Conectando Ã  pool: $pool_nome"
    log "INFO" "EndereÃ§o BTC: $BTC_ADDRESS"
    log "INFO" "Threads: $CPU_CORES"
    
    echo ""
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${WHITE}                    MINERAÃ‡ÃƒO ATIVA - LOGS ABAIXO${NC}"
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Executar minerador com caminho completo
    "$MINER_HOME/bin/cpuminer" \
        -o "$pool_escolhida" \
        -u "$BTC_ADDRESS" \
        -p "x" \
        -t "$CPU_CORES" \
        --algo=sha256d \
        --retry-pause=10 \
        2>&1 | tee "$MINER_HOME/logs/miner.log"
    
    local exit_code=$?
    
    echo ""
    if [ $exit_code -eq 0 ]; then
        log "INFO" "MineraÃ§Ã£o encerrada normalmente"
    else
        log "WARN" "MineraÃ§Ã£o encerrada com cÃ³digo $exit_code"
    fi
    
    echo ""
    echo -e "${YELLOW}Pressione ENTER para voltar ao menu${NC}"
    read -r
}

# -----------------------------------------------------------------------------
# VER LOGS
# -----------------------------------------------------------------------------
view_logs() {
    clear
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    VISUALIZADOR DE LOGS                          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    if [ -f "$MINER_HOME/logs/miner.log" ]; then
        echo -e "${WHITE}Ãšltimas 50 linhas do log:${NC}"
        echo ""
        tail -n 50 "$MINER_HOME/logs/miner.log"
    else
        echo -e "${RED}Nenhum log encontrado.${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
    read -r
}

# -----------------------------------------------------------------------------
# MENU PRINCIPAL
# -----------------------------------------------------------------------------
main_menu() {
    while true; do
        show_banner
        
        # Status do minerador
        if [ -f "$MINER_HOME/bin/cpuminer" ] && check_binary "$MINER_HOME/bin/cpuminer" >/dev/null 2>&1; then
            MINER_STATUS="${GREEN}âœ… FUNCIONAL${NC}"
        else
            MINER_STATUS="${RED}âŒ NÃƒO INSTALADO${NC}"
        fi
        
        # InformaÃ§Ãµes
        echo -e "${CYAN}InformaÃ§Ãµes do Sistema:${NC}"
        echo -e "  CPU: $CPU_CORES cores | Arquitetura: $ARCH_TYPE"
        echo -e "  Minerador: $MINER_STATUS"
        echo -e "  BTC: ${BTC_ADDRESS:0:20}..."
        echo ""
        
        # Menu
        echo -e "${GREEN}Menu Principal:${NC}"
        echo -e "  ${YELLOW}[1]${NC} ğŸš€ INICIAR MINERAÃ‡ÃƒO"
        echo -e "  ${YELLOW}[2]${NC} ğŸ“¦ INSTALAR/REINSTALAR MINERADOR"
        echo -e "  ${YELLOW}[3]${NC} ğŸ“‹ VER LOGS"
        echo -e "  ${YELLOW}[4]${NC} ğŸŒ TESTAR POOLS"
        echo -e "  ${YELLOW}[0]${NC} ğŸšª SAIR"
        echo ""
        echo -n -e "${GREEN}Escolha: ${NC}"
        read -r opt
        
        case $opt in
            1) start_mining ;;
            2) install_miner ;;
            3) view_logs ;;
            4)
                clear
                echo -e "${BLUE}Testando pools...${NC}"
                for pool in "${POOLS[@]}"; do
                    IFS='|' read -r url name <<< "$pool"
                    test_pool "$url" "$name"
                done
                echo ""
                echo -e "${YELLOW}Pressione ENTER para voltar${NC}"
                read -r
                ;;
            0)
                clear
                log "INFO" "Encerrando..."
                exit 0
                ;;
            *) log "WARN" "OpÃ§Ã£o invÃ¡lida"; sleep 1 ;;
        esac
    done
}

# -----------------------------------------------------------------------------
# LIMPEZA
# -----------------------------------------------------------------------------
cleanup() {
    echo ""
    log "INFO" "Encerrando processos..."
    pkill -f cpuminer 2>/dev/null
    exit 0
}

# -----------------------------------------------------------------------------
# MAIN
# -----------------------------------------------------------------------------
trap cleanup SIGINT SIGTERM

# Verificar Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}ERRO: Execute no Termux${NC}"
    exit 1
fi

# Criar diretÃ³rios
mkdir -p "$MINER_HOME"/{bin,logs,temp}

# Detectar hardware
detect_hardware

# Iniciar menu
main_menu
