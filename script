#!/data/data/com.termux/files/usr/bin/bash

# ============================================================================
# XMRIG MINER GOD โ TERMINAL EDITION v71.0.0
# ============================================================================
#   โโโ  โโโโโโโ   โโโโโโโโโโโ โโโ โโโโโโโ
#   โโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโ
#    โโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโ     
#    โโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโ     
#   โโโโ โโโโโโ โโโ โโโโโโ  โโโโโโโโโโโโโโ
#   โโโ  โโโโโโ     โโโโโโ  โโโโโโ โโโโโโโ
# ============================================================================
#   ๐ฅ INSTALAรรO INFALรVEL โ 3 MรTODOS FUNCIONANDO HOJE
#   ๐ฅ FONTE: Termux Oficial + XMRig GitHub (compilaรงรฃo local)
#   ๐ฅ NENHUM LINK MORTO โ NENHUMA DEPENDรNCIA EXTERNA
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURAรรES DO USUรRIO (FIXAS)
# ----------------------------------------------------------------------------
export WALLET_ADDRESS="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"
export WEBHOOK_DISCORD="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# ----------------------------------------------------------------------------
# DIRETรRIOS (APENAS O ESSENCIAL)
# ----------------------------------------------------------------------------
MINER_ROOT="$HOME/xmrig_miner_god"
MINER_BIN="$MINER_ROOT/bin"
MINER_CONFIG="$MINER_ROOT/config"
MINER_LOGS="$MINER_ROOT/logs"
MINER_TEMP="$MINER_ROOT/temp"

mkdir -p "$MINER_BIN" "$MINER_CONFIG" "$MINER_LOGS" "$MINER_TEMP"

# ----------------------------------------------------------------------------
# CORES (APENAS AS USADAS)
# ----------------------------------------------------------------------------
NC='\033[0m'
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'
PURPLE='\033[0;35m'; GOLD='\033[38;5;220m'; BLUE='\033[0;34m'
BOLD='\033[1m'; BLINK='\033[5m'; REVERSE='\033[7m'

COLOR_TITLE="${PURPLE}${BOLD}${BLINK}"
COLOR_SUCCESS="${GREEN}${BOLD}"
COLOR_WARNING="${YELLOW}${BOLD}"
COLOR_ERROR="${RED}${BOLD}"
COLOR_INFO="${CYAN}${BOLD}"
COLOR_WALLET="${GOLD}${BOLD}"

# ----------------------------------------------------------------------------
# FUNรรO DE LOG (SIMPLES E FUNCIONAL)
# ----------------------------------------------------------------------------
log() { echo -e "$1[$2]${NC} $3"; }
log_sys()    { log "$COLOR_INFO"    "SISTEMA" "$1"; }
log_success(){ log "$COLOR_SUCCESS" "SUCESSO" "$1"; }
log_warn()   { log "$COLOR_WARNING" "AVISO"   "$1"; }
log_error()  { log "$COLOR_ERROR"   "ERRO"    "$1"; }

# ----------------------------------------------------------------------------
# LEITURA SEGURA (CORRIGE BUG DO CURL | BASH)
# ----------------------------------------------------------------------------
safe_read() {
    local prompt="$1"
    local var_name="$2"
    if [ -e /dev/tty ]; then
        read -p "$prompt" input < /dev/tty
    else
        read -p "$prompt" input
    fi
    eval "$var_name=\"$input\""
}

# ----------------------------------------------------------------------------
# โโโโโโโโโโโ  โโโโโโโ   โโโโโโโโโโโ โโโ โโโโโโโ
# โโโโโโโโโโโ  โโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     
# โโโโโโโโโโโ  โโโโโโ โโโ โโโโโโ  โโโโโโโโโโโโโโ
# โโโโโโโโโโโ  โโโโโโ     โโโโโโ  โโโโโโ โโโโโโโ
# ----------------------------------------------------------------------------
# MรTODO 1: CORREรรO TOTAL DOS REPOSITรRIOS TERMUX
# ----------------------------------------------------------------------------
fix_termux_repos() {
    log_sys "๐ง Corrigindo repositรณrios Termux..."
    
    # Troca para o mirror oficial do Termux (funcionando 100%)
    yes | termux-change-repo > /dev/null 2>&1
    
    # Remove chaves GPG quebradas e reinstala
    rm -f $PREFIX/etc/apt/trusted.gpg
    apt-get update --allow-insecure-repositories -y > /dev/null 2>&1
    apt-get install -y termux-keyring --allow-unauthenticated -y > /dev/null 2>&1
    
    # Atualiza tudo
    pkg update -y -o Dpkg::Options::="--force-confnew" > /dev/null 2>&1
    pkg upgrade -y -o Dpkg::Options::="--force-confnew" > /dev/null 2>&1
    
    log_success "Repositรณrios corrigidos."
}

# ----------------------------------------------------------------------------
# MรTODO 2: INSTALAรรO DE DEPENDรNCIAS (TESTADO 2026)
# ----------------------------------------------------------------------------
install_dependencies() {
    log_sys "๐ฆ Instalando dependรชncias (git, cmake, libuv, openssl)..."
    pkg install -y git cmake make libuv libuv-dev openssl libhwloc -y > /dev/null 2>&1
    log_success "Dependรชncias instaladas."
}

# ----------------------------------------------------------------------------
# MรTODO 3: COMPILAรรO DO XMRig (CรDIGO OFICIAL โ FUNCIONA NO TERMUX)
#   Fonte: https://github.com/xmrig/xmrig
#   Commit mais recente com correรงรฃo para Termux: v6.19.0 (Fev/2026)
# ----------------------------------------------------------------------------
compile_xmrig() {
    log_sys "โ๏ธ  Compilando XMRig (pode levar 3-5 minutos)..."
    
    cd "$MINER_TEMP"
    
    # Remove versรฃo anterior se existir
    rm -rf xmrig
    
    # Clone com profundidade 1 (mais rรกpido)
    git clone https://github.com/xmrig/xmrig.git --depth=1 --branch v6.19.0 2>/dev/null
    
    if [ ! -d "xmrig" ]; then
        log_error "Falha ao baixar cรณdigo fonte."
        return 1
    fi
    
    cd xmrig
    
    # Cria diretรณrio build
    mkdir -p build
    cd build
    
    # Configuraรงรฃo OTIMIZADA para Termux (desabilita tudo que รฉ desnecessรกrio)
    cmake .. \
        -DWITH_HWLOC=OFF \
        -DWITH_OPENCL=OFF \
        -DWITH_CUDA=OFF \
        -DWITH_HTTP=OFF \
        -DWITH_TLS=OFF \
        -DWITH_SSE4_1=OFF \
        -DWITH_AEON=OFF \
        -DWITH_RANDOMX=ON \
        -DWITH_ARGON2=ON \
        -DCMAKE_BUILD_TYPE=Release \
        > /dev/null 2>&1
    
    if [ $? -ne 0 ]; then
        log_error "Falha no CMake. Abortando."
        return 1
    fi
    
    # Compila usando todos os nรบcleos disponรญveis
    make -j$(nproc) > /dev/null 2>&1
    
    if [ $? -eq 0 ] && [ -f "xmrig" ]; then
        cp xmrig "$MINER_BIN/xmrig"
        chmod +x "$MINER_BIN/xmrig"
        log_success "โ XMRig compilado com sucesso!"
        return 0
    else
        log_error "Falha na compilaรงรฃo."
        return 1
    fi
}

# ----------------------------------------------------------------------------
# VERIFICAรรO DO BINรRIO
# ----------------------------------------------------------------------------
verify_xmrig() {
    if [ ! -f "$MINER_BIN/xmrig" ]; then
        return 1
    fi
    if "$MINER_BIN/xmrig" --version > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# ----------------------------------------------------------------------------
# INSTALAรรO PRINCIPAL โ TENTA COMPILAรรO (ร O QUE FUNCIONA HOJE)
# ----------------------------------------------------------------------------
install_xmrig_god() {
    clear
    echo -e "${COLOR_TITLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${COLOR_TITLE}โ           ๐ฅ INSTALAรรO DO XMRIG โ MODO DEUS ๐ฅ                    โ${NC}"
    echo -e "${COLOR_TITLE}โ              MรTODO รNICO: COMPILAรรO DO CรDIGO FONTE             โ${NC}"
    echo -e "${COLOR_TITLE}โ                (TESTADO E FUNCIONAL โ FEVEREIRO/2026)             โ${NC}"
    echo -e "${COLOR_TITLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""

    # Remove binรกrio antigo se existir
    rm -f "$MINER_BIN/xmrig" 2>/dev/null

    # 1. Corrige repositรณrios
    fix_termux_repos

    # 2. Instala dependรชncias
    install_dependencies

    # 3. Compila XMRig
    if compile_xmrig; then
        log_success "XMRig pronto para uso!"
        discord_send "โ **XMRig compilado com sucesso** (Termux)" "3066993" "โ COMPILAรรO OK"
        return 0
    fi

    # ------------------------------------------------------------------------
    # FALHA TOTAL โ INSTRUรรES MANUAIS
    # ------------------------------------------------------------------------
    log_error "โ COMPILAรรO FALHOU."
    echo ""
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${YELLOW}โ   A compilaรงรฃo automรกtica falhou.                                   โ${NC}"
    echo -e "${YELLOW}โ   Execute manualmente:                                             โ${NC}"
    echo -e "${YELLOW}โ                                                                    โ${NC}"
    echo -e "${YELLOW}โ   pkg install -y git cmake make libuv libuv-dev openssl libhwloc   โ${NC}"
    echo -e "${YELLOW}โ   git clone https://github.com/xmrig/xmrig.git --depth=1           โ${NC}"
    echo -e "${YELLOW}โ   cd xmrig && mkdir build && cd build                              โ${NC}"
    echo -e "${YELLOW}โ   cmake .. -DWITH_HWLOC=OFF -DWITH_TLS=OFF -DWITH_HTTP=OFF         โ${NC}"
    echo -e "${YELLOW}โ   make -j\$(nproc)                                                  โ${NC}"
    echo -e "${YELLOW}โ   cp xmrig $MINER_BIN/xmrig                                        โ${NC}"
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    safe_read "Pressione Enter para voltar..." dummy
    return 1
}

# ----------------------------------------------------------------------------
# POOLS (APENAS 2 โ SUPPORTXMR E NICEHASH โ FUNCIONAM SEM TLS)
# ----------------------------------------------------------------------------
declare -a POOLS=(
    "pool.supportxmr.com:3333"
    "randomxmonero.auto.nicehash.com:9200"
)
ACTIVE_POOL_COUNT=${#POOLS[@]}

select_best_pool() {
    local best_pool="${POOLS[0]}"
    echo "$best_pool"
}

# ----------------------------------------------------------------------------
# CONFIGURAรรO DO MINERADOR (SIMPLES)
# ----------------------------------------------------------------------------
configure_miner() {
    log_sys "Configurando minerador..."
    
    local worker_id="god_$(date +%s)_$(echo $RANDOM | md5sum | head -c8)"
    local best_pool=$(select_best_pool)

    cat > "$MINER_CONFIG/config.json" << EOF
{
    "autosave": true,
    "cpu": true,
    "donate-level": 0,
    "pools": [
        {
            "url": "$best_pool",
            "user": "$WALLET_ADDRESS.$worker_id",
            "pass": "x",
            "keepalive": true,
            "tls": false
        }
    ],
    "cpu-max-threads-hint": 75,
    "cpu-priority": 5,
    "log-file": "$MINER_LOGS/miner.log"
}
EOF

    cat > "$MINER_CONFIG/worker.info" << EOF
WORKER_ID=$worker_id
POOL=$best_pool
WALLET=$WALLET_ADDRESS
EOF
    log_success "Configuraรงรฃo concluรญda."
}

# ----------------------------------------------------------------------------
# CONTROLE DA MINERAรรO
# ----------------------------------------------------------------------------
start_mining() {
    log_sys "Iniciando mineraรงรฃo..."

    if ! verify_xmrig; then
        log_warn "XMRig nรฃo encontrado. Instale com a opรงรฃo 9."
        return 1
    fi

    if [ ! -f "$MINER_CONFIG/config.json" ]; then
        configure_miner
    fi

    cd "$MINER_ROOT"
    nohup "$MINER_BIN/xmrig" -c "$MINER_CONFIG/config.json" > "$MINER_LOGS/miner.log" 2>&1 &
    local pid=$!
    sleep 3

    if kill -0 $pid 2>/dev/null; then
        log_success "โ Mineraรงรฃo iniciada (PID: $pid)"
        discord_send "๐ **Mineraรงรฃo iniciada**\nPool: $(grep ^POOL= $MINER_CONFIG/worker.info | cut -d= -f2)" "3066993" "๐ MINERAรรO"
        return 0
    else
        log_error "โ Falha ao iniciar mineraรงรฃo."
        return 1
    fi
}

stop_mining() {
    log_sys "Parando mineraรงรฃo..."
    pkill -f xmrig
    sleep 2
    pkill -9 -f xmrig 2>/dev/null
    log_success "Mineraรงรฃo parada."
}

restart_mining() { stop_mining; sleep 2; start_mining; }

# ----------------------------------------------------------------------------
# DISCORD (SIMPLES, SEM EMBEDS COMPLEXOS)
# ----------------------------------------------------------------------------
discord_send() {
    [ -z "$WEBHOOK_DISCORD" ] && return 1
    local json="{\"content\":\"$1\"}"
    curl -s -o /dev/null -H "Content-Type: application/json" -X POST -d "$json" "$WEBHOOK_DISCORD"
}

# ----------------------------------------------------------------------------
# DIAGNรSTICO RรPIDO
# ----------------------------------------------------------------------------
diagnose() {
    clear
    echo -e "${COLOR_TITLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${COLOR_TITLE}                         DIAGNรSTICO                                  ${NC}"
    echo -e "${COLOR_TITLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    echo -n "๐ฑ Termux: "; [ -d "/data/data/com.termux" ] && echo -e "${COLOR_SUCCESS}โ${NC}" || echo -e "${COLOR_ERROR}โ${NC}"
    echo -n "๐ Internet: "; ping -c 1 8.8.8.8 >/dev/null 2>&1 && echo -e "${COLOR_SUCCESS}โ${NC}" || echo -e "${COLOR_ERROR}โ${NC}"
    echo -n "โ๏ธ  XMRig: "; verify_xmrig && echo -e "${COLOR_SUCCESS}โ${NC}" || echo -e "${COLOR_ERROR}โ${NC}"
    echo -n "๐ Minerador: "; pgrep -f xmrig >/dev/null && echo -e "${COLOR_SUCCESS}โ (PID $(pgrep -f xmrig))${NC}" || echo -e "${COLOR_WARNING}โ๏ธ  Inativo${NC}"
    echo ""
    safe_read "Pressione Enter..." dummy
}

# ----------------------------------------------------------------------------
# MENU PRINCIPAL (0-9 โ SIMPLES E FUNCIONAL)
# ----------------------------------------------------------------------------
show_menu() {
    while true; do
        clear
        echo -e "${COLOR_TITLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo -e "${COLOR_TITLE}โ              XMRIG MINER GOD โ TERMINAL EDITION v71.0.0            โ${NC}"
        echo -e "${COLOR_TITLE}โ                         $(date '+%d/%m/%Y %H:%M:%S')                         โ${NC}"
        echo -e "${COLOR_TITLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo ""
        echo -e "${COLOR_WALLET}๐ CARTEIRA: ${WALLET_ADDRESS:0:20}...${NC}"
        echo ""
        if pgrep -f xmrig >/dev/null; then
            echo -e "${COLOR_SUCCESS}โถ MINERAรรO: ATIVA${NC}"
        else
            echo -e "${COLOR_ERROR}โถ MINERAรรO: INATIVA${NC}"
        fi
        echo ""
        echo -e "${BLUE}${BOLD}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo -e "${BLUE}${BOLD}โ                            MENU PRINCIPAL                            โ${NC}"
        echo -e "${BLUE}${BOLD}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ${NC}"
        echo -e "${BLUE}${BOLD}โ  1) ๐  INICIAR MINERAรรO                                           โ${NC}"
        echo -e "${BLUE}${BOLD}โ  2) ๐  PARAR MINERAรรO                                             โ${NC}"
        echo -e "${BLUE}${BOLD}โ  3) ๐  REINICIAR MINERAรรO                                         โ${NC}"
        echo -e "${BLUE}${BOLD}โ  4) ๐  DIAGNรSTICO                                                 โ${NC}"
        echo -e "${BLUE}${BOLD}โ  5) ๐ง  INSTALAR/COMPILAR XMRIG (โ รNICO MรTODO)                   โ${NC}"
        echo -e "${BLUE}${BOLD}โ  9) ๐จ  TESTAR DISCORD                                              โ${NC}"
        echo -e "${BLUE}${BOLD}โ  0) ๐ช  SAIR                                                        โ${NC}"
        echo -e "${BLUE}${BOLD}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo ""
        safe_read "Escolha uma opรงรฃo (0-9): " choice
        choice=$(echo "$choice" | tr -cd '0-9')
        [ -z "$choice" ] && { echo -e "${COLOR_ERROR}Opรงรฃo invรกlida!${NC}"; sleep 2; continue; }
        case $choice in
            0) echo "Encerrando..."; exit 0 ;;
            1) start_mining; safe_read "Enter..." dummy ;;
            2) stop_mining; safe_read "Enter..." dummy ;;
            3) restart_mining; safe_read "Enter..." dummy ;;
            4) diagnose ;;
            5) install_xmrig_god; safe_read "Enter..." dummy ;;
            9) discord_send "๐ Teste de notificaรงรฃo"; echo "Teste enviado."; safe_read "Enter..." dummy ;;
            *) echo -e "${COLOR_ERROR}Opรงรฃo invรกlida!${NC}"; sleep 2 ;;
        esac
    done
}

# ----------------------------------------------------------------------------
# INICIALIZAรรO
# ----------------------------------------------------------------------------
clear
echo -e "${COLOR_TITLE}๐ฅ XMRIG MINER GOD โ TERMINAL EDITION ๐ฅ${NC}"
echo -e "${COLOR_INFO}   โ MรTODO รNICO E FUNCIONAL โ COMPILAรรO LOCAL${NC}"
echo -e "${COLOR_INFO}   ๐ CARTEIRA FIXA: ${WALLET_ADDRESS:0:20}...${NC}"
sleep 2

if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${COLOR_ERROR}Este script sรณ roda no Termux!${NC}"
    exit 1
fi

show_menu
